# 情シスリクエストSlackアプリ

Slackのスラッシュコマンド `/情シスリクエスト` を通じて、情報システム部へのリクエストフォームを表示し、進捗管理を行うアプリケーション。

## 概要

このアプリケーションは、Slack上で情報システム部へのリクエストを簡単に行い、その進捗を管理するためのツールです。

### 主な機能

1. **リクエストフォーム**: `/情シスリクエスト` コマンドでモーダルフォームを表示
2. **チャンネル投稿**: リクエスト内容をチャンネルに投稿
3. **進捗管理**: 確認済み → 対応開始 → 対応完了のフロー
4. **Notion連携**: リクエスト内容と進捗をNotionデータベースに記録（オプション）

## 機能フロー

```
1. `/情シスリクエスト` コマンド実行
   ↓
2. モーダルフォーム表示
   - リクエスト内容（概要）（必須）
   - リクエスト内容（詳細）（必須）
   - 優先度（必須）: すぐ / 2,3日以内 / 一週間以内 / そのうち
   ↓
3. 送信 → チャンネルに投稿 + Notionに記録（ステータス: 未確認）
   ↓
4. 「確認済み」ボタン（情シスチームのみ）
   → Notionステータス: 未着手
   ↓
5. 「対応開始」ボタン（情シスチームのみ）
   → Notionステータス: 対応中
   ↓
6. 「対応完了」ボタン（情シスチームのみ）
   → Notionステータス: 完了
```

## 技術スタック

- **ランタイム**: Deno (TypeScript)
- **ホスティング**: Supabase Edge Functions
- **プロジェクトID**: `mywajnlbkbhrnmgpmuuv`

## セットアップ

### 1. 環境変数の設定

`.env.example` をコピーして `.env.local` を作成し、以下の環境変数を設定してください：

```bash
# Slack共通設定（必須）
SLACK_BOT_TOKEN=xoxb-your-bot-token-here
SLACK_SIGNING_SECRET=your_signing_secret_here

# Slack共通設定（任意 - チャンネル制限）
SLACK_ALLOWED_CHANNEL_IDS=C01234567,C98765432

# 情シスチームメンバー設定（必須）
IT_REQUEST_TEAM_MEMBERS=U01234567,U98765432,U99999999

# Notion連携設定（任意）
NOTION_TOKEN=secret_your_notion_token_here
IT_REQUEST_NOTION_DATABASE_ID=your_database_id_here
```

### 2. ローカル開発

```bash
cd supabase
supabase functions serve it-request --env-file .env.local
```

### 3. デプロイ

```bash
# 手動デプロイ
supabase functions deploy it-request --project-ref mywajnlbkbhrnmgpmuuv

# 自動デプロイ（GitHub Actions）
git add .
git commit -m "Update it-request function"
git push origin main
# → slack-it-request/** の変更が検知され、自動デプロイされます
```

## 環境変数の詳細

### 必須環境変数

- **SLACK_BOT_TOKEN**: SlackアプリのBot User OAuth Token
- **SLACK_SIGNING_SECRET**: Slackアプリの署名シークレット
- **IT_REQUEST_TEAM_MEMBERS**: 情シスチームメンバーのユーザーID（カンマ区切り）

### 任意環境変数

- **SLACK_ALLOWED_CHANNEL_IDS**: コマンドを使用できるチャンネルID（カンマ区切り）。未設定の場合は全チャンネルで使用可能
- **NOTION_TOKEN**: Notion Integration Token（全アプリ共通）
- **IT_REQUEST_NOTION_DATABASE_ID**: NotionデータベースID

**注意**: `NOTION_TOKEN` と `IT_REQUEST_NOTION_DATABASE_ID` が両方設定されている場合のみ、Notion連携が有効になります。

## Notionデータベースのプロパティ

Notion連携を有効にする場合、以下のプロパティを持つデータベースを作成してください：

| プロパティ名 | 型 | 説明 |
|------------|-----|------|
| リクエスト内容 | Title | リクエストの概要（タイトル） |
| リクエスト者名 | Text | リクエストしたユーザーのSlack表示名 |
| リクエスト日 | Date | リクエスト日時（時間含む） |
| 優先度 | Select | 高 / 中 / 小 / 極小（※Slackでは「すぐ / 2,3日以内 / 一週間以内 / そのうち」と表示されますが、Notionには自動でマッピングされます） |
| ステータス | Status | 未確認 / 未着手 / 対応中 / 完了 |
| 確認者名 | Text | 確認したユーザーのSlack表示名 |
| 確認日 | Date | 確認日時（時間含む） |
| 対応開始者名 | Text | 対応開始したユーザーのSlack表示名 |
| 対応開始日 | Date | 対応開始日時（時間含む） |
| 対応完了者名 | Text | 対応完了したユーザーのSlack表示名 |
| 対応完了日 | Date | 対応完了日時（時間含む） |
| リクエストスレッドリンク | URL | SlackスレッドへのURL |

**注意**: リクエスト内容の詳細は、Notionページの本文（ページコンテンツ）に自動的に追加されます。プロパティとして作成する必要はありません。

## トラブルシューティング

### モーダルが表示されない

- `SLACK_BOT_TOKEN` が正しく設定されているか確認してください
- Slackアプリに必要な権限（`commands`, `chat:write`, `users:read`）が付与されているか確認してください

### ボタンが押せない

- `IT_REQUEST_TEAM_MEMBERS` に正しいユーザーIDが設定されているか確認してください
- ユーザーIDは `U` で始まる文字列です（例: `U01234567`）

### Notionに記録されない

- `NOTION_TOKEN` と `IT_REQUEST_NOTION_DATABASE_ID` が両方設定されているか確認してください
- Notion IntegrationがデータベースにアクセスできるようShare設定されているか確認してください
- データベースのプロパティ名と型が正しいか確認してください

## 関連ドキュメント

- [要件定義書](./requirements.md)
- [Supabaseデプロイ手順](./DEPLOY_SUPABASE.md)
- [CI/CDセットアップ](./CI_CD_SETUP.md)
