# 情シスリクエストSlackアプリ 要件定義書

## 1. 概要

Slackのスラッシュコマンド `/情シスリクエスト` を通じて、情報システム部へのリクエストフォームを表示し、入力内容をスレッドに返信して、進捗管理を行うアプリケーション。

## 2. 機能要件

### 2.1 スラッシュコマンド
- **コマンド名**: `/情シスリクエスト`
- **動作対象**: 特定のチャンネルのみ（設定可能）
- **実行権限**: チャンネルメンバー全員

### 2.2 モーダルフォーム表示
- スラッシュコマンド実行時にモーダルフォームを表示
- **フォーム項目**:
  - **リクエスト内容**（必須）: テキスト入力（複数行、大きいテキストボックス）
  - **優先度**（必須）: セレクトメニュー
    - すぐ
    - 2,3日以内
    - 一週間以内
    - そのうち

### 2.3 チャンネル投稿機能
- フォーム送信後、コマンドが実行されたチャンネルに申請内容を投稿
- 投稿内容:
  - リクエスト者のメンション（`@ユーザー名`形式）
  - リクエスト内容
  - 優先度
  - 申請日時（日本時間）
- 投稿先: スラッシュコマンドを実行したチャンネル

### 2.4 確認フロー
- リクエスト投稿後、自動的にスレッドに「確認済み」ボタンを投稿
- **確認ボタン**:
  - 情シスチームメンバーのみが押せる
  - それ以外の人が押した場合はスレッドに「権限を持つ人だけが確認ボタンを押してください。」と表示
  - ボタンは1回のみ押せる（確認済み後は押せない）
  - ボタンが押されると、誰が確認したかをスレッドに記録
  - 記録メッセージ: 「〇〇（押したユーザー）が確認しました。対応までお待ち下さい。」
  - 確認後、自動的に「対応開始」ボタンを表示

### 2.5 対応開始フロー
- 確認完了後、自動的にスレッドに「対応開始」ボタンを投稿
- **対応開始ボタン**:
  - 情シスチームメンバーのみが押せる
  - それ以外の人が押した場合はスレッドに「権限を持つ人だけが対応開始ボタンを押してください。」と表示
  - ボタンは1回のみ押せる
  - ボタンが押されると、スレッドに「対応開始しました。」と記録
  - 対応開始後、自動的に「対応完了」ボタンを表示

### 2.6 対応完了フロー
- 対応開始完了後、自動的にスレッドに「対応完了」ボタンを投稿
- **対応完了ボタン**:
  - 情シスチームメンバーのみが押せる
  - それ以外の人が押した場合はスレッドに「権限を持つ人だけが対応完了ボタンを押してください。」と表示
  - ボタンは1回のみ押せる
  - ボタンが押されると、スレッドに「対応が完了しました。」と記録

### 2.7 Notion連携機能
- リクエスト内容をNotionデータベースに自動記録
- **レコード作成タイミング**: フォーム送信後、チャンネル投稿と同時
- **レコード内容**:
  - リクエスト内容（Title型）: フォーム入力値
  - リクエスト者名（Text型）: Slackユーザー名
  - リクエスト日（Date型、時間含む）: リクエスト日時（日本時間）
  - 優先度（Select型）: Slackの選択値を以下のようにマッピング
    - すぐ → 高
    - 2,3日以内 → 中
    - 一週間以内 → 小
    - そのうち → 極小
  - ステータス（Status型）: 初期値「未確認」
  - 確認者名（Text型）: 初期値 空
  - 確認日（Date型、時間含む）: 初期値 null
  - 対応開始者名（Text型）: 初期値 空
  - 対応開始日（Date型、時間含む）: 初期値 null
  - 対応完了者名（Text型）: 初期値 空
  - 対応完了日（Date型、時間含む）: 初期値 null
  - リクエストスレッドリンク（URL型）: SlackスレッドURL
- **レコード更新**:
  - 確認時:
    - 確認者名（Text型）: 確認者のSlackユーザー名
    - 確認日（Date型、時間含む）: 確認日時（日本時間）
    - ステータス: 「未着手」
  - 対応開始時:
    - 対応開始者名（Text型）: 対応開始者のSlackユーザー名
    - 対応開始日（Date型、時間含む）: 対応開始日時（日本時間）
    - ステータス: 「対応中」
  - 対応完了時:
    - 対応完了者名（Text型）: 対応完了者のSlackユーザー名
    - 対応完了日（Date型、時間含む）: 対応完了日時（日本時間）
    - ステータス: 「完了」
- **エラーハンドリング**: Notion API呼び出し失敗時もSlack投稿は継続（ログに記録）

### 2.8 レスポンス
- コマンド実行後の即時フィードバック
  - 成功時: モーダルフォームの表示
  - 失敗時: エラーメッセージと対処方法
- エフェメラルメッセージ（実行者のみに表示）を使用

## 3. 非機能要件

### 3.1 パフォーマンス
- Slackコマンド応答: 3秒以内
- モーダル表示: 3秒以内
- スレッド投稿: 5秒以内

### 3.2 可用性
- 稼働率: 99%以上
- エラー時の自動リトライ機能

### 3.3 セキュリティ
- Slack署名検証の実装
- 環境変数による機密情報管理
- 許可チャンネル以外からの実行を拒否
- アクセスログの記録

### 3.4 保守性
- ログ出力（実行履歴、エラー情報）
- 設定ファイルによる環境別管理
- デプロイ手順書の整備

## 4. 技術要件

### 4.1 Slack App設定
- **必要な権限（Scopes）**:
  - `commands`: スラッシュコマンドの使用
  - `chat:write`: メッセージ送信（スレッド返信用）
  - `users:read`: ユーザー情報取得（Notion連携で使用）

- **Interactivity & Shortcuts**: 有効化必須
  - Request URLにアプリのエンドポイントを設定
  - モーダルフォームの送信を受け取るために必要

- **Slash Commands**: `/情シスリクエスト`

### 4.2 環境変数
```
# Slack共通設定（必須 - 全てのSlackアプリで共有）
SLACK_BOT_TOKEN=xoxb-...                    # Bot User OAuth Token（必須）
SLACK_SIGNING_SECRET=...                    # Slack署名シークレット（必須）

# Slack共通設定（任意 - 設定するとコマンドを使用できるチャンネルを制限）
SLACK_ALLOWED_CHANNEL_IDS=C01234567,C98765432

# 情シスチームメンバー設定（必須 - カンマ区切りで複数設定可）
IT_REQUEST_TEAM_MEMBERS=U01234567,U98765432,U99999999

# Notion連携設定（任意 - 両方設定した場合のみ有効）
NOTION_TOKEN=secret_...                     # Notion Integration Token（全アプリ共通）
IT_REQUEST_NOTION_DATABASE_ID=...           # NotionデータベースID（情シスリクエスト専用）
```

**注意**:
- `NOTION_TOKEN` と `IT_REQUEST_NOTION_DATABASE_ID` が両方設定されている場合のみ、Notion連携が有効になります。
- `NOTION_TOKEN` は購買申請アプリと共通です。

### 4.3 開発言語・フレームワーク
- 言語: TypeScript / Deno
- フレームワーク: Supabase Edge Functions
- ホスティング: Supabase

## 5. 制約事項

- Slackワークスペースの管理者権限が必要
- Slackアプリのインストールと設定が事前に必要
- 対象チャンネルはパブリックチャンネルに限定（プライベートチャンネルは要追加設定）
- Slackのモーダルフォーム仕様上、入力フィールドの型指定は限定的（テキスト入力とセレクトメニューのみ）

## 6. データ型の取り扱い

- **リクエスト内容**: テキスト型（文字列）、複数行対応
- **優先度**:
  - Slack表示: セレクトメニュー（すぐ / 2,3日以内 / 一週間以内 / そのうち）
  - Notion保存: Select型（高 / 中 / 小 / 極小）にマッピング

## 7. 今後の拡張予定

- リクエストのカテゴリ分類機能
- リクエスト履歴の検索機能
- 定期レポート機能（週次・月次）
- SLA管理機能（優先度に応じた対応期限設定）

## 8. 参考資料

- [Slack API Documentation](https://api.slack.com/)
- [Slash Commands | Slack](https://api.slack.com/interactivity/slash-commands)
- [Modals | Slack](https://api.slack.com/surfaces/modals)
- [Interactivity | Slack](https://api.slack.com/interactivity/handling)
