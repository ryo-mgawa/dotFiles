# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## リポジトリ構造

このリポジトリは情報システム部のモノレポジトリです。各Slackアプリは独立したプロダクトとしてルート直下に配置されています。

```
information-system-nexus/
├── slack-purchase-request/   # 購買申請アプリ
│   └── supabase/functions/purchase-request/
└── slack-help/               # ヘルプコマンドアプリ
    └── supabase/functions/help/
```

## 開発コマンド

### ローカル開発・テスト

各アプリのディレクトリに移動して実行：

```bash
# 購買申請アプリのローカル起動
cd slack-purchase-request/supabase
supabase functions serve purchase-request --env-file .env.local

# ヘルプアプリのローカル起動
cd slack-help/supabase
supabase functions serve help --env-file .env.local
```

### デプロイ

```bash
# 手動デプロイ（購買申請）
cd slack-purchase-request
supabase functions deploy purchase-request --project-ref mywajnlbkbhrnmgpmuuv

# 手動デプロイ（ヘルプ）
cd slack-help
supabase functions deploy help --project-ref mywajnlbkbhrnmgpmuuv

# 自動デプロイ（GitHub Actions）
git add .
git commit -m "Update function"
git push origin main
# → 変更されたプロダクトのみ自動デプロイ
```

## アーキテクチャ

### 技術スタック
- **ランタイム**: Deno (TypeScript)
- **ホスティング**: Supabase Edge Functions
- **プロジェクトID**: `mywajnlbkbhrnmgpmuuv`（全アプリ共通）

### 環境変数の命名規則
各プロダクトは独自のプレフィックスを使用して環境変数の競合を防ぎます：
- 購買申請: `PURCHASE_REQUEST_*`
- ヘルプ: `HELP_*`

### CI/CD
GitHub Actionsが `main` ブランチへのpushで自動デプロイを実行。各アプリは独立したワークフローを持ち、該当ディレクトリの変更時のみトリガーされます：
- `.github/workflows/deploy-purchase-request.yml` → `slack-purchase-request/**` の変更を検知
- `.github/workflows/deploy-help.yml` → `slack-help/**` の変更を検知

### Supabase設定ファイル (config.toml)
各アプリの `supabase/config.toml` は以下の形式を使用：

```toml
[functions.{function-name}]
verify_jwt = false
```

❌ 使用しないキー: `edge_functions`, `project_id`（デプロイエラーの原因）

## 購買申請アプリ (slack-purchase-request)

### 主要機能フロー
1. `/購買申請` コマンド → モーダルフォーム表示
2. フォーム送信 → チャンネル投稿 + Notion記録（オプション）
3. 第一次承認（名古屋/東京承認者） → スレッドに記録 + Notion更新
4. 最終承認 → スレッドに記録 + Notion更新
5. 購入完了（申請者のみ） → Notion更新

### 申請者IDの伝播設計
申請者IDはNotionに保存せず、Slackボタンの `value` フィールドを通じて伝播：
```
フォーム送信(payload.user.id)
  ↓ postApprovalRequest(applicantId)
第一承認ボタン value: {applicant_id}
  ↓ 抽出して次へ
第二承認ボタン value: {applicant_id}
  ↓ 抽出して次へ
購入完了ボタン value: {applicant_id}
  ↓ 申請者チェック
```

### Notion連携
- 環境変数: `PURCHASE_REQUEST_NOTION_TOKEN` と `PURCHASE_REQUEST_NOTION_DATABASE_ID` の両方が設定されている場合のみ有効
- レコード検索: `申請スレッドリンク` (URL型) でスレッドを特定
- プロパティ型:
  - `購入物品名`: Title型
  - `申請日`, `第一承認日`, `最終承認日`, `購入日`: Date型（ISO 8601形式）
  - `申請者名`, `第一承認者名`, `最終承認者名`, `購入者名`: Text型（Slack表示名を使用）
  - `ステータス`: Status型（未承認/一次承認済み/最終承認済み/購入完了）

### ユーザー名の取得
`getSlackUserName()` は `display_name` を優先（`real_name` より）し、先頭の `@` を除去します。

## ヘルプアプリ (slack-help)

### 機能
- `/help` コマンドでエフェメラルメッセージ（実行者のみ表示）を返す
- 利用可能なスラッシュコマンドの一覧と説明を表示
- Block Kitを使用した視覚的なレイアウト

### コマンド情報の更新方法
新しいコマンドを追加する場合は `supabase/functions/help/index.ts` の `createHelpMessage()` 関数内のブロック配列に追加します。

## 新規プロダクトの追加

1. ルート直下に新しいディレクトリを作成
2. 標準構造を作成:
   ```
   [product-name]/
   ├── README.md
   ├── requirement.md
   ├── DEPLOY_SUPABASE.md
   ├── .gitignore
   └── supabase/
       ├── config.toml
       ├── .env.example
       └── functions/
           └── [function-name]/
               └── index.ts
   ```
3. `.github/workflows/deploy-[product-name].yml` を作成
4. 環境変数に一意のプレフィックスを使用
5. ルートの `README.md` のプロダクト一覧を更新

## セキュリティ
- 全てのアプリでSlack署名検証を実装（`verifySlackSignature()` 関数）
- タイムスタンプチェックでリプレイアタック防止（5分以内）
- 環境変数はSupabase Secretsで管理（`.env.local` はgitignore済み）
