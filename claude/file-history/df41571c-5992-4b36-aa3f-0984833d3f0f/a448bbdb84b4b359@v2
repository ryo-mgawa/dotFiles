import { UserContextTypes } from '@app/requestContext';
import { Test, TestingModule } from '@nestjs/testing';
import { AddShipmentEventsUseCase } from '../../../../application/useCase/addShipmentEventsUseCase';
import { AddShipmentEventsController } from '../addShipmentEventsController';
import { AddShipmentEventsInput } from '../../dto/addShipmentEvents/input';

describe('AddShipmentEventsController', () => {
  let controller: AddShipmentEventsController;
  let useCase: AddShipmentEventsUseCase;

  const mockUser: UserContextTypes = {
    userId: 'test-user-id',
    organizationId: 'test-org-id',
    role: 'PAAS',
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AddShipmentEventsController],
      providers: [
        {
          provide: AddShipmentEventsUseCase,
          useValue: {
            execute: jest.fn(),
          },
        },
      ],
    }).compile();

    controller = module.get<AddShipmentEventsController>(AddShipmentEventsController);
    useCase = module.get<AddShipmentEventsUseCase>(AddShipmentEventsUseCase);
  });

  it('コントローラーが正しく定義される', () => {
    expect(controller).toBeDefined();
  });

  it('コンストラクタが正しくuseCaseを注入する', () => {
    const testUseCase = {
      execute: jest.fn(),
    } as any;
    const testController = new AddShipmentEventsController(testUseCase);

    expect(testController).toBeDefined();
    expect(testController['addShipmentEventsUseCase']).toBe(testUseCase);
  });

  describe('addShipmentEvents', () => {
    it('useCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentEventsInput = {
        events: [
          {
            shipmentId: 'shipment-001',
            type: 'STORE',
            originalSpotId: 'spot-001',
            executedAt: '2024-01-01T00:00:00.000Z',
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipmentEvents(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          events: [
            {
              shipmentId: 'shipment-001',
              type: 'STORE',
              originalSpotId: 'spot-001',
              geocode: undefined,
              executedAt: new Date('2024-01-01T00:00:00.000Z'),
            },
          ],
        },
        'test-user-id',
      );
    });

    it('geocodeを含むイベントでuseCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentEventsInput = {
        events: [
          {
            shipmentId: 'shipment-001',
            type: 'TRANSFER',
            originalSpotId: 'spot-001',
            geocode: {
              latitude: 35.6812,
              longitude: 139.7671,
            },
            executedAt: '2024-01-01T12:00:00.000Z',
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipmentEvents(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          events: [
            {
              shipmentId: 'shipment-001',
              type: 'TRANSFER',
              originalSpotId: 'spot-001',
              geocode: {
                latitude: 35.6812,
                longitude: 139.7671,
              },
              executedAt: new Date('2024-01-01T12:00:00.000Z'),
            },
          ],
        },
        'test-user-id',
      );
    });

    it('複数のイベントでuseCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentEventsInput = {
        events: [
          {
            shipmentId: 'shipment-001',
            type: 'STORE',
            originalSpotId: 'spot-001',
            executedAt: '2024-01-01T00:00:00.000Z',
          },
          {
            shipmentId: 'shipment-002',
            type: 'DELIVER',
            originalSpotId: 'spot-002',
            geocode: {
              latitude: 35.6812,
              longitude: 139.7671,
            },
            executedAt: '2024-01-02T00:00:00.000Z',
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipmentEvents(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          events: [
            {
              shipmentId: 'shipment-001',
              type: 'STORE',
              originalSpotId: 'spot-001',
              geocode: undefined,
              executedAt: new Date('2024-01-01T00:00:00.000Z'),
            },
            {
              shipmentId: 'shipment-002',
              type: 'DELIVER',
              originalSpotId: 'spot-002',
              geocode: {
                latitude: 35.6812,
                longitude: 139.7671,
              },
              executedAt: new Date('2024-01-02T00:00:00.000Z'),
            },
          ],
        },
        'test-user-id',
      );
    });

    it('useCase.executeが正常に完了する', async () => {
      const input: AddShipmentEventsInput = {
        events: [
          {
            shipmentId: 'shipment-001',
            type: 'STORE',
            originalSpotId: 'spot-001',
            executedAt: '2024-01-01T00:00:00.000Z',
          },
        ],
      };
      const mockResponse = {} as Response;

      jest.spyOn(useCase, 'execute').mockResolvedValueOnce();

      await expect(
        controller.addShipmentEvents(mockUser, input, mockResponse),
      ).resolves.not.toThrow();
    });
  });
});
