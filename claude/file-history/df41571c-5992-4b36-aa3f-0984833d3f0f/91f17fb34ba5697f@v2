import { AuthModule, RolesGuard } from '@app/auth';
import { RDBModule, ShipmentDAO } from '@app/rdb';
import { RequestContextModule } from '@app/requestContext';
import { ValidationPipeModule } from '@app/validationPipe';
import { Module, Scope } from '@nestjs/common';
import { APP_GUARD, REQUEST } from '@nestjs/core';
import { Request } from 'express';
import { v7 as uuidv7 } from 'uuid';
import { ShipmentCreator } from '../application/service/creator/shipmentCreator';
import { ShipmentEventCreator } from '../application/service/creator/shipmentEventCreator';
import { ShipmentRepository } from '../data/repository/shipmentRepository';

@Module({
  imports: [
    AuthModule,
    RDBModule,
    RequestContextModule.forRoot({}),
    ValidationPipeModule,
  ],
  providers: [
    RolesGuard,
    ShipmentDAO,
    ShipmentCreator,
    ShipmentEventCreator,
    ShipmentRepository,
    {
      provide: APP_GUARD,
      useExisting: RolesGuard,
    },
    {
      provide: 'RESPONSE',
      scope: Scope.REQUEST,
      useFactory: (request: Request) => request.res,
      inject: [REQUEST],
    },
    {
      provide: 'uuid',
      useValue: uuidv7,
    },
  ],
  exports: [
    'RESPONSE',
    ValidationPipeModule,
    ShipmentDAO,
    ShipmentCreator,
    ShipmentEventCreator,
    ShipmentRepository,
  ],
})
export class BaseShipmentModule {}
