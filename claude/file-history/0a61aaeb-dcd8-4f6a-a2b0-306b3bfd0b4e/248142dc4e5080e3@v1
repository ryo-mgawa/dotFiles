import { SHIPMENT_EVENT_TYPE } from '@app/rdb/db/models/shipmentEvent/type';
import { SHIPMENT_STATUS, Status } from '@app/rdb/db/models/shipmentStatus/status';
import { Inject, Injectable } from '@nestjs/common';
import { ShipmentRepository } from '../../../data/repository/shipmentRepository';
import { AddShipmentEventsPresenterInterface } from '../../../interface/presenter/addShipmentEventsPresenterInterface';
import { ShipmentEventCreator } from '../../service/creator/shipmentEventCreator';
import { Input } from './types';

@Injectable()
export class AddShipmentEventsUseCase {
  constructor(
    @Inject('AddShipmentEventsPresenter')
    private readonly presenter: AddShipmentEventsPresenterInterface,
    private readonly shipmentEventCreator: ShipmentEventCreator,
    private readonly shipmentRepository: ShipmentRepository,
  ) { }

  public async execute(input: Input, userId: string): Promise<void> {
    const eventsWithId = this.shipmentEventCreator.execute(input.events, userId);

    const statuses = input.events.map((event) => ({
      shipmentId: event.shipmentId,
      status: this.mapEventTypeToStatus(event.type),
      executedAt: event.executedAt,
    }));

    await this.shipmentRepository.saveEvents(eventsWithId, statuses);

    this.presenter.output();
  }

  private mapEventTypeToStatus(type: string): Status {
    switch (type) {
      case SHIPMENT_EVENT_TYPE.STORE:
        return SHIPMENT_STATUS.IN_STORAGE;
      case SHIPMENT_EVENT_TYPE.TRANSFER:
        return SHIPMENT_STATUS.IN_TRANSIT;
      case SHIPMENT_EVENT_TYPE.DELIVER:
      case SHIPMENT_EVENT_TYPE.COMPLETE:
        return SHIPMENT_STATUS.COMPLETED;
      case SHIPMENT_EVENT_TYPE.CANCEL:
        return SHIPMENT_STATUS.CANCELED;
      default:
        throw new Error(`Unknown event type: ${type}`);
    }
  }
}
