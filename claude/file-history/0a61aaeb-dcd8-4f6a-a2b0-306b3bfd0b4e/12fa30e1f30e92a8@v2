import { SHIPMENT_EVENT_TYPE } from '@app/rdb/db/models/shipmentEvent/type';
import { v7 } from 'uuid';
import { ShipmentEventCreator, ShipmentEventInput } from '../shipmentEventCreator';

describe('ShipmentEventCreator', () => {
  let creator: ShipmentEventCreator;
  const mockUuid = jest.fn(() => 'mock-uuid');
  const updateBy = 'user-1';

  beforeEach(() => {
    creator = new ShipmentEventCreator(mockUuid as unknown as typeof v7);
    mockUuid.mockClear();
  });

  describe('execute', () => {
    describe('正常系', () => {
      it('空のevents配列の場合、空の配列を返す', () => {
        const events: ShipmentEventInput[] = [];

        const result = creator.execute(events, updateBy);

        expect(result).toEqual([]);
      });

      it('正しいShipmentEventInputの場合、SaveShipmentEventを返す', () => {
        const executedAt = new Date('2025-11-10T10:00:00Z');
        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            geocode: { x: 139.7671, y: 35.6812 },
            executedAt,
          },
        ];

        const result = creator.execute(events, updateBy);

        expect(result).toHaveLength(1);
        expect(result[0]).toMatchObject({
          id: 'mock-uuid',
          shipmentId: 'shipment-1',
          type: SHIPMENT_EVENT_TYPE.STORE,
          originalSpotId: 'spot-1',
          geocode: { x: 139.7671, y: 35.6812 },
          updateBy,
          executedAt,
        });
      });

      it('geocodeがない場合、nullとして保存される', () => {
        const executedAt = new Date('2025-11-10T10:00:00Z');
        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.IN_TRANSIT,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ];

        const result = creator.execute(events, updateBy);

        expect(result[0].geocode).toBeNull();
      });

      it('geocodeがundefinedの場合、nullとして保存される', () => {
        const executedAt = new Date('2025-11-10T10:00:00Z');
        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.IN_TRANSIT,
            originalSpotId: 'spot-1',
            geocode: undefined,
            executedAt,
          },
        ];

        const result = creator.execute(events, updateBy);

        expect(result[0].geocode).toBeNull();
      });

      it('複数のeventsを正しく変換できる', () => {
        mockUuid
          .mockReturnValueOnce('uuid-1')
          .mockReturnValueOnce('uuid-2')
          .mockReturnValueOnce('uuid-3');

        const executedAt1 = new Date('2025-11-10T10:00:00Z');
        const executedAt2 = new Date('2025-11-10T11:00:00Z');
        const executedAt3 = new Date('2025-11-10T12:00:00Z');

        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            geocode: { x: 139.7671, y: 35.6812 },
            executedAt: executedAt1,
          },
          {
            shipmentId: 'shipment-2',
            type: SHIPMENT_EVENT_TYPE.IN_TRANSIT,
            originalSpotId: 'spot-2',
            executedAt: executedAt2,
          },
          {
            shipmentId: 'shipment-3',
            type: SHIPMENT_EVENT_TYPE.COMPLETE,
            originalSpotId: 'spot-3',
            geocode: { x: 140.0, y: 36.0 },
            executedAt: executedAt3,
          },
        ];

        const result = creator.execute(events, updateBy);

        expect(result).toHaveLength(3);
        expect(result[0].id).toBe('uuid-1');
        expect(result[0].shipmentId).toBe('shipment-1');
        expect(result[0].type).toBe(SHIPMENT_EVENT_TYPE.STORE);
        expect(result[0].geocode).toEqual({ x: 139.7671, y: 35.6812 });
        expect(result[1].id).toBe('uuid-2');
        expect(result[1].shipmentId).toBe('shipment-2');
        expect(result[1].type).toBe(SHIPMENT_EVENT_TYPE.IN_TRANSIT);
        expect(result[1].geocode).toBeNull();
        expect(result[2].id).toBe('uuid-3');
        expect(result[2].shipmentId).toBe('shipment-3');
        expect(result[2].type).toBe(SHIPMENT_EVENT_TYPE.COMPLETE);
        expect(result[2].geocode).toEqual({ x: 140.0, y: 36.0 });
      });

      it('updateByが正しく設定される', () => {
        const executedAt = new Date('2025-11-10T10:00:00Z');
        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ];

        const result = creator.execute(events, 'test-user-123');

        expect(result[0].updateBy).toBe('test-user-123');
      });

      it('各イベントタイプが正しく保存される', () => {
        mockUuid
          .mockReturnValueOnce('uuid-1')
          .mockReturnValueOnce('uuid-2')
          .mockReturnValueOnce('uuid-3')
          .mockReturnValueOnce('uuid-4')
          .mockReturnValueOnce('uuid-5');

        const executedAt = new Date('2025-11-10T10:00:00Z');
        const events: ShipmentEventInput[] = [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.TO_READY,
            originalSpotId: 'spot-1',
            executedAt,
          },
          {
            shipmentId: 'shipment-2',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-2',
            executedAt,
          },
          {
            shipmentId: 'shipment-3',
            type: SHIPMENT_EVENT_TYPE.IN_TRANSIT,
            originalSpotId: 'spot-3',
            executedAt,
          },
          {
            shipmentId: 'shipment-4',
            type: SHIPMENT_EVENT_TYPE.COMPLETE,
            originalSpotId: 'spot-4',
            executedAt,
          },
          {
            shipmentId: 'shipment-5',
            type: SHIPMENT_EVENT_TYPE.CANCEL,
            originalSpotId: 'spot-5',
            executedAt,
          },
        ];

        const result = creator.execute(events, updateBy);

        expect(result[0].type).toBe(SHIPMENT_EVENT_TYPE.TO_READY);
        expect(result[1].type).toBe(SHIPMENT_EVENT_TYPE.STORE);
        expect(result[2].type).toBe(SHIPMENT_EVENT_TYPE.IN_TRANSIT);
        expect(result[3].type).toBe(SHIPMENT_EVENT_TYPE.COMPLETE);
        expect(result[4].type).toBe(SHIPMENT_EVENT_TYPE.CANCEL);
      });
    });
  });
});
