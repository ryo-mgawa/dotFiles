import { plainToInstance } from 'class-transformer';
import { validate } from 'class-validator';
import 'reflect-metadata';
import { GetShipmentsInput } from './input';

describe('GetShipmentsInput', () => {
  describe('プロパティ設定', () => {
    it('sinceIdが設定できる', () => {
      const input = new GetShipmentsInput();
      input.sinceId = 'shipment-123';

      expect(input.sinceId).toBe('shipment-123');
    });

    it('countが設定できる', () => {
      const input = new GetShipmentsInput();
      input.count = 10;

      expect(input.count).toBe(10);
    });
  });

  describe('バリデーション', () => {
    describe('正常系', () => {
      it('sinceIdとcountが両方提供される場合、バリデーションエラーが発生しない', async () => {
        const data = {
          sinceId: 'shipment-123',
          count: '10',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });

      it('sinceIdのみ提供される場合、バリデーションエラーが発生しない', async () => {
        const data = {
          sinceId: 'shipment-123',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });

      it('countのみ提供される場合（文字列の数値）、バリデーションエラーが発生しない', async () => {
        const data = {
          count: '50',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });

      it('両方とも提供されない場合、バリデーションエラーが発生しない', async () => {
        const data = {};

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });

      it('countが最小値（1）の場合、バリデーションエラーが発生しない', async () => {
        const data = {
          count: '1',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });

      it('countが最大値（100）の場合、バリデーションエラーが発生しない', async () => {
        const data = {
          count: '100',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors).toHaveLength(0);
      });
    });

    describe('異常系', () => {
      it('countが0の場合、バリデーションエラーが発生する', async () => {
        const data = {
          count: '0',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors.length).toBeGreaterThan(0);
        const countError = errors.find(e => e.property === 'count');
        expect(countError).toBeDefined();
      });

      it('countが負の数の場合、バリデーションエラーが発生する', async () => {
        const data = {
          count: '-1',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors.length).toBeGreaterThan(0);
        const countError = errors.find(e => e.property === 'count');
        expect(countError).toBeDefined();
      });

      it('countが101の場合、バリデーションエラーが発生する', async () => {
        const data = {
          count: '101',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors.length).toBeGreaterThan(0);
        const countError = errors.find(e => e.property === 'count');
        expect(countError).toBeDefined();
      });

      it('countが数値に変換できない文字列の場合、バリデーションエラーが発生する', async () => {
        const data = {
          count: 'abc',
        };

        const input = plainToInstance(GetShipmentsInput, data);
        const errors = await validate(input);

        expect(errors.length).toBeGreaterThan(0);
        const countError = errors.find(e => e.property === 'count');
        expect(countError).toBeDefined();
      });
    });

    describe('型変換', () => {
      it('文字列の数値がnumber型に変換される', async () => {
        const data = {
          count: '25',
        };

        const input = plainToInstance(GetShipmentsInput, data);

        expect(typeof input.count).toBe('number');
        expect(input.count).toBe(25);
      });

      it('空文字列の場合、undefinedとして扱われる', async () => {
        const data = {
          count: '',
        };

        const input = plainToInstance(GetShipmentsInput, data);

        expect(input.count).toBe('');
      });
    });
  });
});
