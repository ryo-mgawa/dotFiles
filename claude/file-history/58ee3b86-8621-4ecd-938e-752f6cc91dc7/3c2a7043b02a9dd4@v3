import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetCurrentUserUseCase } from './GetCurrentUserUseCase.js';
import type { IUserRepository } from '@/infrastructure/database/repositories/index.js';
import type { ICompanyRepository } from '@/infrastructure/database/repositories/index.js';

describe('GetCurrentUserUseCase', () => {
  let getCurrentUserUseCase: GetCurrentUserUseCase;
  let mockUserRepository: IUserRepository;
  let mockCompanyRepository: ICompanyRepository;

  const mockUser = {
    id: 'user-1',
    email: 'test@example.com',
    name: 'Test User',
    passwordHash: 'hashed-password',
    companyId: 'company-1',
    siteId: 'site-1',
    role: 'admin' as const,
    createdAt: new Date(),
    updatedAt: new Date(),
  };

  const mockCompany = {
    id: 'company-1',
    name: 'Test Company',
    zoomAccountId: 'zoom-123',
    zoomClientId: 'client-123',
    zoomClientSecret: 'secret-123',
    createdAt: new Date(),
    updatedAt: new Date(),
  };

  beforeEach(() => {
    vi.clearAllMocks();

    mockUserRepository = {
      findById: vi.fn(),
      findByEmail: vi.fn(),
      findByCompanyId: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    };

    mockCompanyRepository = {
      findById: vi.fn(),
      findAll: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    };

    getCurrentUserUseCase = new GetCurrentUserUseCase(mockUserRepository, mockCompanyRepository);
  });

  it('現在のユーザー情報を返す', async () => {
    vi.mocked(mockUserRepository.findById).mockResolvedValue(mockUser);
    vi.mocked(mockCompanyRepository.findById).mockResolvedValue(mockCompany);

    const result = await getCurrentUserUseCase.execute('user-1');

    expect(result).toEqual({
      user: {
        id: 'user-1',
        email: 'test@example.com',
        name: 'Test User',
        siteId: 'site-1',
        role: 'admin',
      },
      company: {
        id: 'company-1',
        name: 'Test Company',
      },
    });

    expect(mockUserRepository.findById).toHaveBeenCalledWith('user-1');
    expect(mockCompanyRepository.findById).toHaveBeenCalledWith('company-1');
  });

  it('ユーザーが見つからない場合エラーをスローする', async () => {
    vi.mocked(mockUserRepository.findById).mockResolvedValue(null);

    await expect(getCurrentUserUseCase.execute('not-found')).rejects.toThrow('User not found');
  });

  it('会社が見つからない場合エラーをスローする', async () => {
    vi.mocked(mockUserRepository.findById).mockResolvedValue(mockUser);
    vi.mocked(mockCompanyRepository.findById).mockResolvedValue(null);

    await expect(getCurrentUserUseCase.execute('user-1')).rejects.toThrow('Company not found');
  });
});
