# 豊田高専陸上部ホームページ 実装設計書

## 1. アーキテクチャ概要

### 1.1 全体構成
本プロジェクトは、Clean Architectureを採用したフルスタックWebアプリケーションです。

```
┌─────────────────────────────────────────────────────────┐
│                    フロントエンド (React)                  │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Presentation Layer (Components)                  │   │
│  │  - Pages, UI Components                          │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Application Layer (State Management)            │   │
│  │  - Context API + useReducer                      │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕ HTTP/REST API
┌─────────────────────────────────────────────────────────┐
│                  バックエンド (Express)                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Interface Layer (Controllers)                    │   │
│  │  - Request/Response handling                     │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Application Layer (Use Cases)                    │   │
│  │  - Business Logic orchestration                  │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Domain Layer (Entities, Value Objects)          │   │
│  │  - Core Business Logic                           │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Infrastructure Layer (Repository, External API) │   │
│  │  - Prisma ORM, microCMS Client                   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
                    ┌───────────────┐
                    │  Supabase     │
                    │  (PostgreSQL) │
                    └───────────────┘
```

### 1.2 技術スタック

#### フロントエンド
- **React 19**: UIライブラリ
- **TypeScript 5.7+**: 型安全性の確保
- **React Router v7**: SPA routing
- **React Bootstrap 2.x**: UIコンポーネント
- **React Big Calendar**: カレンダー表示
- **Axios**: HTTP通信

#### バックエンド
- **Node.js v20/v22**: JavaScript runtime
- **Express**: Webフレームワーク
- **TypeScript 5.7+**: 型安全性の確保
- **Prisma 6.x**: ORM
- **Helmet**: セキュリティヘッダー
- **CORS**: CORS設定

#### データベース・外部サービス
- **Supabase (PostgreSQL)**: メインデータベース
- **microCMS**: コンテンツ管理（写真管理）

#### 開発ツール
- **ESLint 9.x**: 静的解析
- **Prettier 3.x**: コード整形
- **Jest 29.x / Vitest 2.x**: テストフレームワーク
- **React Testing Library 16.x**: コンポーネントテスト

## 2. ディレクトリ構造

```
NittcTrackAndFieldHP/
├── front/                      # フロントエンド
│   ├── src/
│   │   ├── components/         # Presentational Components
│   │   │   ├── common/         # 共通コンポーネント
│   │   │   │   ├── Header.tsx
│   │   │   │   ├── Footer.tsx
│   │   │   │   ├── LoadingSpinner.tsx
│   │   │   │   └── ErrorBoundary.tsx
│   │   │   ├── members/        # 部員関連
│   │   │   │   ├── MemberTable.tsx
│   │   │   │   └── MemberRow.tsx
│   │   │   ├── advisors/       # 顧問関連
│   │   │   │   └── AdvisorList.tsx
│   │   │   ├── competitions/   # 大会関連
│   │   │   │   ├── CompetitionList.tsx
│   │   │   │   ├── CompetitionDetail.tsx
│   │   │   │   └── YearSelector.tsx
│   │   │   ├── records/        # 記録関連
│   │   │   │   ├── AllTimeRecordsTable.tsx
│   │   │   │   ├── PersonalRecordsTable.tsx
│   │   │   │   └── RecordRow.tsx
│   │   │   └── home/           # トップページ関連
│   │   │       ├── PhotoSlideshow.tsx
│   │   │       ├── TwitterEmbed.tsx
│   │   │       └── ActivitySchedule.tsx
│   │   ├── pages/              # Page Components
│   │   │   ├── HomePage.tsx
│   │   │   ├── MembersPage.tsx
│   │   │   ├── AdvisorsPage.tsx
│   │   │   ├── CompetitionsPage.tsx
│   │   │   ├── AllTimeRecordsPage.tsx
│   │   │   └── PersonalRecordsPage.tsx
│   │   ├── contexts/           # Context API
│   │   │   ├── MembersContext.tsx
│   │   │   ├── CompetitionsContext.tsx
│   │   │   └── RecordsContext.tsx
│   │   ├── hooks/              # Custom Hooks
│   │   │   ├── useMemberList.ts
│   │   │   ├── useCompetitions.ts
│   │   │   ├── useRecords.ts
│   │   │   └── useAuth.ts
│   │   ├── services/           # API通信
│   │   │   ├── api/
│   │   │   │   ├── apiClient.ts
│   │   │   │   ├── membersApi.ts
│   │   │   │   ├── competitionsApi.ts
│   │   │   │   ├── recordsApi.ts
│   │   │   │   └── advisorsApi.ts
│   │   │   └── cms/
│   │   │       └── microCmsClient.ts
│   │   ├── types/              # 型定義
│   │   │   ├── models/
│   │   │   │   ├── Member.ts
│   │   │   │   ├── Competition.ts
│   │   │   │   ├── Record.ts
│   │   │   │   └── Advisor.ts
│   │   │   └── api/
│   │   │       └── responses.ts
│   │   ├── constants/          # 定数定義
│   │   │   ├── departments.ts
│   │   │   ├── blocks.ts
│   │   │   ├── events.ts
│   │   │   └── routes.ts
│   │   ├── utils/              # ユーティリティ
│   │   │   ├── gradeCalculator.ts
│   │   │   ├── sortHelpers.ts
│   │   │   ├── formatters.ts
│   │   │   └── validators.ts
│   │   ├── App.tsx
│   │   ├── index.tsx
│   │   └── routes.tsx
│   ├── public/
│   ├── package.json
│   ├── tsconfig.json
│   └── vite.config.ts          # Vite設定
│
├── server/                     # バックエンド
│   ├── src/
│   │   ├── interface/          # Interface Layer
│   │   │   ├── controllers/
│   │   │   │   ├── MembersController.ts
│   │   │   │   ├── CompetitionsController.ts
│   │   │   │   ├── RecordsController.ts
│   │   │   │   └── AdvisorsController.ts
│   │   │   ├── middlewares/
│   │   │   │   ├── errorHandler.ts
│   │   │   │   ├── validation.ts
│   │   │   │   └── auth.ts
│   │   │   └── routes/
│   │   │       ├── index.ts
│   │   │       ├── members.routes.ts
│   │   │       ├── competitions.routes.ts
│   │   │       ├── records.routes.ts
│   │   │       └── advisors.routes.ts
│   │   ├── application/        # Application Layer
│   │   │   ├── usecases/
│   │   │   │   ├── members/
│   │   │   │   │   ├── GetMemberListUseCase.ts
│   │   │   │   │   ├── CreateMemberUseCase.ts
│   │   │   │   │   └── UpdateMemberUseCase.ts
│   │   │   │   ├── competitions/
│   │   │   │   │   ├── GetCompetitionsByYearUseCase.ts
│   │   │   │   │   └── CreateCompetitionUseCase.ts
│   │   │   │   └── records/
│   │   │   │       ├── GetAllTimeRecordsUseCase.ts
│   │   │   │       ├── GetPersonalRecordsUseCase.ts
│   │   │   │       └── CreateRecordUseCase.ts
│   │   │   └── dto/
│   │   │       ├── MemberDto.ts
│   │   │       ├── CompetitionDto.ts
│   │   │       └── RecordDto.ts
│   │   ├── domain/             # Domain Layer
│   │   │   ├── entities/
│   │   │   │   ├── Member.ts
│   │   │   │   ├── Competition.ts
│   │   │   │   ├── Record.ts
│   │   │   │   └── Advisor.ts
│   │   │   ├── value-objects/
│   │   │   │   ├── Department.ts
│   │   │   │   ├── Block.ts
│   │   │   │   ├── Grade.ts
│   │   │   │   └── StudentNumber.ts
│   │   │   ├── repositories/   # Repository Interfaces
│   │   │   │   ├── IMemberRepository.ts
│   │   │   │   ├── ICompetitionRepository.ts
│   │   │   │   ├── IRecordRepository.ts
│   │   │   │   └── IAdvisorRepository.ts
│   │   │   └── services/       # Domain Services
│   │   │       ├── GradeCalculationService.ts
│   │   │       └── RecordRankingService.ts
│   │   ├── infrastructure/     # Infrastructure Layer
│   │   │   ├── database/
│   │   │   │   ├── prisma/
│   │   │   │   │   └── schema.prisma
│   │   │   │   └── repositories/
│   │   │   │       ├── MemberRepository.ts
│   │   │   │       ├── CompetitionRepository.ts
│   │   │   │       ├── RecordRepository.ts
│   │   │   │       └── AdvisorRepository.ts
│   │   │   └── external/
│   │   │       └── microCmsClient.ts
│   │   ├── shared/             # 共通ユーティリティ
│   │   │   ├── errors/
│   │   │   │   ├── AppError.ts
│   │   │   │   ├── NotFoundError.ts
│   │   │   │   └── ValidationError.ts
│   │   │   ├── constants/
│   │   │   │   ├── departments.ts
│   │   │   │   ├── blocks.ts
│   │   │   │   └── events.ts
│   │   │   └── utils/
│   │   │       ├── logger.ts
│   │   │       └── validators.ts
│   │   ├── config/
│   │   │   ├── database.ts
│   │   │   ├── cors.ts
│   │   │   └── env.ts
│   │   └── server.ts
│   ├── tests/
│   │   ├── unit/
│   │   ├── integration/
│   │   └── e2e/
│   ├── package.json
│   ├── tsconfig.json
│   └── jest.config.js
│
├── docs/                       # ドキュメント
│   ├── api/
│   │   └── api-spec.yaml       # OpenAPI仕様
│   └── architecture/
│       └── decision-records/
│
├── requirements.md
├── design.md
├── db_design.md
└── README.md
```

## 3. フロントエンド設計

### 3.1 コンポーネント設計原則

#### 3.1.1 コンポーネント分類
- **Pages**: ページ単位のコンポーネント（ルーティング対象）
- **Components**: 再利用可能なUIコンポーネント
- **Containers**: データ取得とロジックを持つコンポーネント（必要に応じて）

#### 3.1.2 コンポーネント設計ガイドライン
```typescript
// Good: 単一責任、型安全、Props明確
interface MemberRowProps {
  member: Member;
  onEdit?: (id: string) => void;
}

export const MemberRow: React.FC<MemberRowProps> = ({ member, onEdit }) => {
  const grade = calculateGrade(member.enrollmentYear);

  return (
    <tr>
      <td>{grade}</td>
      <td>{DEPARTMENTS[member.department]}</td>
      <td>{member.name}</td>
      <td>{BLOCKS[member.block]}</td>
    </tr>
  );
};
```

### 3.2 状態管理設計

#### 3.2.1 Context + useReducer パターン
```typescript
// contexts/MembersContext.tsx
interface MembersState {
  members: Member[];
  loading: boolean;
  error: string | null;
}

type MembersAction =
  | { type: 'FETCH_START' }
  | { type: 'FETCH_SUCCESS'; payload: Member[] }
  | { type: 'FETCH_ERROR'; payload: string };

const membersReducer = (state: MembersState, action: MembersAction): MembersState => {
  switch (action.type) {
    case 'FETCH_START':
      return { ...state, loading: true, error: null };
    case 'FETCH_SUCCESS':
      return { members: action.payload, loading: false, error: null };
    case 'FETCH_ERROR':
      return { ...state, loading: false, error: action.payload };
    default:
      return state;
  }
};

export const MembersProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(membersReducer, initialState);

  return (
    <MembersContext.Provider value={{ state, dispatch }}>
      {children}
    </MembersContext.Provider>
  );
};
```

#### 3.2.2 カスタムフック
```typescript
// hooks/useMemberList.ts
export const useMemberList = () => {
  const { state, dispatch } = useContext(MembersContext);

  const fetchMembers = useCallback(async () => {
    dispatch({ type: 'FETCH_START' });
    try {
      const members = await getMembersApi();
      dispatch({ type: 'FETCH_SUCCESS', payload: members });
    } catch (error) {
      dispatch({ type: 'FETCH_ERROR', payload: error.message });
    }
  }, [dispatch]);

  useEffect(() => {
    fetchMembers();
  }, [fetchMembers]);

  return {
    members: state.members,
    loading: state.loading,
    error: state.error,
    refetch: fetchMembers,
  };
};
```

### 3.3 ルーティング設計

```typescript
// routes.tsx
export const routes = [
  {
    path: '/',
    element: <HomePage />,
  },
  {
    path: '/members',
    element: <MembersPage />,
  },
  {
    path: '/advisors',
    element: <AdvisorsPage />,
  },
  {
    path: '/competitions',
    element: <CompetitionsPage />,
  },
  {
    path: '/records/all-time',
    element: <AllTimeRecordsPage />,
  },
  {
    path: '/records/personal',
    element: <PersonalRecordsPage />,
  },
] as const;
```

### 3.4 API通信設計

```typescript
// services/api/apiClient.ts
import axios from 'axios';

export const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// リクエストインターセプター
apiClient.interceptors.request.use(
  (config) => {
    // 認証トークンの追加など
    return config;
  },
  (error) => Promise.reject(error)
);

// レスポンスインターセプター
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    // エラーハンドリング
    if (error.response?.status === 401) {
      // 認証エラー処理
    }
    return Promise.reject(error);
  }
);
```

```typescript
// services/api/membersApi.ts
import { apiClient } from './apiClient';
import type { Member } from '@/types/models/Member';

export const getMembersApi = async (): Promise<Member[]> => {
  const response = await apiClient.get<Member[]>('/members');
  return response.data;
};

export const getMemberByIdApi = async (id: string): Promise<Member> => {
  const response = await apiClient.get<Member>(`/members/${id}`);
  return response.data;
};

export const createMemberApi = async (data: Omit<Member, 'id'>): Promise<Member> => {
  const response = await apiClient.post<Member>('/members', data);
  return response.data;
};
```

## 4. バックエンド設計

### 4.1 Clean Architecture レイヤー構成

#### 4.1.1 Interface Layer（外部とのインターフェース）
```typescript
// interface/controllers/MembersController.ts
export class MembersController {
  constructor(
    private readonly getMemberListUseCase: GetMemberListUseCase,
    private readonly createMemberUseCase: CreateMemberUseCase
  ) {}

  async getMembers(req: Request, res: Response, next: NextFunction): Promise<void> {
    try {
      const members = await this.getMemberListUseCase.execute();
      res.status(200).json(members);
    } catch (error) {
      next(error);
    }
  }

  async createMember(req: Request, res: Response, next: NextFunction): Promise<void> {
    try {
      const memberDto: CreateMemberDto = req.body;
      const member = await this.createMemberUseCase.execute(memberDto);
      res.status(201).json(member);
    } catch (error) {
      next(error);
    }
  }
}
```

#### 4.1.2 Application Layer（ユースケース）
```typescript
// application/usecases/members/GetMemberListUseCase.ts
export class GetMemberListUseCase {
  constructor(private readonly memberRepository: IMemberRepository) {}

  async execute(): Promise<MemberDto[]> {
    const members = await this.memberRepository.findAllActive();

    // ビジネスロジック: ソート処理
    const sortedMembers = this.sortMembers(members);

    return sortedMembers.map(member => this.toDto(member));
  }

  private sortMembers(members: Member[]): Member[] {
    return members.sort((a, b) => {
      // 学年優先
      const gradeA = calculateGrade(a.enrollmentYear);
      const gradeB = calculateGrade(b.enrollmentYear);
      if (gradeA !== gradeB) return gradeB - gradeA;

      // 学科優先
      const deptOrder = ['M', 'E', 'I', 'C', 'A'];
      const deptDiff = deptOrder.indexOf(a.department) - deptOrder.indexOf(b.department);
      if (deptDiff !== 0) return deptDiff;

      // 五十音順
      return a.name.localeCompare(b.name, 'ja');
    });
  }

  private toDto(member: Member): MemberDto {
    return {
      id: member.id,
      name: member.name,
      grade: calculateGrade(member.enrollmentYear),
      department: member.department,
      block: member.block,
    };
  }
}
```

#### 4.1.3 Domain Layer（ビジネスロジック）
```typescript
// domain/entities/Member.ts
export class Member {
  constructor(
    public readonly id: string,
    public readonly studentNumber: string,
    public readonly name: string,
    public readonly enrollmentYear: number,
    public readonly graduationYear: number | null,
    public readonly department: Department,
    public readonly block: Block,
    public readonly isActive: boolean
  ) {
    this.validate();
  }

  private validate(): void {
    if (this.enrollmentYear < 1900 || this.enrollmentYear > new Date().getFullYear()) {
      throw new ValidationError('Invalid enrollment year');
    }
    if (this.graduationYear && this.graduationYear < this.enrollmentYear) {
      throw new ValidationError('Graduation year must be after enrollment year');
    }
  }

  getCurrentGrade(): number {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    // 4月から新学年
    const academicYear = currentMonth >= 4 ? currentYear : currentYear - 1;
    return academicYear - this.enrollmentYear + 1;
  }

  isGraduated(): boolean {
    return !this.isActive || this.graduationYear !== null;
  }
}
```

```typescript
// domain/value-objects/Department.ts
export class Department {
  private static readonly VALID_DEPARTMENTS = ['M', 'E', 'I', 'C', 'A'] as const;

  constructor(public readonly value: typeof Department.VALID_DEPARTMENTS[number]) {
    if (!Department.VALID_DEPARTMENTS.includes(value)) {
      throw new ValidationError(`Invalid department: ${value}`);
    }
  }

  toString(): string {
    return this.value;
  }
}
```

#### 4.1.4 Infrastructure Layer（技術的実装）
```typescript
// infrastructure/database/repositories/MemberRepository.ts
export class MemberRepository implements IMemberRepository {
  constructor(private readonly prisma: PrismaClient) {}

  async findAllActive(): Promise<Member[]> {
    const members = await this.prisma.member.findMany({
      where: { isActive: true },
    });
    return members.map(this.toDomain);
  }

  async findById(id: string): Promise<Member | null> {
    const member = await this.prisma.member.findUnique({
      where: { id },
    });
    return member ? this.toDomain(member) : null;
  }

  async save(member: Member): Promise<Member> {
    const data = this.toPersistence(member);
    const saved = await this.prisma.member.create({ data });
    return this.toDomain(saved);
  }

  private toDomain(record: any): Member {
    return new Member(
      record.id,
      record.studentNumber,
      record.name,
      record.enrollmentYear,
      record.graduationYear,
      new Department(record.department),
      new Block(record.block),
      record.isActive
    );
  }

  private toPersistence(member: Member): any {
    return {
      id: member.id,
      studentNumber: member.studentNumber,
      name: member.name,
      enrollmentYear: member.enrollmentYear,
      graduationYear: member.graduationYear,
      department: member.department.value,
      block: member.block.value,
      isActive: member.isActive,
    };
  }
}
```

### 4.2 API設計

#### 4.2.1 RESTful API エンドポイント

**部員管理**
- `GET /api/members` - 在籍中の部員一覧取得
- `GET /api/members/:id` - 部員詳細取得
- `POST /api/members` - 部員登録
- `PUT /api/members/:id` - 部員情報更新
- `DELETE /api/members/:id` - 部員削除（論理削除）

**顧問管理**
- `GET /api/advisors` - 現職顧問一覧取得
- `POST /api/advisors` - 顧問登録
- `PUT /api/advisors/:id` - 顧問情報更新

**大会管理**
- `GET /api/competitions` - 大会一覧取得（年度でフィルタ可能）
- `GET /api/competitions/:id` - 大会詳細取得
- `POST /api/competitions` - 大会登録
- `PUT /api/competitions/:id` - 大会情報更新

**記録管理**
- `GET /api/records` - 記録一覧取得
- `GET /api/records/all-time` - 歴代記録取得（種目・性別でフィルタ）
- `GET /api/records/personal/:studentNumber` - 個人記録取得（認証必要）
- `POST /api/records` - 記録登録

**活動情報**
- `GET /api/activities` - 活動時間取得

#### 4.2.2 レスポンス形式

**成功レスポンス**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "山田太郎",
    "grade": 3,
    "department": "M",
    "block": "短距離"
  }
}
```

**エラーレスポンス**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [
      {
        "field": "enrollmentYear",
        "message": "必須項目です"
      }
    ]
  }
}
```

### 4.3 エラーハンドリング

```typescript
// shared/errors/AppError.ts
export class AppError extends Error {
  constructor(
    public readonly message: string,
    public readonly statusCode: number = 500,
    public readonly code: string = 'INTERNAL_ERROR',
    public readonly isOperational: boolean = true
  ) {
    super(message);
    Object.setPrototypeOf(this, AppError.prototype);
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super(`${resource} not found`, 404, 'NOT_FOUND');
  }
}

export class ValidationError extends AppError {
  constructor(message: string, public readonly details?: any[]) {
    super(message, 400, 'VALIDATION_ERROR');
  }
}
```

```typescript
// interface/middlewares/errorHandler.ts
export const errorHandler = (
  error: Error,
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  if (error instanceof AppError) {
    res.status(error.statusCode).json({
      success: false,
      error: {
        code: error.code,
        message: error.message,
        details: error instanceof ValidationError ? error.details : undefined,
      },
    });
    return;
  }

  // 予期しないエラー
  console.error('Unexpected error:', error);
  res.status(500).json({
    success: false,
    error: {
      code: 'INTERNAL_ERROR',
      message: 'An unexpected error occurred',
    },
  });
};
```

## 5. セキュリティ設計

### 5.1 認証・認可

#### 5.1.1 個人記録閲覧認証
```typescript
// interface/middlewares/auth.ts
export const validateStudentNumber = async (
  req: Request,
  res: Response,
  next: NextFunction
): Promise<void> => {
  const { studentNumber } = req.params;
  const { authToken } = req.headers;

  if (!authToken) {
    throw new UnauthorizedError('認証トークンが必要です');
  }

  // 個人番号の検証
  const isValid = await verifyStudentNumber(studentNumber, authToken);
  if (!isValid) {
    throw new UnauthorizedError('認証に失敗しました');
  }

  next();
};
```

### 5.2 セキュリティ対策

```typescript
// server.ts
import helmet from 'helmet';
import cors from 'cors';

app.use(helmet()); // セキュリティヘッダー設定

app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
}));

// SQLインジェクション対策: Prismaが自動対応
// XSS対策: helmet + フロントエンドでのエスケープ処理
// CSRF対策: SameSite cookie + CSRFトークン
```

## 6. テスト戦略

### 6.1 テスト方針

#### 6.1.1 テストピラミッド
```
         /\
        /  \  E2E (少数)
       /----\
      /      \ Integration (中程度)
     /--------\
    /          \ Unit (多数)
   /____________\
```

### 6.2 ユニットテスト

```typescript
// tests/unit/domain/entities/Member.test.ts
describe('Member Entity', () => {
  describe('getCurrentGrade', () => {
    it('正しく学年を計算する', () => {
      const member = new Member(
        'id',
        '12345',
        '山田太郎',
        2023,
        null,
        new Department('M'),
        new Block('短距離'),
        true
      );

      // 2025年4月の場合
      const grade = member.getCurrentGrade();
      expect(grade).toBe(3);
    });
  });

  describe('validation', () => {
    it('不正な入学年度でエラーをスローする', () => {
      expect(() => {
        new Member('id', '12345', '山田太郎', 1800, null,
          new Department('M'), new Block('短距離'), true);
      }).toThrow(ValidationError);
    });
  });
});
```

### 6.3 統合テスト

```typescript
// tests/integration/usecases/GetMemberListUseCase.test.ts
describe('GetMemberListUseCase', () => {
  let useCase: GetMemberListUseCase;
  let repository: IMemberRepository;

  beforeEach(() => {
    repository = new InMemoryMemberRepository();
    useCase = new GetMemberListUseCase(repository);
  });

  it('在籍中の部員を正しくソートして返す', async () => {
    // Arrange
    await repository.save(createTestMember({ name: '田中', enrollmentYear: 2023 }));
    await repository.save(createTestMember({ name: '山田', enrollmentYear: 2024 }));

    // Act
    const members = await useCase.execute();

    // Assert
    expect(members).toHaveLength(2);
    expect(members[0].grade).toBe(2);
    expect(members[1].grade).toBe(1);
  });
});
```

## 7. コーディング規約

### 7.1 TypeScript規約

#### 7.1.1 型定義
```typescript
// Good: 明確な型定義
type Department = 'M' | 'E' | 'I' | 'C' | 'A';
type Block = '短距離' | '中長距離' | '跳躍' | '投擲';

interface Member {
  id: string;
  name: string;
  enrollmentYear: number;
  department: Department;
  block: Block;
}

// Bad: any型の使用
let data: any = fetchData();
```

#### 7.1.2 定数管理
```typescript
// constants/departments.ts
export const DEPARTMENTS = {
  M: '機械工学科',
  E: '電気・電子システム工学科',
  I: '情報工学科',
  C: '環境都市工学科',
  A: '建築学科',
} as const;

export type DepartmentCode = keyof typeof DEPARTMENTS;

// constants/blocks.ts
export const BLOCKS = {
  SPRINT: '短距離',
  DISTANCE: '中長距離',
  JUMP: '跳躍',
  THROW: '投擲',
} as const;
```

#### 7.1.3 アーリーリターン
```typescript
// Good
function validateMember(member: Member | null): string {
  if (!member) return 'メンバーが見つかりません';
  if (!member.isActive) return 'メンバーが無効です';
  if (member.graduationYear) return 'すでに卒業しています';

  return member.name;
}

// Bad
function validateMember(member: Member | null): string {
  if (member) {
    if (member.isActive) {
      if (!member.graduationYear) {
        return member.name;
      } else {
        return 'すでに卒業しています';
      }
    } else {
      return 'メンバーが無効です';
    }
  } else {
    return 'メンバーが見つかりません';
  }
}
```

### 7.2 命名規則

- **変数・関数**: camelCase
- **型・インターフェース・クラス**: PascalCase
- **定数**: UPPER_SNAKE_CASE
- **ファイル名**: PascalCase (コンポーネント), camelCase (その他)

```typescript
// Good
const maxRecords = 10;
const DEPARTMENTS = ['M', 'E', 'I', 'C', 'A'] as const;
class MemberRepository {}
interface IMemberRepository {}
type MemberDto = {};

// Bad
const MaxRecords = 10;
const departments = ['M', 'E', 'I', 'C', 'A'];
class memberRepository {}
```

### 7.3 関数設計

```typescript
// Good: 単一責任、引数3つ以内、20行以内
function createMember(
  name: string,
  enrollmentYear: number,
  department: Department
): Member {
  validateName(name);
  validateYear(enrollmentYear);

  return new Member(
    generateId(),
    generateStudentNumber(),
    name,
    enrollmentYear,
    null,
    department,
    DEFAULT_BLOCK,
    true
  );
}

// Bad: 複数の責任、引数多数
function createAndSaveMember(
  name: string,
  enrollmentYear: number,
  graduationYear: number | null,
  department: Department,
  block: Block,
  isActive: boolean,
  repository: IMemberRepository
): Promise<Member> {
  // 検証、生成、保存が混在
}
```

## 8. パフォーマンス最適化

### 8.1 フロントエンド最適化

```typescript
// React.memoの活用
export const MemberRow = React.memo<MemberRowProps>(({ member }) => {
  // ...
});

// useMemoの活用
const sortedMembers = useMemo(() => {
  return members.sort((a, b) => {
    // ソートロジック
  });
}, [members]);

// useCallbackの活用
const handleEdit = useCallback((id: string) => {
  // 編集処理
}, []);
```

### 8.2 バックエンド最適化

- データベースクエリの最適化（インデックス活用）
- N+1問題の回避（Prismaのinclude活用）
- ページネーションの実装
- キャッシング戦略（Redis等、将来的に）

## 9. 外部サービス連携

### 9.1 microCMS連携

```typescript
// infrastructure/external/microCmsClient.ts
import { createClient } from 'microcms-js-sdk';

export const microCmsClient = createClient({
  serviceDomain: process.env.MICROCMS_SERVICE_DOMAIN!,
  apiKey: process.env.MICROCMS_API_KEY!,
});

export async function getActivityPhotos(): Promise<Photo[]> {
  const response = await microCmsClient.get({
    endpoint: 'photos',
    queries: { limit: 5, orders: '-publishedAt' },
  });
  return response.contents;
}
```

### 9.2 Twitter埋め込み

```typescript
// components/home/TwitterEmbed.tsx
export const TwitterEmbed: React.FC = () => {
  useEffect(() => {
    // Twitter Widgetスクリプトの読み込み
    const script = document.createElement('script');
    script.src = 'https://platform.twitter.com/widgets.js';
    script.async = true;
    document.body.appendChild(script);

    return () => {
      document.body.removeChild(script);
    };
  }, []);

  return (
    <a
      className="twitter-timeline"
      href="https://twitter.com/nittc_trackfield"
      data-height="400"
    >
      Tweets by nittc_trackfield
    </a>
  );
};
```

## 10. デプロイメント設計

### 10.1 環境構成

- **開発環境**: ローカル（Docker Compose）
- **ステージング環境**: Vercel (Front) + Railway (Server)
- **本番環境**: Vercel (Front) + Railway (Server) + Supabase (DB)

### 10.2 CI/CD

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build
```

## 11. 監視・ログ

### 11.1 ログ設計

```typescript
// shared/utils/logger.ts
import winston from 'winston';

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});
```

### 11.2 エラー監視

- Sentryの導入検討（将来的に）
- アプリケーションログの集約
- パフォーマンス監視
