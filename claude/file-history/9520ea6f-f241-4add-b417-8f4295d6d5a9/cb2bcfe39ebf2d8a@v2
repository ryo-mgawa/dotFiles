import { useEffect, useState } from 'react';
import { Container, Form } from 'react-bootstrap';
import { CompetitionList } from '@/components/competitions/CompetitionList';
import { LoadingSpinner } from '@/components/common/LoadingSpinner';
import { ErrorMessage } from '@/components/common/ErrorMessage';
import { getCompetitions } from '@/services/api/competitionsApi';
import { Competition } from '@/types/models/Competition';

/**
 * 大会結果ページ
 * requirements.md 2.4節を参照
 */
export const CompetitionsPage = () => {
  const [competitions, setCompetitions] = useState<Competition[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedYear, setSelectedYear] = useState<number | undefined>(new Date().getFullYear());

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        const data = await getCompetitions(selectedYear);
        setCompetitions(data);
      } catch (err) {
        setError('大会情報の取得に失敗しました');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    void fetchData();
  }, [selectedYear]);

  const handleYearChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const value = e.target.value;
    setSelectedYear(value === 'all' ? undefined : parseInt(value, 10));
  };

  // 年度選択肢（過去5年分）
  const currentYear = new Date().getFullYear();
  const years = Array.from({ length: 5 }, (_, i) => currentYear - i);

  return (
    <Container>
      <h2 className="mb-4">大会結果</h2>

      <Form.Group className="mb-4">
        <Form.Label>年度選択</Form.Label>
        <Form.Select value={selectedYear || 'all'} onChange={handleYearChange}>
          <option value="all">全て</option>
          {years.map((year) => (
            <option key={year} value={year}>
              {year}年度
            </option>
          ))}
        </Form.Select>
      </Form.Group>

      {loading ? <LoadingSpinner /> : error ? <ErrorMessage message={error} /> : <CompetitionList competitions={competitions} />}
    </Container>
  );
};
