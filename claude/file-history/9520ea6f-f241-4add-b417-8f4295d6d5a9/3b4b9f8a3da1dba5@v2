/**
 * 学年計算ユーティリティ
 * requirements.md 4.2節、db_design.md 3.1節を参照
 */

/**
 * 入学年度から現在の学年を計算
 * 4月始まりの年度基準で計算
 *
 * @param enrollmentYear 入学年度
 * @returns 学年（1-5）
 *
 * @example
 * calculateGrade(2023) // 2025年4月現在 → 3年生
 * calculateGrade(2024) // 2025年1月現在 → 1年生（まだ2024年度）
 */
export function calculateGrade(enrollmentYear: number): number {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1; // 0-indexed なので+1

  // 4月から新学年が始まる
  // 例: 2025年1月は2024年度、2025年4月は2025年度
  const academicYear = currentMonth >= 4 ? currentYear : currentYear - 1;

  const grade = academicYear - enrollmentYear + 1;

  return grade;
}

/**
 * 指定年度における学年を計算
 * 大会記録等で使用
 *
 * @param enrollmentYear 入学年度
 * @param targetYear 対象年度
 * @returns 学年（1-5）
 */
export function calculateGradeAtYear(enrollmentYear: number, targetYear: number): number {
  return targetYear - enrollmentYear + 1;
}

/**
 * 卒業判定
 *
 * @param graduationYear 卒業年度（nullable）
 * @param isActive 在籍フラグ
 * @returns 卒業済みかどうか
 */
export function isGraduated(graduationYear: number | null, isActive: boolean): boolean {
  if (!isActive) {
    return true;
  }

  if (graduationYear === null) {
    return false;
  }

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  // 卒業年度の3月末までは在学中
  const academicYear = currentMonth >= 4 ? currentYear : currentYear - 1;

  return academicYear >= graduationYear;
}
