import {useManagerOrganizationFlags} from '../../data/useManagerOrganizationFlags';
import {useSaveManagerFlagsMutation} from '@/hooks/useBaseQueries/flag/useSaveManagerFlagsMutation';
import {useSettingsToast} from '@/widgets/setting/hooks/useSettingsToast';
import {useFlagSave} from '../useFlagSave';
import {convertToManagerOrganizationSaveRequest} from './converters';
import {flagsFormSchema} from './schema';
import {useSettingForm} from '@/widgets/setting/hooks/useSettingForm';

type UseManagerOrganizationFlagFormParams = {
  enabled?: boolean;
};

/**
 * Manager用組織フラグフォームのカスタムフック
 */
export const useManagerOrganizationFlagForm = ({enabled = true}: UseManagerOrganizationFlagFormParams = {}) => {
  const {data: flagsData, isLoading: isFetching} = useManagerOrganizationFlags({enabled});

  const {mutateAsync, isLoading: isMutationFetching, isSuccess, isError} = useSaveManagerFlagsMutation();

  useSettingsToast(isMutationFetching, isSuccess, isError);

  const organizationId = flagsData?.flags.organizationId ?? '';

  const {handleSave} = useFlagSave({
    schema: flagsFormSchema,
    convertToRequest: (valueMap, policyMap) =>
      convertToManagerOrganizationSaveRequest(valueMap, policyMap, organizationId),
    mutateAsync,
  });

  const {
    settingSections,
    hasChanges,
    hasErrors,
    isLoading,
    handleSave: handleFormSave,
  } = useSettingForm({
    flagDefines: flagsData?.flags.flagDefines ?? [],
    flagStatuses: flagsData?.flags.flagStatuses ?? [],
    flagPolicies: flagsData?.flags.flagPolicies ?? [],
    onSave: handleSave,
    isSaving: isMutationFetching,
    settingType: 'organization',
    userRole: 'manager',
  });

  return {
    settingSections,
    hasChanges,
    hasErrors,
    isLoading,
    isFetching,
    handleSave: handleFormSave,
  };
};
