import {useManagerSingleUserFlagsQuery} from '@/hooks/useBaseQueries/flag/useManagerSingleUserFlagsQuery';
import {useSaveManagerFlagsMutation} from '@/hooks/useBaseQueries/flag/useSaveManagerFlagsMutation';
import {useSettingsToast} from '@/widgets/setting/hooks/useSettingsToast';
import {useFlagSave} from '../useFlagSave';
import {convertToManagerDriverSaveRequest} from './converters';
import {flagsFormSchema} from './schema';
import {useSettingForm} from '@/widgets/setting/hooks/useSettingForm';

type UseManagerDriverFlagFormParams = {
  userId: string;
};

/**
 * Manager用ドライバーフラグフォームのカスタムフック
 */
export const useManagerDriverFlagForm = ({userId}: UseManagerDriverFlagFormParams) => {
  const {data: flagsData, isLoading: isFetching} = useManagerSingleUserFlagsQuery({
    request: {userId},
    queryOptions: {refetchOnWindowFocus: false},
  });

  const {mutateAsync, isLoading: isMutationFetching, isSuccess, isError} = useSaveManagerFlagsMutation();

  useSettingsToast(isMutationFetching, isSuccess, isError);

  const {handleSave, seatLimitErrors, resetErrors} = useFlagSave({
    schema: flagsFormSchema,
    convertToRequest: valueMap => convertToManagerDriverSaveRequest(valueMap, userId),
    mutateAsync,
  });

  const {
    settingSections,
    hasChanges,
    hasErrors,
    isLoading,
    handleSave: handleFormSave,
  } = useSettingForm({
    flagDefines: flagsData?.flags.flagDefines ?? [],
    flagStatuses: flagsData?.flags.flagStatuses ?? [],
    flagPolicies: flagsData?.flags.flagPolicies ?? [],
    onSave: handleSave,
    isSaving: isMutationFetching,
    settingType: 'driver',
    userRole: 'manager',
  });

  return {
    driverId: flagsData?.flags.driverId ?? '',
    settingSections,
    hasChanges,
    hasErrors,
    isLoading,
    isFetching,
    handleSave: handleFormSave,
    seatLimitErrors,
    flagDefines: flagsData?.flags.flagDefines ?? [],
    resetErrors,
  };
};
