import { Test, TestingModule } from '@nestjs/testing';
import { Response } from 'express';
import { ApplicationsPresenter } from '../applicationsPresenter';

describe('ApplicationsPresenter', () => {
  let presenter: ApplicationsPresenter;
  let mockResponse: Partial<Response>;

  beforeEach(async () => {
    mockResponse = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn(),
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        ApplicationsPresenter,
        {
          provide: 'RESPONSE',
          useValue: mockResponse,
        },
      ],
    }).compile();

    presenter = module.get<ApplicationsPresenter>(ApplicationsPresenter);
  });

  it('presenterが正しく定義される', () => {
    expect(presenter).toBeDefined();
  });

  it('コンストラクタが正しくresponseを注入する', () => {
    const testResponse: Partial<Response> = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn(),
    };
    const testPresenter = new ApplicationsPresenter(testResponse as Response);

    expect(testPresenter).toBeDefined();
    expect(testPresenter['response']).toBe(testResponse);
  });

  it('DIコンテナを通じてRESPONSEトークンからresponseが注入される', () => {
    expect(presenter).toBeDefined();
    expect(presenter['response']).toBe(mockResponse);
  });

  describe('output', () => {
    it('ステータス200で正しいレスポンスを返す（空配列）', () => {
      const applications = [];
      presenter.output(applications);

      expect(mockResponse.status).toHaveBeenCalledWith(200);
      expect(mockResponse.json).toHaveBeenCalledWith({
        status: 'success',
        applications: [],
      });
    });

    it('ステータス200で正しいレスポンスを返す（1件）', () => {
      const applications = [
        {
          id: 'app-1',
          name: 'アプリケーション1',
        },
      ];
      presenter.output(applications);

      expect(mockResponse.status).toHaveBeenCalledWith(200);
      expect(mockResponse.json).toHaveBeenCalledWith({
        status: 'success',
        applications: [
          {
            id: 'app-1',
            name: 'アプリケーション1',
          },
        ],
      });
    });

    it('ステータス200で正しいレスポンスを返す（複数件）', () => {
      const applications = [
        {
          id: 'app-1',
          name: 'アプリケーション1',
        },
        {
          id: 'app-2',
          name: 'アプリケーション2',
        },
        {
          id: 'app-3',
          name: 'アプリケーション3',
        },
      ];
      presenter.output(applications);

      expect(mockResponse.status).toHaveBeenCalledWith(200);
      expect(mockResponse.json).toHaveBeenCalledWith({
        status: 'success',
        applications: [
          {
            id: 'app-1',
            name: 'アプリケーション1',
          },
          {
            id: 'app-2',
            name: 'アプリケーション2',
          },
          {
            id: 'app-3',
            name: 'アプリケーション3',
          },
        ],
      });
    });

    it('statusとjsonが正しい順序で呼び出される', () => {
      presenter.output([]);

      expect(mockResponse.status).toHaveBeenCalledTimes(1);
      expect(mockResponse.json).toHaveBeenCalledTimes(1);
    });

    it('複数回呼び出しても正しく動作する', () => {
      const applications1 = [{ id: 'app-1', name: 'アプリケーション1' }];
      const applications2 = [
        { id: 'app-2', name: 'アプリケーション2' },
        { id: 'app-3', name: 'アプリケーション3' },
      ];

      presenter.output(applications1);
      presenter.output(applications2);

      expect(mockResponse.status).toHaveBeenCalledTimes(2);
      expect(mockResponse.json).toHaveBeenCalledTimes(2);
      expect(mockResponse.status).toHaveBeenCalledWith(200);
      expect(mockResponse.json).toHaveBeenLastCalledWith({
        status: 'success',
        applications: applications2,
      });
    });

    it('日本語名を含むアプリケーション名が正しく処理される', () => {
      const applications = [
        {
          id: 'app-1',
          name: '配送管理アプリケーション',
        },
        {
          id: 'app-2',
          name: '在庫管理システム',
        },
      ];
      presenter.output(applications);

      expect(mockResponse.json).toHaveBeenCalledWith({
        status: 'success',
        applications: [
          {
            id: 'app-1',
            name: '配送管理アプリケーション',
          },
          {
            id: 'app-2',
            name: '在庫管理システム',
          },
        ],
      });
    });

    it('特殊文字を含むアプリケーション名が正しく処理される', () => {
      const applications = [
        {
          id: 'app-1',
          name: 'アプリ&テスト',
        },
        {
          id: 'app-2',
          name: '<Script>Test</Script>',
        },
      ];
      presenter.output(applications);

      expect(mockResponse.json).toHaveBeenCalledWith({
        status: 'success',
        applications: [
          {
            id: 'app-1',
            name: 'アプリ&テスト',
          },
          {
            id: 'app-2',
            name: '<Script>Test</Script>',
          },
        ],
      });
    });
  });
});
