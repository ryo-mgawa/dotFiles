import { ShipmentConverter } from '../shipmentConverter';

describe('ShipmentConverter', () => {
  let converter: ShipmentConverter;

  beforeEach(() => {
    converter = new ShipmentConverter();
  });

  describe('convertToInsert', () => {
    it('ShipmentRepositoryInputをShipmentInsertに変換できる', () => {
      const organizationId = 'test-org-1';
      const shipments = [
        {
          id: 'shipment-001',
          slipId: 'slip-001',
          consignor: { id: 'consignor-1', name: '発荷主A' },
          consignee: { id: 'consignee-1', name: '着荷主A' },
          originSpotId: 'spot-origin-1',
          destinationSpotId: 'spot-dest-1',
          meta: { note: 'テスト' },
        },
      ];

      const result = converter.convertToInsert(organizationId, shipments);

      expect(result).toHaveLength(1);
      expect(result[0]).toEqual({
        id: 'shipment-001',
        organization_id: 'test-org-1',
        slip_id: 'slip-001',
        consignor: JSON.stringify({ id: 'consignor-1', name: '発荷主A' }),
        consignee: JSON.stringify({ id: 'consignee-1', name: '着荷主A' }),
        origin_spot_id: 'spot-origin-1',
        destination_spot_id: 'spot-dest-1',
        meta: JSON.stringify({ note: 'テスト' }),
      });
    });

    it('metaがundefinedの場合はnullをJSON化する', () => {
      const organizationId = 'test-org-1';
      const shipments = [
        {
          id: 'shipment-002',
          slipId: 'slip-002',
          consignor: { id: 'consignor-2', name: '発荷主B' },
          consignee: { id: 'consignee-2', name: '着荷主B' },
          originSpotId: 'spot-origin-2',
          destinationSpotId: 'spot-dest-2',
        },
      ];

      const result = converter.convertToInsert(organizationId, shipments);

      expect(result).toHaveLength(1);
      expect(result[0].meta).toBe(JSON.stringify(null));
    });

    it('複数のshipmentを一度に変換できる', () => {
      const organizationId = 'test-org-1';
      const shipments = [
        {
          id: 'shipment-001',
          slipId: 'slip-001',
          consignor: { id: 'consignor-1', name: '発荷主A' },
          consignee: { id: 'consignee-1', name: '着荷主A' },
          originSpotId: 'spot-origin-1',
          destinationSpotId: 'spot-dest-1',
        },
        {
          id: 'shipment-002',
          slipId: 'slip-002',
          consignor: { id: 'consignor-2', name: '発荷主B' },
          consignee: { id: 'consignee-2', name: '着荷主B' },
          originSpotId: 'spot-origin-2',
          destinationSpotId: 'spot-dest-2',
        },
      ];

      const result = converter.convertToInsert(organizationId, shipments);

      expect(result).toHaveLength(2);
      expect(result[0].id).toBe('shipment-001');
      expect(result[1].id).toBe('shipment-002');
    });

    it('空配列を渡すと空配列が返る', () => {
      const organizationId = 'test-org-1';
      const shipments = [];

      const result = converter.convertToInsert(organizationId, shipments);

      expect(result).toEqual([]);
    });
  });
});
