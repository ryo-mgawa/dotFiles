# リモートパトランプ/LED制御システム

キーボードショートカットを押すと、別のネットワーク上にあるパトランプやLEDが光るシステムの設計書

## 概要

このシステムは、PC上でキーボードショートカットを検知し、インターネット経由で遠隔地にあるパトランプやLEDを制御するリアルタイム通信システムです。

## システム構成

```
┌─────────────┐      ┌─────────────────┐      ┌──────────────────┐
│   PC側      │      │  クラウド/      │      │   受信側         │
│ (送信側)    │─────▶│  サーバー       │─────▶│ (デバイス側)     │
└─────────────┘      └─────────────────┘      └──────────────────┘
   ショートカット        通信の仲介              パトランプ/LED
   検知プログラム        (Firebase等)            制御装置
```

## 構成要素

### 1. PC側（送信側）

**機能**
- キーボードショートカットの検知
- インターネット経由での信号送信

**実装技術の選択肢**
- **Python**: `pynput` または `keyboard` ライブラリ
- **Node.js**: `electron` + `globalShortcut` API
- **Electron**: デスクトップアプリとして実装

**処理フロー**
1. グローバルキーボードフックの登録
2. ショートカット検知
3. API/WebSocket/MQTTで信号送信
4. 送信結果の確認（オプション）

### 2. 通信層

#### オプションA: クラウドサービス（推奨）

| サービス | メリット | デメリット |
|---------|---------|-----------|
| **Firebase Realtime Database** | 簡単、リアルタイム、認証機能あり | 従量課金 |
| **Supabase** | オープンソース、PostgreSQL、無料枠が大きい | Firebaseより複雑 |
| **PubNub** | 専用のリアルタイム通信、低遅延 | 有料プランが必要 |

#### オプションB: 自前サーバー

| 方式 | メリット | デメリット |
|-----|---------|-----------|
| **HTTP + ngrok** | シンプル、デバッグしやすい | 遅延が大きい |
| **WebSocket** | 双方向通信、低遅延 | サーバー管理が必要 |
| **MQTT** | 軽量、IoT向け | ブローカーの設定が必要 |

#### オプションC: P2P通信

- **WebRTC**: 最も低遅延だが実装が複雑

### 3. 受信側（デバイス側）

#### ハードウェアの選択肢

| デバイス | 価格帯 | メリット | 用途 |
|---------|-------|---------|------|
| **ESP32** | 500-1000円 | WiFi内蔵、低価格、省電力 | LED制御に最適 |
| **Raspberry Pi Zero W** | 2000-3000円 | Linux、豊富なライブラリ | 複雑な処理が必要な場合 |
| **Raspberry Pi 4** | 5000-8000円 | 高性能、周辺機器接続可 | 画面表示など追加機能 |
| **Arduino + WiFiモジュール** | 2000-3000円 | 安定動作 | シンプルなLED制御 |

#### パトランプ/LED接続

**小型LED（5V）**
- 直接GPIO接続可能
- 抵抗器（220Ω程度）を挟む

**パトランプ（AC100V/DC12V-24V）**
- リレーモジュール経由で制御
- 推奨: ソリッドステートリレー（SSR）
- 安全のため、電気工事士の資格保有者に依頼推奨

#### ソフトウェア実装
- **ESP32**: Arduino IDE / PlatformIO
- **Raspberry Pi**: Python / Node.js

## 実装パターン

### パターン1: 最もシンプル（Firebase + ESP32）

```
PC (Python)
  ↓ pynput でショートカット検知
  ↓ Firebase Admin SDK で書き込み
Firebase Realtime Database
  ↓ リアルタイムDB監視
ESP32 (Arduino)
  ↓ GPIO制御
LED点灯
```

**メリット**
- サーバー不要
- 認証・暗号化がFirebaseに任せられる
- スケーラブル

**デメリット**
- Firebase の従量課金（無料枠: 同時接続100、1GB/月）
- インターネット接続必須

### パターン2: 自前サーバー（Node.js + WebSocket）

```
PC (Electron)
  ↓ HTTP POST
自前Node.jsサーバー (ngrok経由)
  ↓ WebSocket
ESP32/Raspberry Pi
  ↓ GPIO
パトランプ点灯
```

**メリット**
- 完全にコントロール可能
- 月額費用なし（サーバー代除く）

**デメリット**
- サーバー管理が必要
- セキュリティ対策を自分で実装

### パターン3: MQTT（軽量IoT向け）

```
PC (Python/Node.js)
  ↓ MQTT Publish
MQTT Broker (Mosquitto等)
  ↓ MQTT Subscribe
ESP32/Raspberry Pi
  ↓ GPIO
LED制御
```

**メリット**
- 軽量で低遅延
- 複数デバイスへの配信が容易
- IoT標準プロトコル

**デメリット**
- ブローカーの設定・管理が必要
- HTTPより複雑

## 技術的考慮事項

### 1. 遅延

| 通信方式 | 想定遅延 |
|---------|---------|
| 同一LAN内 | 10-50ms |
| インターネット経由（国内） | 100-500ms |
| インターネット経由（海外） | 500ms-数秒 |

### 2. セキュリティ

**必須対策**
- 認証トークンの使用
- HTTPS/WSS（暗号化通信）
- APIキーの環境変数管理
- レート制限

**推奨対策**
- IPホワイトリスト
- ログ監視
- 異常検知（頻繁な点灯など）

### 3. 安定性

**対策項目**
- 接続断の自動再接続
- ハートビート（死活監視）
- エラーハンドリング
- ローカルログ保存

### 4. 電源・ハードウェア

**ESP32/Raspberry Pi**
- 安定した5V電源供給（USB電源アダプタ推奨）
- 突入電流対策（コンデンサ）

**パトランプ**
- AC100Vの場合は電気工事士による配線
- DC12V/24Vの場合は専用電源が必要
- リレー容量の確認

## 開発ステップ

### Phase 1: プロトタイプ（ローカル確認）

1. PC側プログラムでショートカット検知
2. ローカルネットワーク内でHTTPリクエスト送信
3. Raspberry Pi/ESP32でHTTPサーバー起動
4. LEDを点灯（GPIO制御）

### Phase 2: クラウド接続

1. Firebaseプロジェクト作成
2. PC側からFirebaseに書き込み
3. デバイス側でFirebaseを監視
4. 動作確認

### Phase 3: 本番環境

1. セキュリティ強化（認証・暗号化）
2. エラーハンドリング実装
3. 安定性テスト
4. パトランプへの接続（必要に応じて）

### Phase 4: 改善

1. 応答速度の計測・改善
2. UI/UX改善（設定画面など）
3. 複数デバイス対応
4. ログ・監視機能

## 必要な予算（概算）

| 項目 | 金額 |
|-----|------|
| ESP32開発ボード | 500-1000円 |
| リレーモジュール | 300-500円 |
| LED/パトランプ | 500-5000円 |
| 電源アダプタ | 500-1000円 |
| ブレッドボード・配線材 | 1000円 |
| **合計（最小構成）** | **3000-8000円** |

クラウドサービス利用の場合、Firebaseの無料枠内で運用可能。

## サンプルコード構成（予定）

```
callSystem/
├── pc-client/          # PC側プログラム
│   ├── python/         # Python実装
│   └── electron/       # Electron実装
├── device/             # デバイス側プログラム
│   ├── esp32/          # ESP32 (Arduino)
│   └── raspberry-pi/   # Raspberry Pi (Python)
├── server/             # 自前サーバー実装（オプション）
│   └── nodejs/         # Node.js + WebSocket
└── docs/               # ドキュメント
    ├── setup.md        # セットアップ手順
    └── troubleshooting.md  # トラブルシューティング
```

## 参考リンク

- [Firebase Realtime Database](https://firebase.google.com/docs/database)
- [ESP32 公式ドキュメント](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/)
- [Raspberry Pi 公式](https://www.raspberrypi.org/)
- [pynput (Python キーボードライブラリ)](https://pynput.readthedocs.io/)

## ライセンス

TBD

## 作成者

TBD
