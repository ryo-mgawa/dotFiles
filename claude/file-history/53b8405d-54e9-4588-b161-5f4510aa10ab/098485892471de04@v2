# アーキテクチャ設計書

本ドキュメントでは、拠点間ビデオ通話Webアプリケーションのシステム構造とデータフローをクラス図・シーケンス図で説明します。

## 1. 全体アーキテクチャ

```mermaid
graph TB
    subgraph "Frontend (React)"
        Pages[Pages]
        Features[Features]
        Shared[Shared]
    end

    subgraph "Backend (Express)"
        Routes[Routes/Controllers]
        UseCases[Use Cases]
        Services[Services]
        Repositories[Repositories]
    end

    subgraph "External Services"
        DB[(Supabase/PostgreSQL)]
        ZoomSDK[Zoom Video SDK]
    end

    Pages --> Features
    Features --> Shared
    Features --> |HTTP/REST| Routes
    Routes --> UseCases
    UseCases --> Services
    UseCases --> Repositories
    Repositories --> DB
    Services --> |JWT生成| ZoomSDK
    Features --> |WebRTC| ZoomSDK
```

## 2. ドメインモデル（エンティティ関連図）

```mermaid
erDiagram
    Company ||--o{ Site : "1:N"
    Company ||--o{ User : "1:N"
    Company ||--o{ Session : "1:N"
    Company ||--o{ OperatingSchedule : "1:N"
    Company ||--o{ OperatingScheduleException : "1:N"

    Site ||--o{ User : "1:N"
    Site ||--o| SiteDevice : "1:1"
    Site ||--o{ SessionParticipant : "1:N"

    Session ||--o{ SessionParticipant : "1:N"

    Company {
        string id PK
        string name
        string timezone
        datetime createdAt
        datetime updatedAt
    }

    Site {
        string id PK
        string companyId FK
        string name
        string accessToken
        datetime createdAt
        datetime updatedAt
    }

    User {
        string id PK
        string companyId FK
        string siteId FK
        string email
        string passwordHash
        string name
        enum role "admin|user"
        datetime createdAt
        datetime updatedAt
    }

    SiteDevice {
        string id PK
        string siteId FK
        string deviceId
        datetime registeredAt
    }

    Session {
        string id PK
        string companyId FK
        string sessionName
        datetime startedAt
        datetime endedAt
    }

    SessionParticipant {
        string id PK
        string sessionId FK
        string siteId FK
        datetime joinedAt
        datetime leftAt
    }

    OperatingSchedule {
        string id PK
        string companyId FK
        int dayOfWeek "0-6"
        time startTime
        time endTime
        boolean isEnabled
    }

    OperatingScheduleException {
        string id PK
        string companyId FK
        date date
        enum exceptionType "holiday|closed|custom"
        time startTime
        time endTime
        string description
    }
```

## 3. バックエンド クラス図

### 3.1 リポジトリ層

```mermaid
classDiagram
    direction TB

    class IUserRepository {
        <<interface>>
        +findById(id: string) User
        +findByEmail(email: string) User
        +findBySiteId(siteId: string) User[]
        +create(data: CreateUserData) User
        +update(id: string, data: UpdateUserData) User
    }

    class ICompanyRepository {
        <<interface>>
        +findById(id: string) Company
        +findAll() Company[]
        +create(data: CreateCompanyData) Company
    }

    class ISiteRepository {
        <<interface>>
        +findById(id: string) Site
        +findByAccessToken(token: string) Site
        +findByCompanyId(companyId: string) Site[]
        +create(data: CreateSiteData) Site
        +update(id: string, data: UpdateSiteData) Site
    }

    class ISiteDeviceRepository {
        <<interface>>
        +findBySiteId(siteId: string) SiteDevice
        +create(siteId: string, deviceId: string) SiteDevice
        +delete(siteId: string) void
    }

    class ISessionRepository {
        <<interface>>
        +findById(id: string) Session
        +findActiveByCompanyId(companyId: string) Session
        +create(data: CreateSessionData) Session
        +addParticipant(sessionId: string, siteId: string) void
        +removeParticipant(sessionId: string, siteId: string) void
        +getParticipants(sessionId: string) SessionParticipant[]
        +endSession(sessionId: string) void
    }

    class IScheduleRepository {
        <<interface>>
        +findByCompanyId(companyId: string) OperatingSchedule[]
        +findByCompanyIdAndDayOfWeek(companyId: string, day: number) OperatingSchedule
        +findExceptionByDate(companyId: string, date: Date) OperatingScheduleException
        +upsertSchedule(data: ScheduleData) OperatingSchedule
        +createException(data: ExceptionData) OperatingScheduleException
        +deleteException(id: string) void
    }

    class PrismaUserRepository {
        -prisma: PrismaClient
        +findById(id: string) User
        +findByEmail(email: string) User
    }

    class PrismaSiteRepository {
        -prisma: PrismaClient
        +findById(id: string) Site
        +findByAccessToken(token: string) Site
    }

    IUserRepository <|.. PrismaUserRepository
    ISiteRepository <|.. PrismaSiteRepository
```

### 3.2 ユースケース層

```mermaid
classDiagram
    direction TB

    class LoginUseCase {
        -userRepository: IUserRepository
        -companyRepository: ICompanyRepository
        +execute(input: LoginRequestDto) LoginResponseDto
    }

    class SiteAuthUseCase {
        -siteRepository: ISiteRepository
        -companyRepository: ICompanyRepository
        -siteDeviceRepository: ISiteDeviceRepository
        -zoomJwtService: ZoomJwtService
        +execute(input: SiteAuthRequestDto) SiteAuthResponseDto
    }

    class JoinSessionUseCase {
        -sessionRepository: ISessionRepository
        -siteRepository: ISiteRepository
        -zoomJwtService: ZoomJwtService
        +execute(input: JoinSessionRequestDto) JoinSessionResponseDto
    }

    class LeaveSessionUseCase {
        -sessionRepository: ISessionRepository
        +execute(input: LeaveSessionRequestDto) LeaveSessionResponseDto
    }

    class CheckOperatingHoursUseCase {
        -operatingHoursService: OperatingHoursService
        +execute(input: CheckOperatingHoursInput) GetStatusResponseDto
    }

    class UpdateScheduleUseCase {
        -scheduleRepository: IScheduleRepository
        +execute(input: UpdateScheduleInput) ScheduleResponseDto
    }

    LoginUseCase --> IUserRepository
    LoginUseCase --> ICompanyRepository
    SiteAuthUseCase --> ISiteRepository
    SiteAuthUseCase --> ICompanyRepository
    SiteAuthUseCase --> ISiteDeviceRepository
    SiteAuthUseCase --> ZoomJwtService
    JoinSessionUseCase --> ISessionRepository
    JoinSessionUseCase --> ZoomJwtService
    LeaveSessionUseCase --> ISessionRepository
    CheckOperatingHoursUseCase --> OperatingHoursService
```

### 3.3 サービス層

```mermaid
classDiagram
    direction TB

    class ZoomJwtService {
        -sdkKey: string
        -sdkSecret: string
        -expiresIn: number
        +generateSessionTopic(companyId: string) string
        +generateJwt(input: GenerateZoomJwtInput) string
        +getExpiresIn() number
    }

    class OperatingHoursService {
        -scheduleRepository: IScheduleRepository
        -companyRepository: ICompanyRepository
        +checkOperatingStatus(companyId: string) OperatingStatus
        +getWarningThresholdMinutes() number
        -handleException(exception, now, currentTime) OperatingStatus
        -checkTimeRange(schedule, now, currentTime, companyId) OperatingStatus
        -findNextOperatingDay(companyId, fromDate) NextOperatingDay
        -getCurrentTimeInTimezone(timezone: string) Date
    }

    class OperatingStatus {
        +isOperating: boolean
        +currentTime: string
        +todaySchedule: Schedule
        +remainingMinutes: number
        +reason: string
        +nextOperatingDay: string
        +nextStartTime: string
    }

    OperatingHoursService --> IScheduleRepository
    OperatingHoursService --> ICompanyRepository
    OperatingHoursService ..> OperatingStatus
```

## 4. フロントエンド クラス図

### 4.1 デザインパターン

```mermaid
classDiagram
    direction TB

    %% Observer Pattern
    class VideoSessionObserver {
        <<interface>>
        +onSessionEvent(event: VideoSessionEvent) void
    }

    class VideoSessionSubject {
        -observers: Set~VideoSessionObserver~
        +subscribe(observer: VideoSessionObserver) unsubscribe
        +notify(event: VideoSessionEvent) void
        +clear() void
    }

    class VideoSessionEvent {
        +type: EventType
        +participant: Participant
        +timestamp: Date
    }

    VideoSessionSubject --> VideoSessionObserver
    VideoSessionSubject ..> VideoSessionEvent

    %% Facade Pattern
    class ZoomVideoFacade {
        -client: VideoClient
        -mediaStream: Stream
        -sessionSubject: VideoSessionSubject
        +joinSession(config: SessionConfig) void
        +leaveSession() void
        +toggleMicrophone() boolean
        +toggleCamera() boolean
        +setParticipantVolume(id, volume) void
        +getParticipants() Participant[]
        +subscribe(observer) unsubscribe
        +attachVideo(participantId, container) void
        +detachVideo(participantId, container) void
    }

    ZoomVideoFacade --> VideoSessionSubject
    ZoomVideoFacade --> VideoClient : uses
    ZoomVideoFacade --> Stream : uses

    %% Operating Hours Observer
    class OperatingHoursObserver {
        <<interface>>
        +onOperatingStatusChange(status: OperatingStatus) void
    }

    class OperatingHoursSubject {
        -observers: Set~OperatingHoursObserver~
        +subscribe(observer: OperatingHoursObserver) unsubscribe
        +notify(status: OperatingStatus) void
    }

    OperatingHoursSubject --> OperatingHoursObserver
```

### 4.2 コンポーネント構造

```mermaid
graph TB
    subgraph "Pages"
        LoginPage
        SiteAuthPage
        VideoCallPage
        SchedulePage
    end

    subgraph "Features"
        subgraph "auth"
            LoginForm
            AuthContext
        end

        subgraph "video-call"
            VideoGrid
            MainVideo
            SubVideos
            SelfView
            ControlPanel
            ZoomVideoFacade
        end

        subgraph "operating-hours"
            OperatingHoursProvider
            OperatingHoursWarning
        end
    end

    subgraph "Shared"
        Button
        Card
        Modal
        useKeyboardShortcut
    end

    LoginPage --> LoginForm
    SiteAuthPage --> AuthContext
    VideoCallPage --> VideoGrid
    VideoCallPage --> OperatingHoursProvider
    VideoGrid --> MainVideo
    VideoGrid --> SubVideos
    VideoGrid --> SelfView
    VideoGrid --> ControlPanel
    VideoGrid --> ZoomVideoFacade
    ControlPanel --> Button
    OperatingHoursProvider --> OperatingHoursWarning
```

## 5. シーケンス図

### 5.1 拠点トークン認証フロー

```mermaid
sequenceDiagram
    autonumber
    participant Browser as ブラウザ
    participant Frontend as フロントエンド
    participant API as API Server
    participant UseCase as SiteAuthUseCase
    participant SiteRepo as SiteRepository
    participant DeviceRepo as SiteDeviceRepository
    participant ZoomService as ZoomJwtService
    participant DB as Database

    Browser->>Frontend: /site/{accessToken} にアクセス
    Frontend->>Frontend: LocalStorageからdeviceIdを取得
    Frontend->>API: POST /api/auth/site {accessToken, deviceId}
    API->>UseCase: execute(accessToken, deviceId)

    UseCase->>SiteRepo: findByAccessToken(accessToken)
    SiteRepo->>DB: SELECT * FROM Site WHERE accessToken = ?
    DB-->>SiteRepo: Site
    SiteRepo-->>UseCase: Site

    alt デバイスID未提供
        UseCase->>DeviceRepo: findBySiteId(siteId)
        DeviceRepo->>DB: SELECT * FROM SiteDevice
        DB-->>DeviceRepo: null
        UseCase->>UseCase: 新しいdeviceIdを生成
        UseCase->>DeviceRepo: create(siteId, deviceId)
        DeviceRepo->>DB: INSERT INTO SiteDevice
    else デバイスID提供済み
        UseCase->>DeviceRepo: findBySiteId(siteId)
        DeviceRepo->>DB: SELECT * FROM SiteDevice
        DB-->>DeviceRepo: SiteDevice

        alt デバイスID不一致
            UseCase-->>API: AuthenticationError
            API-->>Frontend: 401 Unauthorized
        end
    end

    UseCase->>ZoomService: generateSessionTopic(companyId)
    ZoomService-->>UseCase: topic
    UseCase->>ZoomService: generateJwt({topic, role})
    ZoomService-->>UseCase: zoomJwt

    UseCase-->>API: SiteAuthResponseDto
    API-->>Frontend: {site, company, deviceId, zoomJwt}
    Frontend->>Frontend: LocalStorageにdeviceIdを保存
    Frontend->>Browser: ビデオ通話画面へ遷移
```

### 5.2 ユーザーログイン認証フロー

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant Frontend as フロントエンド
    participant API as API Server
    participant UseCase as LoginUseCase
    participant UserRepo as UserRepository
    participant CompanyRepo as CompanyRepository
    participant DB as Database

    User->>Frontend: メールアドレス/パスワード入力
    Frontend->>API: POST /api/auth/login {email, password}
    API->>UseCase: execute({email, password})

    UseCase->>UserRepo: findByEmail(email)
    UserRepo->>DB: SELECT * FROM User WHERE email = ?
    DB-->>UserRepo: User
    UserRepo-->>UseCase: User

    alt ユーザーが存在しない
        UseCase-->>API: AuthenticationError
        API-->>Frontend: 401 Unauthorized
        Frontend-->>User: エラーメッセージ表示
    end

    UseCase->>UseCase: comparePassword(password, passwordHash)

    alt パスワード不一致
        UseCase-->>API: AuthenticationError
        API-->>Frontend: 401 Unauthorized
        Frontend-->>User: エラーメッセージ表示
    end

    UseCase->>CompanyRepo: findById(user.companyId)
    CompanyRepo->>DB: SELECT * FROM Company WHERE id = ?
    DB-->>CompanyRepo: Company
    CompanyRepo-->>UseCase: Company

    UseCase->>UseCase: generateAppToken({id, companyId, siteId, role})

    UseCase-->>API: LoginResponseDto
    API-->>Frontend: {user, company, accessToken}
    Frontend->>Frontend: トークンを保存
    Frontend-->>User: ダッシュボードへ遷移
```

### 5.3 セッション参加フロー

```mermaid
sequenceDiagram
    autonumber
    participant Frontend as フロントエンド
    participant API as API Server
    participant OperatingUC as CheckOperatingHoursUseCase
    participant JoinUC as JoinSessionUseCase
    participant SessionRepo as SessionRepository
    participant ZoomService as ZoomJwtService
    participant ZoomFacade as ZoomVideoFacade
    participant ZoomSDK as Zoom Video SDK

    Frontend->>API: GET /api/schedules/status
    API->>OperatingUC: execute({companyId})
    OperatingUC-->>API: {isOperating: true, ...}
    API-->>Frontend: 稼働状態

    alt 稼働時間外
        Frontend-->>Frontend: エラー表示・参加不可
    end

    Frontend->>API: POST /api/sessions/join {siteId}
    API->>JoinUC: execute({companyId, siteId})

    JoinUC->>SessionRepo: findActiveByCompanyId(companyId)

    alt セッションが存在しない
        JoinUC->>SessionRepo: create({companyId, sessionName})
    end

    JoinUC->>SessionRepo: addParticipant(sessionId, siteId)
    JoinUC->>ZoomService: generateJwt({topic, role})
    ZoomService-->>JoinUC: zoomJwt

    JoinUC-->>API: {sessionId, topic, jwt}
    API-->>Frontend: JoinSessionResponseDto

    Frontend->>ZoomFacade: joinSession({topic, token, userName})
    ZoomFacade->>ZoomSDK: createClient()
    ZoomFacade->>ZoomSDK: init()
    ZoomFacade->>ZoomSDK: join(topic, token, userName)
    ZoomSDK-->>ZoomFacade: 接続完了
    ZoomFacade->>ZoomFacade: setupEventListeners()
    ZoomFacade-->>Frontend: 参加完了

    Frontend->>ZoomFacade: toggleCamera()
    ZoomFacade->>ZoomSDK: startVideo()

    Frontend->>ZoomFacade: toggleMicrophone()
    ZoomFacade->>ZoomSDK: startAudio()
```

### 5.4 セッション離脱フロー

```mermaid
sequenceDiagram
    autonumber
    participant Frontend as フロントエンド
    participant ZoomFacade as ZoomVideoFacade
    participant ZoomSDK as Zoom Video SDK
    participant API as API Server
    participant UseCase as LeaveSessionUseCase
    participant SessionRepo as SessionRepository
    participant DB as Database

    alt 手動離脱
        Frontend->>Frontend: 離脱ボタンクリック
    else 稼働時間終了
        Frontend->>Frontend: OperatingHoursObserverから通知
    end

    Frontend->>ZoomFacade: leaveSession()
    ZoomFacade->>ZoomSDK: stopVideo()
    ZoomFacade->>ZoomSDK: stopAudio()
    ZoomFacade->>ZoomSDK: leave()
    ZoomFacade->>ZoomFacade: cleanup()
    ZoomFacade-->>Frontend: 完了

    Frontend->>API: POST /api/sessions/leave {sessionId, siteId}
    API->>UseCase: execute({sessionId, siteId, companyId})

    UseCase->>SessionRepo: findById(sessionId)
    SessionRepo->>DB: SELECT * FROM Session
    DB-->>SessionRepo: Session

    UseCase->>SessionRepo: removeParticipant(sessionId, siteId)
    SessionRepo->>DB: UPDATE SessionParticipant SET leftAt = NOW()

    UseCase->>SessionRepo: getParticipants(sessionId)
    SessionRepo->>DB: SELECT * FROM SessionParticipant WHERE leftAt IS NULL
    DB-->>SessionRepo: participants[]

    alt 参加者が0人
        UseCase->>SessionRepo: endSession(sessionId)
        SessionRepo->>DB: UPDATE Session SET endedAt = NOW()
    end

    UseCase-->>API: {success: true}
    API-->>Frontend: LeaveSessionResponseDto
```

### 5.5 稼働時間チェックフロー

```mermaid
sequenceDiagram
    autonumber
    participant Frontend as フロントエンド
    participant Provider as OperatingHoursProvider
    participant API as API Server
    participant UseCase as CheckOperatingHoursUseCase
    participant Service as OperatingHoursService
    participant ScheduleRepo as ScheduleRepository
    participant CompanyRepo as CompanyRepository
    participant DB as Database

    Frontend->>Provider: マウント時
    Provider->>Provider: ポーリング開始（1分間隔）

    loop 毎分実行
        Provider->>API: GET /api/schedules/status
        API->>UseCase: execute({companyId})
        UseCase->>Service: checkOperatingStatus(companyId)

        Service->>CompanyRepo: findById(companyId)
        CompanyRepo->>DB: SELECT * FROM Company
        DB-->>CompanyRepo: Company（timezone含む）
        CompanyRepo-->>Service: Company

        Service->>Service: getCurrentTimeInTimezone(timezone)

        Service->>ScheduleRepo: findExceptionByDate(companyId, now)
        ScheduleRepo->>DB: SELECT * FROM OperatingScheduleException
        DB-->>ScheduleRepo: Exception or null

        alt 例外日あり（祝日・休業）
            Service-->>UseCase: {isOperating: false, reason: 'holiday'}
        else 例外日あり（カスタム稼働）
            Service->>Service: checkTimeRange(exception.startTime, exception.endTime)
        else 例外日なし
            Service->>ScheduleRepo: findByCompanyIdAndDayOfWeek(companyId, dayOfWeek)
            ScheduleRepo->>DB: SELECT * FROM OperatingSchedule
            DB-->>ScheduleRepo: Schedule

            alt スケジュールが無効
                Service-->>UseCase: {isOperating: false, reason: 'day_off'}
            else 時間範囲内
                Service-->>UseCase: {isOperating: true, remainingMinutes: N}
            else 時間範囲外
                Service-->>UseCase: {isOperating: false, reason: 'outside_hours'}
            end
        end

        UseCase-->>API: GetStatusResponseDto
        API-->>Provider: {isOperating, remainingMinutes, warningThresholdMinutes}

        alt remainingMinutes <= warningThresholdMinutes
            Provider->>Frontend: 警告通知表示
        end

        alt isOperating == false かつ セッション中
            Provider->>Frontend: 自動離脱トリガー
        end
    end
```

## 6. デプロイメントアーキテクチャ

```mermaid
graph TB
    subgraph "Client"
        Browser[ブラウザ<br/>4K縦向きディスプレイ]
    end

    subgraph "Vercel"
        Frontend[フロントエンド<br/>React SPA]
        API[API Functions<br/>Express]
    end

    subgraph "Supabase"
        DB[(PostgreSQL)]
    end

    subgraph "Zoom"
        ZoomCloud[Zoom Video SDK<br/>WebRTC]
    end

    Browser -->|HTTPS| Frontend
    Browser -->|HTTPS| API
    Browser <-->|WebRTC| ZoomCloud
    API -->|Prisma| DB
    API -->|JWT生成| ZoomCloud
```

## 7. 状態管理

### 7.1 認証状態

```mermaid
stateDiagram-v2
    [*] --> Unauthenticated: 初期状態

    Unauthenticated --> SiteAuthenticated: 拠点トークン認証成功
    Unauthenticated --> UserAuthenticated: ユーザーログイン成功

    SiteAuthenticated --> InSession: セッション参加
    SiteAuthenticated --> Unauthenticated: トークン無効/期限切れ

    UserAuthenticated --> Unauthenticated: ログアウト
    UserAuthenticated --> Unauthenticated: トークン期限切れ

    InSession --> SiteAuthenticated: セッション離脱
    InSession --> Unauthenticated: 強制切断
```

### 7.2 ビデオセッション状態

```mermaid
stateDiagram-v2
    [*] --> Disconnected: 初期状態

    Disconnected --> Connecting: joinSession()
    Connecting --> Connected: 接続成功
    Connecting --> Error: 接続失敗

    Connected --> MediaReady: setupEventListeners()
    MediaReady --> AudioEnabled: startAudio()
    MediaReady --> VideoEnabled: startVideo()
    AudioEnabled --> VideoEnabled: startVideo()
    VideoEnabled --> AudioEnabled: stopVideo()

    Connected --> Disconnecting: leaveSession()
    MediaReady --> Disconnecting: leaveSession()
    AudioEnabled --> Disconnecting: leaveSession()
    VideoEnabled --> Disconnecting: leaveSession()

    Disconnecting --> Disconnected: cleanup()
    Error --> Disconnected: リトライ/リセット
```
