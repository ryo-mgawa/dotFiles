import { UserContextTypes } from '@app/requestContext';
import { Test, TestingModule } from '@nestjs/testing';
import { AddShipmentsUseCase } from '../../../../application/useCase/addShipmentsUseCase';
import { AddShipmentsController } from '../addShipmentsController';
import { AddShipmentsInput } from '../../dto/addShipments/input';

describe('AddShipmentsController', () => {
  let controller: AddShipmentsController;
  let useCase: AddShipmentsUseCase;

  const mockUser: UserContextTypes = {
    userId: 'test-user-id',
    organizationId: 'test-org-id',
    role: 'PAAS',
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AddShipmentsController],
      providers: [
        {
          provide: AddShipmentsUseCase,
          useValue: {
            execute: jest.fn(),
          },
        },
      ],
    }).compile();

    controller = module.get<AddShipmentsController>(AddShipmentsController);
    useCase = module.get<AddShipmentsUseCase>(AddShipmentsUseCase);
  });

  it('コントローラーが正しく定義される', () => {
    expect(controller).toBeDefined();
  });

  it('コンストラクタが正しくuseCaseを注入する', () => {
    const testUseCase = {
      execute: jest.fn(),
    } as any;
    const testController = new AddShipmentsController(testUseCase);

    expect(testController).toBeDefined();
    expect(testController['addShipmentsUseCase']).toBe(testUseCase);
  });

  describe('addShipments', () => {
    it('useCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentsInput = {
        shipments: [
          {
            slipId: 'slip-001',
            consignor: {
              id: 'consignor-001',
              name: '荷主A',
            },
            consignee: {
              id: 'consignee-001',
              name: '荷受人A',
            },
            originSpot: {
              id: 'spot-001',
            },
            destinationSpot: {
              id: 'spot-002',
            },
            meta: { key: 'value' },
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipments(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          shipments: [
            {
              slipId: 'slip-001',
              consignor: {
                id: 'consignor-001',
                name: '荷主A',
              },
              consignee: {
                id: 'consignee-001',
                name: '荷受人A',
              },
              originSpotId: 'spot-001',
              destinationSpotId: 'spot-002',
              meta: { key: 'value' },
            },
          ],
        },
        'test-org-id',
      );
    });

    it('metaがない場合でもuseCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentsInput = {
        shipments: [
          {
            slipId: 'slip-002',
            consignor: {
              id: 'consignor-002',
              name: '荷主B',
            },
            consignee: {
              id: 'consignee-002',
              name: '荷受人B',
            },
            originSpot: {
              id: 'spot-003',
            },
            destinationSpot: {
              id: 'spot-004',
            },
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipments(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          shipments: [
            {
              slipId: 'slip-002',
              consignor: {
                id: 'consignor-002',
                name: '荷主B',
              },
              consignee: {
                id: 'consignee-002',
                name: '荷受人B',
              },
              originSpotId: 'spot-003',
              destinationSpotId: 'spot-004',
              meta: undefined,
            },
          ],
        },
        'test-org-id',
      );
    });

    it('複数のshipmentsがある場合でもuseCase.executeが正しいパラメータで呼び出される', async () => {
      const input: AddShipmentsInput = {
        shipments: [
          {
            slipId: 'slip-001',
            consignor: {
              id: 'consignor-001',
              name: '荷主A',
            },
            consignee: {
              id: 'consignee-001',
              name: '荷受人A',
            },
            originSpot: {
              id: 'spot-001',
            },
            destinationSpot: {
              id: 'spot-002',
            },
            meta: { key: 'value' },
          },
          {
            slipId: 'slip-002',
            consignor: {
              id: 'consignor-002',
              name: '荷主B',
            },
            consignee: {
              id: 'consignee-002',
              name: '荷受人B',
            },
            originSpot: {
              id: 'spot-003',
            },
            destinationSpot: {
              id: 'spot-004',
            },
          },
        ],
      };
      const mockResponse = {} as Response;

      await controller.addShipments(mockUser, input, mockResponse);

      expect(useCase.execute).toHaveBeenCalledWith(
        {
          shipments: [
            {
              slipId: 'slip-001',
              consignor: {
                id: 'consignor-001',
                name: '荷主A',
              },
              consignee: {
                id: 'consignee-001',
                name: '荷受人A',
              },
              originSpotId: 'spot-001',
              destinationSpotId: 'spot-002',
              meta: { key: 'value' },
            },
            {
              slipId: 'slip-002',
              consignor: {
                id: 'consignor-002',
                name: '荷主B',
              },
              consignee: {
                id: 'consignee-002',
                name: '荷受人B',
              },
              originSpotId: 'spot-003',
              destinationSpotId: 'spot-004',
              meta: undefined,
            },
          ],
        },
        'test-org-id',
      );
    });

    it('useCase.executeがエラーをスローした場合、エラーが伝播される', async () => {
      const input: AddShipmentsInput = {
        shipments: [
          {
            slipId: 'slip-001',
            consignor: {
              id: 'consignor-001',
              name: '荷主A',
            },
            consignee: {
              id: 'consignee-001',
              name: '荷受人A',
            },
            originSpot: {
              id: 'spot-001',
            },
            destinationSpot: {
              id: 'spot-002',
            },
          },
        ],
      };
      const mockResponse = {} as Response;
      const error = new Error('Test error');

      jest.spyOn(useCase, 'execute').mockRejectedValue(error);

      await expect(
        controller.addShipments(mockUser, input, mockResponse),
      ).rejects.toThrow('Test error');
    });
  });
});
