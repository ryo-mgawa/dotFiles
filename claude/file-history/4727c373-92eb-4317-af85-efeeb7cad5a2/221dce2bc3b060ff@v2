import { useCallback, useEffect, useRef } from 'react';
import type { Participant } from '@/entities';
import { VOLUME_LEVELS, type VolumeLevel } from '../types';

/**
 * 音量設定関数の型
 */
type SetVolumeFn = (participantId: string, level: VolumeLevel) => Promise<void>;

/**
 * useVolumeControl Props
 */
interface UseVolumeControlProps {
  participants: Participant[];
  mainSiteId: string | null;
  setVolume: SetVolumeFn;
  enabled?: boolean;
}

/**
 * useVolumeControl
 * メイン/サブ拠点の音量を自動制御するフック
 *
 * - メイン拠点: 100%
 * - サブ拠点: 30%
 * - メイン切り替え時に自動調整
 */
export const useVolumeControl = ({
  participants,
  mainSiteId,
  setVolume,
  enabled = true,
}: UseVolumeControlProps): void => {
  // 前回のメインサイトIDを保持
  const prevMainSiteIdRef = useRef<string | null>(null);

  // 音量調整済みの参加者を追跡
  const adjustedParticipantsRef = useRef<Set<string>>(new Set());

  /**
   * 参加者の音量を設定
   */
  const adjustVolume = useCallback(
    async (participantId: string, isMain: boolean) => {
      const volume = isMain ? VOLUME_LEVELS.MAIN : VOLUME_LEVELS.SUB;
      try {
        await setVolume(participantId, { value: volume });
        adjustedParticipantsRef.current.add(participantId);
      } catch (error) {
        console.error(`Failed to set volume for participant ${participantId}:`, error);
      }
    },
    [setVolume]
  );

  /**
   * メイン拠点変更時の音量調整
   */
  useEffect(() => {
    if (!enabled || !mainSiteId) return;

    const prevMainSiteId = prevMainSiteIdRef.current;

    // 同じメイン拠点なら何もしない
    if (prevMainSiteId === mainSiteId) return;

    const adjustAllVolumes = async () => {
      // 前のメイン拠点をサブ音量に
      if (prevMainSiteId) {
        const prevMainParticipant = participants.find(
          p => p.siteId === prevMainSiteId
        );
        if (prevMainParticipant) {
          await adjustVolume(prevMainParticipant.id, false);
        }
      }

      // 新しいメイン拠点をメイン音量に
      const newMainParticipant = participants.find(
        p => p.siteId === mainSiteId
      );
      if (newMainParticipant) {
        await adjustVolume(newMainParticipant.id, true);
      }
    };

    adjustAllVolumes();
    prevMainSiteIdRef.current = mainSiteId;
  }, [enabled, mainSiteId, participants, adjustVolume]);

  /**
   * 新規参加者の音量初期設定
   */
  useEffect(() => {
    if (!enabled) return;

    const newParticipants = participants.filter(
      p => !adjustedParticipantsRef.current.has(p.id)
    );

    newParticipants.forEach(participant => {
      const isMain = participant.siteId === mainSiteId;
      adjustVolume(participant.id, isMain);
    });
  }, [enabled, participants, mainSiteId, adjustVolume]);

  /**
   * 離脱した参加者を追跡リストから削除
   */
  useEffect(() => {
    const currentIds = new Set(participants.map(p => p.id));
    adjustedParticipantsRef.current.forEach(id => {
      if (!currentIds.has(id)) {
        adjustedParticipantsRef.current.delete(id);
      }
    });
  }, [participants]);
};
