import { Logger } from '@app/logger';
import { ProviderIdentity } from '@app/rdb';
import { ShipmentInsert } from '@app/rdb/db/model';
import { Inject, Injectable } from '@nestjs/common';
import { Knex } from 'knex';
import { ShipmentSaveException } from '../../exception/shipmentSaveException';
import { Shipment } from './types/getShipment';

@Injectable()
export class ShipmentDAO {
  constructor(@Inject(ProviderIdentity) private rdb: Knex) { }

  public async save(shipments: ShipmentInsert[]): Promise<void> {
    if (shipments.length === 0) {
      return;
    }

    await this.rdb('shipment')
      .insert(shipments)
      .onConflict()
      .ignore()
      .catch((error: Error) => {
        Logger.error('シップメント保存時にエラーが発生', { error: error.message });
        throw new ShipmentSaveException('シップメント情報の保存に失敗しました。');
      });
  }

  public getShipments(
    organizationId: string,
    limit: number,
    offset: number
  ): Promise<Shipment[]> {
    return this.rdb
      .from('shipment')
      .select(
        'id',
        'organization_id as organizationId',
        'slip_id as slipId',
        'consignor',
        'consignee',
        'origin_spot_id as originSpotId',
        'destination_spot_id as destinationSpotId',
        'meta',
      )
      .where('organization_id', organizationId)
      .limit(limit)
      .offset(offset);
  }
}
