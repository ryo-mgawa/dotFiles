import { Logger } from '@app/logger';
import { ShipmentDAO } from '@app/rdb';
import { ShipmentInsert } from '@app/rdb/db/model';
import { Injectable } from '@nestjs/common';
import { ShipmentSaveException } from '../../exception/shipmentSaveException';
import { Shipment } from '../model/shipment';

@Injectable()
export class ShipmentRepository {
  constructor(
    private readonly shipmentDAO: ShipmentDAO
  ) { }

  public async save(shipments: ShipmentInsert[]): Promise<string[]> {
    await this.shipmentDAO.save(shipments).catch((error) => {
      Logger.error('シップメント保存時にエラーが発生', { error: error.message });
      throw new ShipmentSaveException('シップメント情報の保存に失敗しました。');
    });

    return shipments.map((shipment) => shipment.id);
  }

  public async getShipments(queries: {
    organizationId: string;
    sinceId?: string;
    count?: number;
  }): Promise<Shipment[]> {
    const count = queries.count ?? 10;

    const rows = await this.shipmentDAO.getShipments({
      organizationId: queries.organizationId,
      sinceId: queries.sinceId,
      count,
    });

    return rows.map((row) => ({
      id: row.id,
      organizationId: row.organization_id,
      slipId: row.slip_id,
      consignor: {
        id: row.consignor.id,
        name: row.consignor.name ?? '',
      },
      consignee: {
        id: row.consignee.id,
        name: row.consignee.name ?? '',
      },
      originSpotId: row.origin_spot_id,
      destinationSpotId: row.destination_spot_id,
      meta: row.meta ?? undefined,
    }));
  }
}
