import {plainToInstance} from 'class-transformer';
import {validate} from 'class-validator';
import 'reflect-metadata';
import {Consignee} from '../consignee';

describe('Consignee', () => {
  describe('プロパティ設定', () => {
    it('idとnameが設定できる', () => {
      const consignee = new Consignee();
      consignee.id = 'consignee-001';
      consignee.name = '荷受人A';

      expect(consignee.id).toBe('consignee-001');
      expect(consignee.name).toBe('荷受人A');
    });
  });

  describe('バリデーション', () => {
    it('正常なデータの場合、バリデーションエラーが発生しない', async () => {
      const data = {
        id: 'consignee-001',
        name: '荷受人A',
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors).toHaveLength(0);
    });

    it('idが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        name: '荷受人A',
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors.length).toBeGreaterThan(0);
      const idError = errors.find(e => e.property === 'id');
      expect(idError).toBeDefined();
    });

    it('nameが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        id: 'consignee-001',
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors.length).toBeGreaterThan(0);
      const nameError = errors.find(e => e.property === 'name');
      expect(nameError).toBeDefined();
    });

    it('idが最大長を超える場合、バリデーションエラーが発生する', async () => {
      const data = {
        id: 'x'.repeat(257),
        name: '荷受人A',
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors.length).toBeGreaterThan(0);
      const idError = errors.find(e => e.property === 'id');
      expect(idError).toBeDefined();
    });

    it('nameが最大長を超える場合、バリデーションエラーが発生する', async () => {
      const data = {
        id: 'consignee-001',
        name: 'x'.repeat(257),
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors.length).toBeGreaterThan(0);
      const nameError = errors.find(e => e.property === 'name');
      expect(nameError).toBeDefined();
    });

    it('idが数値の場合、バリデーションエラーが発生する', async () => {
      const data = {
        id: 123,
        name: '荷受人A',
      };

      const consignee = plainToInstance(Consignee, data);
      const errors = await validate(consignee);

      expect(errors.length).toBeGreaterThan(0);
      const idError = errors.find(e => e.property === 'id');
      expect(idError).toBeDefined();
    });
  });
});
