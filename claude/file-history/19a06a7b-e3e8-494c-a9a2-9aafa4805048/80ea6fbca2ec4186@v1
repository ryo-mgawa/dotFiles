import {plainToInstance} from 'class-transformer';
import {validate} from 'class-validator';
import 'reflect-metadata';
import {AddShipmentItem} from '../addShipmentItem';
import {Consignee} from '../consignee';
import {Consignor} from '../consignor';
import {DestinationSpot, OriginSpot} from '../spot';

describe('AddShipmentItem', () => {
  describe('プロパティ設定', () => {
    it('metaありで全フィールドが設定できる', () => {
      const item = new AddShipmentItem();
      item.slipId = 'slip-001';
      item.consignor = {
        id: 'consignor-001',
        name: '荷主A',
      } as Consignor;
      item.consignee = {
        id: 'consignee-001',
        name: '荷受人A',
      } as Consignee;
      item.originSpot = {
        id: 'spot-001',
      } as OriginSpot;
      item.destinationSpot = {
        id: 'spot-002',
      } as DestinationSpot;
      item.meta = {key: 'value'};

      expect(item.slipId).toBe('slip-001');
      expect(item.consignor.id).toBe('consignor-001');
      expect(item.consignee.id).toBe('consignee-001');
      expect(item.originSpot.id).toBe('spot-001');
      expect(item.destinationSpot.id).toBe('spot-002');
      expect(item.meta).toEqual({key: 'value'});
    });

    it('metaなしで全フィールドが設定できる', () => {
      const item = new AddShipmentItem();
      item.slipId = 'slip-002';
      item.consignor = {
        id: 'consignor-002',
        name: '荷主B',
      } as Consignor;
      item.consignee = {
        id: 'consignee-002',
        name: '荷受人B',
      } as Consignee;
      item.originSpot = {
        id: 'spot-003',
      } as OriginSpot;
      item.destinationSpot = {
        id: 'spot-004',
      } as DestinationSpot;

      expect(item.slipId).toBe('slip-002');
      expect(item.consignor.id).toBe('consignor-002');
      expect(item.consignee.id).toBe('consignee-002');
      expect(item.originSpot.id).toBe('spot-003');
      expect(item.destinationSpot.id).toBe('spot-004');
      expect(item.meta).toBeUndefined();
    });
  });

  describe('バリデーション', () => {
    it('正常なデータの場合、バリデーションエラーが発生しない', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
        meta: {key: 'value'},
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors).toHaveLength(0);
    });

    it('consignorがネストされたオブジェクトとして正しく変換される', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);

      expect(item.consignor).toBeInstanceOf(Consignor);
      expect(item.consignor.id).toBe('consignor-001');
      expect(item.consignor.name).toBe('荷主A');
    });

    it('consigneeがネストされたオブジェクトとして正しく変換される', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);

      expect(item.consignee).toBeInstanceOf(Consignee);
      expect(item.consignee.id).toBe('consignee-001');
      expect(item.consignee.name).toBe('荷受人A');
    });

    it('originSpotがネストされたオブジェクトとして正しく変換される', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);

      expect(item.originSpot).toBeInstanceOf(OriginSpot);
      expect(item.originSpot.id).toBe('spot-001');
    });

    it('destinationSpotがネストされたオブジェクトとして正しく変換される', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);

      expect(item.destinationSpot).toBeInstanceOf(DestinationSpot);
      expect(item.destinationSpot.id).toBe('spot-002');
    });

    it('consignorのidが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
      const consignorError = errors.find(e => e.property === 'consignor');
      expect(consignorError).toBeDefined();
    });

    it('consigneeのnameが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
      const consigneeError = errors.find(e => e.property === 'consignee');
      expect(consigneeError).toBeDefined();
    });

    it('slipIdが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
      const slipIdError = errors.find(e => e.property === 'slipId');
      expect(slipIdError).toBeDefined();
    });

    it('slipIdが最大長を超える場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'x'.repeat(257),
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
      const slipIdError = errors.find(e => e.property === 'slipId');
      expect(slipIdError).toBeDefined();
    });

    it('metaが1kb以上の場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
        meta: {data: 'x'.repeat(1024)},
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
    });

    it('metaが空オブジェクトの場合、バリデーションエラーが発生しない', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {
          id: 'spot-002',
        },
        meta: {},
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors).toHaveLength(0);
    });

    it('originSpotのidが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {},
        destinationSpot: {
          id: 'spot-002',
        },
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
    });

    it('destinationSpotのidが未定義の場合、バリデーションエラーが発生する', async () => {
      const data = {
        slipId: 'slip-001',
        consignor: {
          id: 'consignor-001',
          name: '荷主A',
        },
        consignee: {
          id: 'consignee-001',
          name: '荷受人A',
        },
        originSpot: {
          id: 'spot-001',
        },
        destinationSpot: {},
      };

      const item = plainToInstance(AddShipmentItem, data);
      const errors = await validate(item);

      expect(errors.length).toBeGreaterThan(0);
    });
  });
});
