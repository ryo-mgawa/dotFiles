import { ShipmentDAO } from '@app/rdb';
import { Injectable } from '@nestjs/common';
import { v7 } from 'uuid';
import { ShipmentConverter } from '../converter/shipmentConverter';
import { ShipmentInput } from '../model/shipment';
import { ShipmentRepositoryInput } from './types/shipmentRepositoryTypes';

@Injectable()
export class ShipmentRepository {
  constructor(
    private readonly shipmentDAO: ShipmentDAO,
    private readonly shipmentConverter: ShipmentConverter
  ) { }

  public async save(
    organizationId: string,
    shipments: ShipmentInput[]
  ): Promise<string[]> {
    try {
      console.log('[ShipmentRepository] Saving shipments', { organizationId, count: shipments.length });

      const shipmentsWithId: ShipmentRepositoryInput[] = shipments.map((shipment) => ({
        ...shipment,
        id: v7(),
      }));
      console.log('[ShipmentRepository] Generated IDs', { ids: shipmentsWithId.map(s => s.id) });

      const shipmentInserts = this.shipmentConverter.convertToInsert(
        organizationId,
        shipmentsWithId
      );
      console.log('[ShipmentRepository] Converted to inserts', { shipmentInserts });

      await this.shipmentDAO.save(shipmentInserts);
      console.log('[ShipmentRepository] DAO save completed');

      return shipmentsWithId.map((shipment) => shipment.id);
    } catch (error) {
      console.error('[ShipmentRepository] Error:', error);
      throw error;
    }
  }
}
