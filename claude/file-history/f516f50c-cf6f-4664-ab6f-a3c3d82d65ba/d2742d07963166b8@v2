import { Role, Roles, User } from '@app/auth';
import { Logger } from '@app/logger';
import { UserContextTypes } from '@app/requestContext';
import { Body, Controller, Post } from '@nestjs/common';
import { AddShipmentEventsUseCase } from '../../../application/useCase/addShipmentEventsUseCase';
import { AddShipmentEventsInput } from '../dto/addShipmentEvents/input';
import { Output } from '../dto/addShipmentEvents/output';

@Roles(Role.PAAS)
@Controller('/public/shipmentEvents')
export class AddShipmentEventsController {
  constructor(private readonly addShipmentEventsUseCase: AddShipmentEventsUseCase) { }

  @Post('/')
  public async addShipmentEvents(
    @User() user: UserContextTypes,
    @Body() input: AddShipmentEventsInput,
  ): Promise<Output> {
    // デバッグ: 受信したリクエストボディをログ出力
    Logger.info('[DEBUG] AddShipmentEventsController - リクエスト受信', {
      userId: user.userId,
      inputRaw: JSON.stringify(input),
    });

    const useCaseInput = {
      events: input.events.map((event) => ({
        shipmentId: event.shipmentId,
        type: event.type,
        originalSpotId: event.originalSpotId,
        geocode: event.geocode
          ? { x: event.geocode.longitude, y: event.geocode.latitude }
          : undefined,
        executedAt: new Date(event.executedAt),
      })),
    };

    // デバッグ: マッピング後のユースケース入力をログ出力
    Logger.info('[DEBUG] AddShipmentEventsController - ユースケース入力生成', {
      useCaseInput: JSON.stringify(useCaseInput, (key, value) => {
        if (value instanceof Date) {
          return value.toISOString();
        }
        return value;
      }),
    });

    await this.addShipmentEventsUseCase.execute(
      useCaseInput,
      user.userId,
    );

    Logger.info('[DEBUG] AddShipmentEventsController - ユースケース実行完了');

    return { status: 'success' };
  }
}
