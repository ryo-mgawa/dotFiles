import { Role, Roles, User } from '@app/auth';
import { UserContextTypes } from '@app/requestContext';
import { Body, Controller, Post } from '@nestjs/common';
import { AddShipmentEventsUseCase } from '../../../application/useCase/addShipmentEventsUseCase';
import { AddShipmentEventsInput } from '../dto/addShipmentEvents/input';
import { Output } from '../dto/addShipmentEvents/output';

@Roles(Role.PAAS)
@Controller('/public/shipmentEvents')
export class AddShipmentEventsController {
  constructor(private readonly addShipmentEventsUseCase: AddShipmentEventsUseCase) { }

  @Post('/')
  public async addShipmentEvents(
    @User() user: UserContextTypes,
    @Body() input: AddShipmentEventsInput,
  ): Promise<Output> {
    const useCaseInput = {
      events: input.events.map((event) => ({
        shipmentId: event.shipmentId,
        type: event.type,
        originalSpotId: event.originalSpotId,
        geocode: event.geocode
          ? { x: event.geocode.longitude, y: event.geocode.latitude }
          : undefined,
        executedAt: new Date(event.executedAt),
      })),
    };

    await this.addShipmentEventsUseCase.execute(
      useCaseInput,
      user.userId,
    );

    return { status: 'success' };
  }
}
