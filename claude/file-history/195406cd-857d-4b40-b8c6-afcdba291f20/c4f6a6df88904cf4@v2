import jwt, { type SignOptions } from 'jsonwebtoken';
import { env } from '@/config/index.js';

interface AppJwtPayload {
  sub: string;
  companyId: string;
  siteId: string;
  role: 'admin' | 'user';
  authType?: 'user' | 'site';
  iat?: number;
  exp?: number;
}

const getSignOptions = (): SignOptions => ({
  expiresIn: env.JWT_EXPIRES_IN as jwt.SignOptions['expiresIn'],
});

export const generateAppToken = (user: {
  id: string;
  companyId: string;
  siteId: string;
  role: 'admin' | 'user';
}): string => {
  return jwt.sign(
    {
      sub: user.id,
      companyId: user.companyId,
      siteId: user.siteId,
      role: user.role,
      authType: 'user',
    },
    env.JWT_SECRET,
    getSignOptions()
  );
};

export const generateSiteToken = (site: {
  id: string;
  companyId: string;
}): string => {
  return jwt.sign(
    {
      sub: site.id,
      companyId: site.companyId,
      siteId: site.id,
      role: 'user',
      authType: 'site',
    },
    env.JWT_SECRET,
    getSignOptions()
  );
};

export const generateZoomToken = (
  sessionName: string,
  role: number = 1
): string => {
  const iat = Math.floor(Date.now() / 1000);
  const exp = iat + parseInt(env.ZOOM_JWT_EXPIRES_IN, 10);

  return jwt.sign(
    {
      app_key: env.ZOOM_SDK_KEY,
      role_type: role,
      tpc: sessionName,
      version: 1,
      iat,
      exp,
    },
    env.ZOOM_SDK_SECRET,
    { algorithm: 'HS256' }
  );
};

export const verifyAppToken = (token: string): AppJwtPayload => {
  return jwt.verify(token, env.JWT_SECRET) as AppJwtPayload;
};

export const decodeToken = (token: string): AppJwtPayload | null => {
  return jwt.decode(token) as AppJwtPayload | null;
};
