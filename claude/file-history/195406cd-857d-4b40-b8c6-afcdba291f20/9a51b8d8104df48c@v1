# 実装計画書

## 概要

本ドキュメントは、拠点間ビデオ通話Webアプリケーションの実装計画を定義する。
TDD（テスト駆動開発）を採用し、Clean ArchitectureおよびFeature-Based Architectureに基づいて段階的に実装を進める。

---

## 実装フェーズ

```
Phase 0: プロジェクト基盤構築
    ↓
Phase 1: バックエンド基盤（認証・DB）
    ↓
Phase 2: フロントエンド基盤（認証・ルーティング）
    ↓
Phase 3: セッション管理・Zoom SDK統合
    ↓
Phase 4: ビデオ通話UI実装
    ↓
Phase 5: 稼働時間管理機能
    ↓
Phase 6: 統合テスト・品質向上
```

---

## Phase 0: プロジェクト基盤構築

### 目標
開発環境のセットアップとプロジェクト構造の確立

### タスク

#### 0.1 フロントエンド初期化 (`front/`)
- [x] Vite + React + TypeScript プロジェクト作成
- [x] ディレクトリ構造の構築
  ```
  src/
  ├── app/
  ├── features/
  ├── entities/
  ├── shared/
  └── pages/
  ```
- [x] ESLint + Prettier 設定
- [x] Vitest + Testing Library 設定
- [x] tsconfig.json パスエイリアス設定 (`@/`)
- [x] 環境変数設定 (`.env.example`)

#### 0.2 バックエンド初期化 (`server/`)
- [x] Express + TypeScript プロジェクト作成
- [x] ディレクトリ構造の構築
  ```
  src/
  ├── app/
  ├── features/
  ├── entities/
  ├── shared/
  ├── infrastructure/
  └── config/
  ```
- [x] ESLint 設定
- [x] Vitest 設定
- [x] tsconfig.json パスエイリアス設定
- [x] 環境変数設定 (`.env.example`)

#### 0.3 データベース初期化
- [x] Prisma 初期化・schema.prisma 作成
- [x] マイグレーションファイル作成
- [x] Supabase プロジェクト接続設定
- [x] 開発用シードデータ作成

### 成果物
- 動作するフロントエンド開発サーバー
- 動作するバックエンド開発サーバー
- データベース接続確認

---

## Phase 1: バックエンド基盤（認証・DB）

### 目標
認証機能とデータベースアクセス層の実装

### タスク

#### 1.1 共通基盤 (`server/src/shared/`) ✅ Phase 0で実装済み
- [x] **エラークラス定義**
  - `AppError.ts` - 基底エラークラス
  - `AuthError.ts` - 認証エラー
  - `NotFoundError.ts` - リソース未発見エラー
  - `ValidationError.ts` - バリデーションエラー
- [x] **共通ミドルウェア**
  - `errorMiddleware.ts` - グローバルエラーハンドラ
  - `validationMiddleware.ts` - Zodバリデーション
- [x] **ユーティリティ**
  - `jwt.ts` - JWT生成・検証
  - `password.ts` - パスワードハッシュ

#### 1.2 エンティティ定義 (`server/src/entities/`)
- [x] `User.ts` - ユーザーエンティティ
- [x] `Company.ts` - 会社エンティティ
- [x] `Site.ts` - 拠点エンティティ
- [x] `Session.ts` - セッションエンティティ
- [x] `OperatingSchedule.ts` - 稼働スケジュールエンティティ

#### 1.3 リポジトリ層 (`server/src/infrastructure/database/repositories/`)
- [x] `IUserRepository.ts` - インターフェース
- [x] `UserRepository.ts` - Prisma実装
- [x] `ICompanyRepository.ts`
- [x] `CompanyRepository.ts`
- [x] `ISiteRepository.ts`
- [x] `SiteRepository.ts`
- [x] `ISessionRepository.ts`
- [x] `SessionRepository.ts`
- [x] `IScheduleRepository.ts`
- [x] `ScheduleRepository.ts`

#### 1.4 認証機能 (`server/src/features/auth/`)
- [x] **DTO定義**
  - `AuthDto.ts` - LoginRequestDto, LoginResponseDto, AuthUserDto
- [x] **バリデータ**
  - `authValidator.ts` - Zodスキーマ
- [x] **ユースケース**
  - `LoginUseCase.ts` - ログイン処理
  - `LoginUseCase.test.ts` - テスト（TDD）
  - `GetCurrentUserUseCase.ts` - 認証ユーザー取得
  - `GetCurrentUserUseCase.test.ts` - テスト
- [x] **コントローラー・ルート**
  - `AuthController.ts`
  - `authRoutes.ts`
- [x] **認証ミドルウェア**
  - `authMiddleware.ts` - JWT検証

#### 1.5 拠点機能 (`server/src/features/sites/`)
- [x] **ユースケース**
  - `GetSitesUseCase.ts` - 拠点一覧取得
  - `GetSitesUseCase.test.ts`
- [x] **コントローラー・ルート**
  - `SiteController.ts`
  - `siteRoutes.ts`

#### 1.6 アプリケーション設定 (`server/src/app/`) ✅ Phase 0で実装済み
- [x] `app.ts` - Express設定（CORS, Helmet, JSON）
- [x] `routes.ts` - ルート集約
- [x] `server.ts` - サーバー起動

### 成果物
- `POST /api/auth/login` - ログインAPI
- `GET /api/auth/me` - 認証ユーザー情報API
- `GET /api/sites` - 拠点一覧API
- 各ユースケースのユニットテスト

---

## Phase 2: フロントエンド基盤（認証・ルーティング）

### 目標
認証機能とルーティングの実装

### タスク

#### 2.1 共通基盤 (`front/src/shared/`)
- [ ] **APIクライアント**
  - `apiClient.ts` - axios/fetch ラッパー
  - インターセプター（認証トークン付与）
- [ ] **共通コンポーネント**
  - `Button/Button.tsx`
  - `Icon/Icon.tsx`
  - `LoadingSpinner/LoadingSpinner.tsx`
- [ ] **共通フック**
  - `useFullScreen.ts` - F11フルスクリーン対応

#### 2.2 エンティティ定義 (`front/src/entities/`)
- [ ] `User.ts` - ユーザー型定義
- [ ] `Company.ts` - 会社型定義
- [ ] `Site.ts` - 拠点型定義
- [ ] `Participant.ts` - 参加者型定義

#### 2.3 認証機能 (`front/src/features/auth/`)
- [ ] **API**
  - `authApi.ts` - ログイン・認証ユーザー取得
- [ ] **Context**
  - `AuthContext.tsx` - 認証状態管理
  - `useAuth.ts` - 認証フック
- [ ] **コンポーネント**
  - `LoginForm/LoginForm.tsx`
  - `LoginForm/LoginForm.test.tsx`
- [ ] **型定義**
  - `types/index.ts`

#### 2.4 ページ実装 (`front/src/pages/`)
- [ ] `LoginPage/LoginPage.tsx` - ログインページ
- [ ] `VideoCallPage/VideoCallPage.tsx` - 通話ページ（スケルトン）
- [ ] `SessionEndedPage/SessionEndedPage.tsx` - セッション終了ページ

#### 2.5 アプリケーション設定 (`front/src/app/`)
- [ ] `App.tsx` - ルートコンポーネント
- [ ] `routes.tsx` - React Router設定
- [ ] `providers/AppProviders.tsx` - Provider集約

### 成果物
- ログイン画面
- 認証状態管理
- ルーティング（未認証→ログイン、認証済→通話画面）

---

## Phase 3: セッション管理・Zoom SDK統合

### 目標
Zoom Video SDKとの連携とセッション管理の実装

### タスク

#### 3.1 バックエンド: セッション機能 (`server/src/features/session/`)
- [ ] **Zoom JWT生成サービス**
  - `ZoomJwtService.ts` - SDK JWT生成
  - `ZoomJwtService.test.ts`
- [ ] **DTO定義**
  - `JoinSessionRequestDto.ts`
  - `JoinSessionResponseDto.ts`
- [ ] **ユースケース**
  - `JoinSessionUseCase.ts` - セッション参加（JWT発行）
  - `JoinSessionUseCase.test.ts`
  - `LeaveSessionUseCase.ts` - セッション離脱
- [ ] **コントローラー・ルート**
  - `SessionController.ts`
  - `sessionRoutes.ts`

#### 3.2 フロントエンド: Zoom SDK統合 (`front/src/features/video-call/`)
- [ ] **Observer Pattern実装**
  - `observers/VideoSessionObserver.ts` - イベントインターフェース
  - `observers/VideoSessionSubject.ts` - Subject実装
- [ ] **Facade Pattern実装**
  - `facade/ZoomVideoFacade.ts` - SDK操作の簡略化
  - `facade/ZoomVideoFacade.test.ts`
- [ ] **Adapter Pattern実装**
  - `services/IVideoService.ts` - インターフェース
  - `services/ZoomVideoAdapter.ts` - 本番実装
  - `services/MockVideoAdapter.ts` - テスト用モック
- [ ] **State Pattern実装**
  - `states/SessionState.ts` - 状態基底クラス
  - `states/IdleState.ts`
  - `states/ConnectingState.ts`
  - `states/ConnectedState.ts`
  - `states/DisconnectedState.ts`
- [ ] **セッション管理フック**
  - `hooks/useSessionState.ts` - 状態マシン統合
  - `hooks/useSessionState.test.ts`

#### 3.3 フロントエンド: セッションAPI (`front/src/features/video-call/`)
- [ ] **API**
  - `api/sessionApi.ts` - セッション参加・離脱
- [ ] **Context**
  - `context/VideoContext.tsx` - ビデオ状態管理

### 成果物
- `POST /api/sessions/join` - セッション参加API
- Zoom SDK初期化・接続機能
- セッション状態管理

---

## Phase 4: ビデオ通話UI実装

### 目標
ビデオ通話画面のUI/UX実装

### タスク

#### 4.1 レイアウトコンポーネント
- [ ] **VerticalLayout**
  - `VerticalLayout.tsx` - 縦画面レイアウト
  - 4K縦向き対応CSS
- [ ] **MainVideoDisplay**
  - `MainVideoDisplay.tsx` - メイン映像表示
  - 画面80%占有
- [ ] **SubVideoDisplay**
  - `SubVideoDisplay.tsx` - サブ映像エリア
  - `VideoGrid.tsx` - グリッドレイアウト
  - `VideoThumbnail.tsx` - サムネイル
  - 画面20%占有、横並び
- [ ] **SelfVideoDisplay**
  - `SelfVideoDisplay.tsx` - セルフビュー
  - 右下配置、画面幅15%

#### 4.2 コントロールコンポーネント
- [ ] **VideoControls**
  - `VideoControls.tsx` - コントロールバー
  - `MicrophoneButton.tsx` - マイクミュート
  - `CameraButton.tsx` - カメラオン/オフ

#### 4.3 キーボードショートカット
- [ ] **useKeyboardShortcut.ts**
  - `Ctrl + opt + cmd + m`: 拠点切り替え
  - `opt + a`: マイクミュート
  - `opt + v`: カメラ切り替え

#### 4.4 音量制御
- [ ] **useVolumeControl.ts**
  - メイン拠点: 100%
  - サブ拠点: 30%
  - 自動切り替え

#### 4.5 VideoCallPage統合
- [ ] `VideoCallPage.tsx` - 全コンポーネント統合
- [ ] 2拠点/3拠点以上のレイアウト切り替え
- [ ] 参加者の入退室ハンドリング

### 成果物
- 完全なビデオ通話画面
- レスポンシブな縦画面レイアウト
- 音量自動制御
- キーボードショートカット

---

## Phase 5: 稼働時間管理機能

### 目標
稼働時間制御とスケジュール管理の実装

### タスク

#### 5.1 バックエンド: 稼働時間機能 (`server/src/features/operating-hours/`)
- [ ] **サービス**
  - `OperatingHoursService.ts` - 稼働判定ロジック
  - `OperatingHoursService.test.ts`
- [ ] **ミドルウェア**
  - `operatingHoursMiddleware.ts` - 稼働時間チェック
- [ ] **ユースケース**
  - `CheckOperatingHoursUseCase.ts`
  - `GetScheduleUseCase.ts`
  - `UpdateScheduleUseCase.ts` - 管理者用
  - `AddExceptionUseCase.ts` - 例外日追加
- [ ] **コントローラー・ルート**
  - `ScheduleController.ts`
  - `scheduleRoutes.ts`

#### 5.2 フロントエンド: 稼働時間機能 (`front/src/features/operating-hours/`)
- [ ] **Observer実装**
  - `observers/OperatingHoursObserver.ts`
  - `observers/OperatingHoursSubject.ts`
- [ ] **フック**
  - `hooks/useOperatingHoursMonitor.ts` - 残り時間監視
- [ ] **コンポーネント**
  - `OperatingHoursWarning.tsx` - 終了警告表示
- [ ] **API**
  - `api/scheduleApi.ts`

#### 5.3 自動退出機能
- [ ] 終了5分前警告表示
- [ ] 終了時刻到達時の自動切断
- [ ] SessionEndedPageへのリダイレクト

### 成果物
- `GET /api/schedules` - スケジュール取得API
- `GET /api/schedules/status` - 現在状態API
- `PUT /api/schedules` - スケジュール更新API（管理者）
- `POST /api/schedules/exceptions` - 例外日追加API
- 稼働時間外アクセス拒否
- 終了警告・自動退出

---

## Phase 6: 統合テスト・品質向上

### 目標
E2Eテストと品質改善

### タスク

#### 6.1 統合テスト
- [ ] API統合テスト
  - 認証フロー
  - セッション参加フロー
  - 稼働時間チェック
- [ ] フロントエンドE2Eテスト
  - ログイン→通話参加フロー
  - キーボードショートカット
  - 稼働時間警告

#### 6.2 品質改善
- [ ] パフォーマンス最適化
  - React.memo適用
  - useMemo/useCallback最適化
- [ ] アクセシビリティ対応
- [ ] エラーハンドリング強化
- [ ] ログ整備

#### 6.3 ドキュメント
- [ ] API仕様書（OpenAPI/Swagger）
- [ ] 環境構築手順
- [ ] デプロイ手順

### 成果物
- テストカバレッジ80%以上
- 本番デプロイ可能な状態

---

## 実装優先度と依存関係

```
[Phase 0] ─┬─► [Phase 1] ─────► [Phase 3] ─► [Phase 4]
           │       │                │
           │       ▼                ▼
           └─► [Phase 2] ──────────┘
                                    │
                                    ▼
                              [Phase 5]
                                    │
                                    ▼
                              [Phase 6]
```

- Phase 0 は全ての前提
- Phase 1/2 は並行実施可能
- Phase 3 は Phase 1/2 完了後
- Phase 4 は Phase 3 完了後
- Phase 5 は Phase 4 完了後
- Phase 6 は Phase 5 完了後

---

## TDD実践ガイドライン

### Red-Green-Refactor サイクル

1. **Red**: 失敗するテストを書く
2. **Green**: テストを通す最小限の実装
3. **Refactor**: コードをリファクタリング

### テスト命名規則

```typescript
describe('LoginUseCase', () => {
  describe('execute', () => {
    it('有効な認証情報でログインできること', async () => {});
    it('無効なメールアドレスでエラーになること', async () => {});
    it('無効なパスワードでエラーになること', async () => {});
    it('存在しないユーザーでエラーになること', async () => {});
  });
});
```

### テストファイル配置

```
# ユニットテスト: 実装ファイルと同階層
LoginUseCase.ts
LoginUseCase.test.ts

# 統合テスト: tests/ディレクトリ
tests/integration/auth.test.ts
```

---

## 次のステップ

Phase 0 から開始し、各フェーズ完了時にレビューを実施する。
問題があれば計画を調整する。
