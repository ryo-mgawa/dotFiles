import type { ISiteRepository } from '@/infrastructure/database/repositories/index.js';
import type { ICompanyRepository } from '@/infrastructure/database/repositories/index.js';
import type { SiteAuthRequestDto, SiteAuthResponseDto } from '../dto/AuthDto.js';
import { AuthenticationError } from '@/shared/errors/index.js';
import { generateSiteToken, generateZoomToken } from '@/shared/lib/index.js';

export class SiteAuthUseCase {
  constructor(
    private siteRepository: ISiteRepository,
    private companyRepository: ICompanyRepository
  ) {}

  async execute(input: SiteAuthRequestDto): Promise<SiteAuthResponseDto> {
    const site = await this.siteRepository.findByAccessToken(input.siteToken);

    if (!site) {
      throw new AuthenticationError('無効な拠点トークンです');
    }

    const company = await this.companyRepository.findById(site.companyId);

    if (!company) {
      throw new AuthenticationError('会社情報が見つかりません');
    }

    const accessToken = generateSiteToken({
      id: site.id,
      companyId: site.companyId,
    });

    // Zoom セッション名は会社ID + 日付で一意にする
    const today = new Date().toISOString().slice(0, 10);
    const zoomSessionName = `${company.id}-${today}`;
    const zoomToken = generateZoomToken(zoomSessionName);

    return {
      site: {
        id: site.id,
        name: site.name,
        displayOrder: site.displayOrder,
        companyId: site.companyId,
      },
      company: {
        id: company.id,
        name: company.name,
      },
      accessToken,
      zoomSessionName,
      zoomToken,
    };
  }
}
