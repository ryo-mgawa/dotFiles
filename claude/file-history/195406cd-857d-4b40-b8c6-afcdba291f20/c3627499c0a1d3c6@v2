import { Response, NextFunction } from 'express';
import { GetSitesUseCase } from '../usecases/GetSitesUseCase.js';
import {
  SiteRepository,
  SiteDeviceRepository,
} from '@/infrastructure/database/repositories/index.js';
import type { AuthenticatedRequest } from '@/shared/types/index.js';

const siteRepository = new SiteRepository();
const siteDeviceRepository = new SiteDeviceRepository();

export class SiteController {
  async getSites(req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> {
    try {
      if (!req.user) {
        res.status(401).json({
          success: false,
          error: { code: 'UNAUTHORIZED', message: '認証が必要です' },
        });
        return;
      }

      const getSitesUseCase = new GetSitesUseCase(siteRepository);
      const result = await getSitesUseCase.execute(req.user.companyId);

      res.json({
        success: true,
        data: result,
      });
    } catch (error) {
      next(error);
    }
  }

  async getDevice(req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> {
    try {
      if (!req.user) {
        res.status(401).json({
          success: false,
          error: { code: 'UNAUTHORIZED', message: '認証が必要です' },
        });
        return;
      }

      if (req.user.role !== 'admin') {
        res.status(403).json({
          success: false,
          error: { code: 'FORBIDDEN', message: '管理者権限が必要です' },
        });
        return;
      }

      const { siteId } = req.params;
      if (!siteId) {
        res.status(400).json({
          success: false,
          error: { code: 'BAD_REQUEST', message: '拠点IDが必要です' },
        });
        return;
      }

      // 拠点が自社のものか確認
      const site = await siteRepository.findById(siteId);
      if (!site || site.companyId !== req.user.companyId) {
        res.status(404).json({
          success: false,
          error: { code: 'NOT_FOUND', message: '拠点が見つかりません' },
        });
        return;
      }

      const device = await siteDeviceRepository.findBySiteId(siteId);

      res.json({
        success: true,
        data: {
          device: device
            ? {
                id: device.id,
                deviceId: device.deviceId,
                deviceName: device.deviceName,
                registeredAt: device.registeredAt.toISOString(),
                lastAccessedAt: device.lastAccessedAt.toISOString(),
              }
            : null,
        },
      });
    } catch (error) {
      next(error);
    }
  }

  async deleteDevice(req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> {
    try {
      if (!req.user) {
        res.status(401).json({
          success: false,
          error: { code: 'UNAUTHORIZED', message: '認証が必要です' },
        });
        return;
      }

      if (req.user.role !== 'admin') {
        res.status(403).json({
          success: false,
          error: { code: 'FORBIDDEN', message: '管理者権限が必要です' },
        });
        return;
      }

      const { siteId } = req.params;
      if (!siteId) {
        res.status(400).json({
          success: false,
          error: { code: 'BAD_REQUEST', message: '拠点IDが必要です' },
        });
        return;
      }

      // 拠点が自社のものか確認
      const site = await siteRepository.findById(siteId);
      if (!site || site.companyId !== req.user.companyId) {
        res.status(404).json({
          success: false,
          error: { code: 'NOT_FOUND', message: '拠点が見つかりません' },
        });
        return;
      }

      await siteDeviceRepository.deleteBySiteId(siteId);

      res.json({
        success: true,
        data: {
          message: 'デバイスの登録を解除しました',
        },
      });
    } catch (error) {
      next(error);
    }
  }
}
