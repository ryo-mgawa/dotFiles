# データベース設計書

## 1. 概要

### 1.1 使用技術
- **データベース**: Supabase (PostgreSQL)
- **ORM**: Prisma
- **設計方針**: 論理削除、適切なインデックス設計

### 1.2 ER図

```
┌──────────────────┐       ┌──────────────────┐
│     companies    │       │      sites       │
├──────────────────┤       ├──────────────────┤
│ id (PK)          │──────<│ id (PK)          │
│ name             │   │   │ company_id (FK)  │
│ timezone         │   │   │ name             │
│ created_at       │   │   │ display_order    │
│ updated_at       │   │   │ access_token (UK)│
│ deleted_at       │   │   │ created_at       │
└──────────────────┘   │   │ updated_at       │
                       │   │ deleted_at       │
                       │   └──────────────────┘
         │             │            ▼
         │             │   ┌──────────────────┐
         │             │   │    sessions      │
         │             │   ├──────────────────┤
         │             │   │ id (PK)          │
         │             │   │ company_id (FK)  │
         │             │   │ topic            │
         │             └──>│ status           │
         │                 │ started_at       │
         │                 │ ended_at         │
         │                 │ created_at       │
         │                 └──────────────────┘
         │
         ├─────────────────────────────────────┐
         │                                     │
         ▼                                     ▼
┌──────────────────┐       ┌─────────────────────────────┐
│      users       │       │   operating_schedules       │
├──────────────────┤       ├─────────────────────────────┤
│ id (PK)          │       │ id (PK)                     │
│ company_id (FK)  │       │ company_id (FK)             │
│ site_id (FK)     │       │ day_of_week (0-6)           │
│ email            │       │ start_time (TIME)           │
│ password_hash    │       │ end_time (TIME)             │
│ name             │       │ is_enabled                  │
│ role             │       │ created_at                  │
│ created_at       │       │ updated_at                  │
│ updated_at       │       └─────────────────────────────┘
│ deleted_at       │
└──────────────────┘       ┌─────────────────────────────┐
                           │ operating_schedule_exceptions│
┌──────────────────┐       ├─────────────────────────────┤
│session_participants│     │ id (PK)                     │
├──────────────────┤       │ company_id (FK)             │
│ id (PK)          │       │ exception_date (DATE)       │
│ session_id (FK)  │       │ exception_type              │
│ site_id (FK)     │       │ start_time (TIME)           │
│ user_id (FK)     │       │ end_time (TIME)             │
│ joined_at        │       │ description                 │
│ left_at          │       │ created_at                  │
└──────────────────┘       │ updated_at                  │
                           └─────────────────────────────┘
```

---

## 2. テーブル定義

### 2.1 companies（会社）

会社情報を管理するテーブル。マルチテナント分離の基盤。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| name | VARCHAR(255) | NO | - | 会社名 |
| timezone | VARCHAR(50) | NO | 'Asia/Tokyo' | タイムゾーン |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMPTZ | YES | NULL | 削除日時（論理削除） |

> **Note**: Zoom SDK Key/Secret は環境変数で管理（運営側で1つのアカウントを使用）

**インデックス:**
- `idx_companies_deleted_at` ON (deleted_at) WHERE deleted_at IS NULL

---

### 2.2 sites（拠点）

各会社の拠点情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| company_id | UUID | NO | - | 会社ID（外部キー） |
| name | VARCHAR(100) | NO | - | 拠点名（東京、名古屋等） |
| display_order | INTEGER | NO | 0 | 表示順序 |
| access_token | UUID | NO | gen_random_uuid() | 拠点認証用トークン（自動認証URL用） |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMPTZ | YES | NULL | 削除日時（論理削除） |

> **Note**: `access_token`は各拠点に固有のUUIDで、`/site/{access_token}`形式のURLでデバイス自動認証に使用されます。

**インデックス:**
- `idx_sites_company_id` ON (company_id)
- `idx_sites_company_order` ON (company_id, display_order) WHERE deleted_at IS NULL
- `idx_sites_access_token` UNIQUE ON (access_token)

**外部キー:**
- `fk_sites_company` REFERENCES companies(id) ON DELETE CASCADE

---

### 2.3 users（ユーザー）

ユーザー情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| company_id | UUID | NO | - | 会社ID（外部キー） |
| site_id | UUID | NO | - | 所属拠点ID（外部キー） |
| email | VARCHAR(255) | NO | - | メールアドレス（ログインID） |
| password_hash | VARCHAR(255) | NO | - | パスワードハッシュ |
| name | VARCHAR(100) | NO | - | 表示名 |
| role | VARCHAR(20) | NO | 'user' | ロール（admin/user） |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMPTZ | YES | NULL | 削除日時（論理削除） |

**インデックス:**
- `idx_users_email` UNIQUE ON (email) WHERE deleted_at IS NULL
- `idx_users_company_id` ON (company_id)
- `idx_users_site_id` ON (site_id)

**外部キー:**
- `fk_users_company` REFERENCES companies(id) ON DELETE CASCADE
- `fk_users_site` REFERENCES sites(id) ON DELETE RESTRICT

---

### 2.4 sessions（セッション）

ビデオ通話セッションを管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| company_id | UUID | NO | - | 会社ID（外部キー） |
| topic | VARCHAR(255) | NO | - | Zoomセッショントピック |
| status | VARCHAR(20) | NO | 'active' | ステータス（active/ended） |
| started_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 開始日時 |
| ended_at | TIMESTAMPTZ | YES | NULL | 終了日時 |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |

**インデックス:**
- `idx_sessions_company_status` ON (company_id, status)
- `idx_sessions_topic` UNIQUE ON (topic) WHERE status = 'active'

**外部キー:**
- `fk_sessions_company` REFERENCES companies(id) ON DELETE CASCADE

---

### 2.5 session_participants（セッション参加者）

セッションへの参加履歴を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| session_id | UUID | NO | - | セッションID（外部キー） |
| site_id | UUID | NO | - | 参加拠点ID（外部キー） |
| user_id | UUID | YES | NULL | 参加ユーザーID（外部キー） |
| joined_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 参加日時 |
| left_at | TIMESTAMPTZ | YES | NULL | 退出日時 |

**インデックス:**
- `idx_participants_session` ON (session_id)
- `idx_participants_site` ON (site_id)
- `idx_participants_active` ON (session_id, site_id) WHERE left_at IS NULL

**外部キー:**
- `fk_participants_session` REFERENCES sessions(id) ON DELETE CASCADE
- `fk_participants_site` REFERENCES sites(id) ON DELETE RESTRICT
- `fk_participants_user` REFERENCES users(id) ON DELETE SET NULL

---

### 2.6 operating_schedules（稼働スケジュール）

会社ごとの曜日別稼働時間を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| company_id | UUID | NO | - | 会社ID（外部キー） |
| day_of_week | INTEGER | NO | - | 曜日（0=日曜, 1=月曜, ..., 6=土曜） |
| start_time | TIME | YES | NULL | 稼働開始時刻（無効時はNULL） |
| end_time | TIME | YES | NULL | 稼働終了時刻（無効時はNULL） |
| is_enabled | BOOLEAN | NO | true | 有効/無効フラグ |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |

**インデックス:**
- `idx_schedules_company_day` UNIQUE ON (company_id, day_of_week)

**外部キー:**
- `fk_schedules_company` REFERENCES companies(id) ON DELETE CASCADE

**制約:**
- `chk_day_of_week` CHECK (day_of_week >= 0 AND day_of_week <= 6)
- `chk_time_range` CHECK (is_enabled = FALSE OR (start_time IS NOT NULL AND end_time IS NOT NULL AND start_time < end_time))

---

### 2.7 operating_schedule_exceptions（稼働スケジュール例外）

祝日・休業日・臨時稼働時間を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| company_id | UUID | NO | - | 会社ID（外部キー） |
| exception_date | DATE | NO | - | 例外日 |
| exception_type | VARCHAR(20) | NO | - | 例外タイプ（holiday/closed/custom） |
| start_time | TIME | YES | NULL | 稼働開始時刻（customの場合） |
| end_time | TIME | YES | NULL | 稼働終了時刻（customの場合） |
| description | VARCHAR(255) | YES | NULL | 説明（例：元日、臨時休業等） |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |

**例外タイプ:**
- `holiday`: 祝日（終日休業）
- `closed`: 臨時休業（終日休業）
- `custom`: 臨時稼働時間（start_time, end_timeで時間指定）

**インデックス:**
- `idx_exceptions_company_date` ON (company_id, exception_date)
- `idx_exceptions_date` ON (exception_date)

**外部キー:**
- `fk_exceptions_company` REFERENCES companies(id) ON DELETE CASCADE

**制約:**
- `chk_exception_type` CHECK (exception_type IN ('holiday', 'closed', 'custom'))
- `chk_custom_time` CHECK (exception_type != 'custom' OR (start_time IS NOT NULL AND end_time IS NOT NULL AND start_time < end_time))

---

## 3. Prisma スキーマ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  timezone  String    @default("Asia/Tokyo") @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  sites              Site[]
  users              User[]
  sessions           Session[]
  operatingSchedules OperatingSchedule[]
  scheduleExceptions OperatingScheduleException[]

  @@index([deletedAt])
  @@map("companies")
}

model Site {
  id           String    @id @default(uuid()) @db.Uuid
  companyId    String    @map("company_id") @db.Uuid
  name         String    @db.VarChar(100)
  displayOrder Int       @default(0) @map("display_order")
  accessToken  String    @unique @default(uuid()) @map("access_token") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users        User[]
  participants SessionParticipant[]

  @@index([companyId])
  @@index([companyId, displayOrder])
  @@index([accessToken])
  @@map("sites")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  companyId    String    @map("company_id") @db.Uuid
  siteId       String    @map("site_id") @db.Uuid
  email        String    @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(100)
  role         String    @default("user") @db.VarChar(20)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site         Site                 @relation(fields: [siteId], references: [id], onDelete: Restrict)
  participants SessionParticipant[]

  @@unique([email])
  @@index([companyId])
  @@index([siteId])
  @@map("users")
}

model Session {
  id        String    @id @default(uuid()) @db.Uuid
  companyId String    @map("company_id") @db.Uuid
  topic     String    @db.VarChar(255)
  status    String    @default("active") @db.VarChar(20)
  startedAt DateTime  @default(now()) @map("started_at") @db.Timestamptz
  endedAt   DateTime? @map("ended_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  participants SessionParticipant[]

  @@index([companyId, status])
  @@map("sessions")
}

model SessionParticipant {
  id        String    @id @default(uuid()) @db.Uuid
  sessionId String    @map("session_id") @db.Uuid
  siteId    String    @map("site_id") @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  joinedAt  DateTime  @default(now()) @map("joined_at") @db.Timestamptz
  leftAt    DateTime? @map("left_at") @db.Timestamptz

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  site    Site    @relation(fields: [siteId], references: [id], onDelete: Restrict)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([siteId])
  @@index([sessionId, siteId])
  @@map("session_participants")
}

model OperatingSchedule {
  id        String    @id @default(uuid()) @db.Uuid
  companyId String    @map("company_id") @db.Uuid
  dayOfWeek Int       @map("day_of_week")
  startTime DateTime? @map("start_time") @db.Time
  endTime   DateTime? @map("end_time") @db.Time
  isEnabled Boolean   @default(true) @map("is_enabled")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, dayOfWeek])
  @@map("operating_schedules")
}

model OperatingScheduleException {
  id            String    @id @default(uuid()) @db.Uuid
  companyId     String    @map("company_id") @db.Uuid
  exceptionDate DateTime  @map("exception_date") @db.Date
  exceptionType String    @map("exception_type") @db.VarChar(20)
  startTime     DateTime? @map("start_time") @db.Time
  endTime       DateTime? @map("end_time") @db.Time
  description   String?   @db.VarChar(255)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, exceptionDate])
  @@index([exceptionDate])
  @@map("operating_schedule_exceptions")
}
```

---

## 4. マイグレーションSQL

```sql
-- 会社テーブル
-- Note: Zoom SDK Key/Secret は環境変数で管理
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Tokyo',
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_companies_deleted_at ON companies(deleted_at) WHERE deleted_at IS NULL;

-- 拠点テーブル
CREATE TABLE sites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    display_order INTEGER NOT NULL DEFAULT 0,
    access_token UUID NOT NULL DEFAULT gen_random_uuid() UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_sites_company_id ON sites(company_id);
CREATE INDEX idx_sites_company_order ON sites(company_id, display_order) WHERE deleted_at IS NULL;
CREATE INDEX idx_sites_access_token ON sites(access_token);

-- ユーザーテーブル
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    site_id UUID NOT NULL REFERENCES sites(id) ON DELETE RESTRICT,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_company_id ON users(company_id);
CREATE INDEX idx_users_site_id ON users(site_id);

-- セッションテーブル
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    topic VARCHAR(255) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    started_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_company_status ON sessions(company_id, status);
CREATE UNIQUE INDEX idx_sessions_topic ON sessions(topic) WHERE status = 'active';

-- セッション参加者テーブル
CREATE TABLE session_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    site_id UUID NOT NULL REFERENCES sites(id) ON DELETE RESTRICT,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    joined_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMPTZ
);

CREATE INDEX idx_participants_session ON session_participants(session_id);
CREATE INDEX idx_participants_site ON session_participants(site_id);
CREATE INDEX idx_participants_active ON session_participants(session_id, site_id) WHERE left_at IS NULL;

-- updated_at自動更新トリガー
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_companies_updated_at
    BEFORE UPDATE ON companies
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sites_updated_at
    BEFORE UPDATE ON sites
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 稼働スケジュールテーブル
CREATE TABLE operating_schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    day_of_week INTEGER NOT NULL,
    start_time TIME,
    end_time TIME,
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_day_of_week CHECK (day_of_week >= 0 AND day_of_week <= 6),
    CONSTRAINT chk_time_range CHECK (is_enabled = FALSE OR (start_time IS NOT NULL AND end_time IS NOT NULL AND start_time < end_time))
);

CREATE UNIQUE INDEX idx_schedules_company_day ON operating_schedules(company_id, day_of_week);

CREATE TRIGGER update_schedules_updated_at
    BEFORE UPDATE ON operating_schedules
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 稼働スケジュール例外テーブル
CREATE TABLE operating_schedule_exceptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    exception_date DATE NOT NULL,
    exception_type VARCHAR(20) NOT NULL,
    start_time TIME,
    end_time TIME,
    description VARCHAR(255),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_exception_type CHECK (exception_type IN ('holiday', 'closed', 'custom')),
    CONSTRAINT chk_custom_time CHECK (
        exception_type != 'custom' OR
        (start_time IS NOT NULL AND end_time IS NOT NULL AND start_time < end_time)
    )
);

CREATE INDEX idx_exceptions_company_date ON operating_schedule_exceptions(company_id, exception_date);
CREATE INDEX idx_exceptions_date ON operating_schedule_exceptions(exception_date);

CREATE TRIGGER update_exceptions_updated_at
    BEFORE UPDATE ON operating_schedule_exceptions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## 5. 初期データ（開発用）

```sql
-- サンプル会社
INSERT INTO companies (id, name, timezone) VALUES
('11111111-1111-1111-1111-111111111111', '株式会社サンプル', 'Asia/Tokyo');

-- サンプル拠点（access_tokenはデバイス自動認証に使用）
INSERT INTO sites (id, company_id, name, display_order, access_token) VALUES
('aaaa1111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111111', '東京', 1, 'bbbb1111-1111-1111-1111-111111111111'),
('aaaa2222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111', '名古屋', 2, 'bbbb2222-2222-2222-2222-222222222222'),
('aaaa3333-3333-3333-3333-333333333333', '11111111-1111-1111-1111-111111111111', '大阪', 3, 'bbbb3333-3333-3333-3333-333333333333'),
('aaaa4444-4444-4444-4444-444444444444', '11111111-1111-1111-1111-111111111111', '福岡', 4, 'bbbb4444-4444-4444-4444-444444444444');

-- 拠点自動認証URL例:
-- 東京: /site/bbbb1111-1111-1111-1111-111111111111
-- 名古屋: /site/bbbb2222-2222-2222-2222-222222222222
-- 大阪: /site/bbbb3333-3333-3333-3333-333333333333
-- 福岡: /site/bbbb4444-4444-4444-4444-444444444444

-- サンプルユーザー（パスワード: password123 のハッシュ）
INSERT INTO users (company_id, site_id, email, password_hash, name, role) VALUES
('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 'tokyo@example.com', '$2b$10$...', '東京太郎', 'admin'),
('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 'nagoya@example.com', '$2b$10$...', '名古屋次郎', 'user'),
('11111111-1111-1111-1111-111111111111', 'aaaa3333-3333-3333-3333-333333333333', 'osaka@example.com', '$2b$10$...', '大阪三郎', 'user'),
('11111111-1111-1111-1111-111111111111', 'aaaa4444-4444-4444-4444-444444444444', 'fukuoka@example.com', '$2b$10$...', '福岡四郎', 'user');

-- サンプル稼働スケジュール（月〜金 9:00-18:00）
INSERT INTO operating_schedules (company_id, day_of_week, start_time, end_time, is_enabled) VALUES
('11111111-1111-1111-1111-111111111111', 0, NULL, NULL, FALSE),        -- 日曜: 休み
('11111111-1111-1111-1111-111111111111', 1, '09:00', '18:00', TRUE),   -- 月曜
('11111111-1111-1111-1111-111111111111', 2, '09:00', '18:00', TRUE),   -- 火曜
('11111111-1111-1111-1111-111111111111', 3, '09:00', '18:00', TRUE),   -- 水曜
('11111111-1111-1111-1111-111111111111', 4, '09:00', '18:00', TRUE),   -- 木曜
('11111111-1111-1111-1111-111111111111', 5, '09:00', '18:00', TRUE),   -- 金曜
('11111111-1111-1111-1111-111111111111', 6, NULL, NULL, FALSE);        -- 土曜: 休み

-- サンプル稼働スケジュール例外（祝日・臨時稼働）
INSERT INTO operating_schedule_exceptions (company_id, exception_date, exception_type, description) VALUES
('11111111-1111-1111-1111-111111111111', '2025-01-01', 'holiday', '元日'),
('11111111-1111-1111-1111-111111111111', '2025-01-13', 'holiday', '成人の日'),
('11111111-1111-1111-1111-111111111111', '2025-02-11', 'holiday', '建国記念の日');

-- 臨時稼働時間の例（土曜日に臨時稼働）
INSERT INTO operating_schedule_exceptions (company_id, exception_date, exception_type, start_time, end_time, description) VALUES
('11111111-1111-1111-1111-111111111111', '2025-03-15', 'custom', '10:00', '15:00', '臨時稼働（棚卸し）');
```

---

## 6. Supabase RLS（Row Level Security）ポリシー

```sql
-- 会社テーブルのRLS
ALTER TABLE companies ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own company" ON companies
    FOR SELECT
    USING (id = (SELECT company_id FROM users WHERE id = auth.uid()));

-- 拠点テーブルのRLS
ALTER TABLE sites ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view sites in their company" ON sites
    FOR SELECT
    USING (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

-- ユーザーテーブルのRLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view users in their company" ON users
    FOR SELECT
    USING (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

-- セッションテーブルのRLS
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view sessions in their company" ON sessions
    FOR SELECT
    USING (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Users can create sessions in their company" ON sessions
    FOR INSERT
    WITH CHECK (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

-- 稼働スケジュールテーブルのRLS
ALTER TABLE operating_schedules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view schedules in their company" ON operating_schedules
    FOR SELECT
    USING (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Admins can manage schedules in their company" ON operating_schedules
    FOR ALL
    USING (
        company_id = (SELECT company_id FROM users WHERE id = auth.uid())
        AND EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin')
    );

-- 稼働スケジュール例外テーブルのRLS
ALTER TABLE operating_schedule_exceptions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view exceptions in their company" ON operating_schedule_exceptions
    FOR SELECT
    USING (company_id = (SELECT company_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Admins can manage exceptions in their company" ON operating_schedule_exceptions
    FOR ALL
    USING (
        company_id = (SELECT company_id FROM users WHERE id = auth.uid())
        AND EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin')
    );
```

---

## 7. バックアップ・リカバリ方針

| 項目 | 設定 |
|------|------|
| 自動バックアップ | Supabaseの日次自動バックアップを利用 |
| 保持期間 | 7日間（無料プラン）/ 30日間（Proプラン） |
| ポイントインタイムリカバリ | Proプランで利用可能 |
