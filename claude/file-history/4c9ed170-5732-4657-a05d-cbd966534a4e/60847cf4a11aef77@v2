import type { SiteDevice as PrismaSiteDevice } from '@prisma/client';
import type { SiteDevice } from '@/entities/index.js';
import type { ISiteDeviceRepository } from './ISiteDeviceRepository.js';
import { prisma } from '../prisma/client.js';

export class SiteDeviceRepository implements ISiteDeviceRepository {
  private mapToEntity(device: PrismaSiteDevice): SiteDevice {
    return {
      id: device.id,
      siteId: device.siteId,
      deviceId: device.deviceId,
      deviceName: device.deviceName,
      registeredAt: device.registeredAt,
      lastAccessedAt: device.lastAccessedAt,
    };
  }

  async findBySiteId(siteId: string): Promise<SiteDevice | null> {
    const device = await prisma.siteDevice.findUnique({
      where: { siteId },
    });

    if (!device) return null;

    return this.mapToEntity(device);
  }

  async create(input: {
    siteId: string;
    deviceId: string;
    deviceName: string | null;
  }): Promise<SiteDevice> {
    const device = await prisma.siteDevice.create({
      data: {
        siteId: input.siteId,
        deviceId: input.deviceId,
        deviceName: input.deviceName,
      },
    });

    return this.mapToEntity(device);
  }

  async updateLastAccessedAt(id: string): Promise<void> {
    await prisma.siteDevice.update({
      where: { id },
      data: { lastAccessedAt: new Date() },
    });
  }

  async delete(id: string): Promise<void> {
    await prisma.siteDevice.delete({
      where: { id },
    });
  }

  async deleteBySiteId(siteId: string): Promise<void> {
    await prisma.siteDevice.deleteMany({
      where: { siteId },
    });
  }
}
