import { Request, Response, NextFunction } from 'express';
import { LoginUseCase } from '../usecases/LoginUseCase.js';
import { GetCurrentUserUseCase } from '../usecases/GetCurrentUserUseCase.js';
import { SiteAuthUseCase } from '../usecases/SiteAuthUseCase.js';
import {
  UserRepository,
  CompanyRepository,
  SiteRepository,
  SiteDeviceRepository,
} from '@/infrastructure/database/repositories/index.js';
import type { AuthenticatedRequest } from '@/shared/types/index.js';
import type { LoginRequestDto, SiteAuthRequestDto } from '../dto/AuthDto.js';

const userRepository = new UserRepository();
const companyRepository = new CompanyRepository();
const siteRepository = new SiteRepository();
const siteDeviceRepository = new SiteDeviceRepository();

export class AuthController {
  async login(req: Request, res: Response, next: NextFunction): Promise<void> {
    try {
      const loginUseCase = new LoginUseCase(userRepository, companyRepository);
      const input: LoginRequestDto = req.body;
      const result = await loginUseCase.execute(input);

      res.json({
        success: true,
        data: result,
      });
    } catch (error) {
      next(error);
    }
  }

  async authenticateBySiteToken(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<void> {
    try {
      const siteAuthUseCase = new SiteAuthUseCase(
        siteRepository,
        companyRepository,
        siteDeviceRepository
      );
      const input: SiteAuthRequestDto = {
        siteToken: req.body.siteToken,
        deviceId: req.body.deviceId ?? null,
        deviceName: req.body.deviceName ?? null,
      };
      const result = await siteAuthUseCase.execute(input);

      res.json({
        success: true,
        data: result,
      });
    } catch (error) {
      next(error);
    }
  }

  async getCurrentUser(
    req: AuthenticatedRequest,
    res: Response,
    next: NextFunction
  ): Promise<void> {
    try {
      if (!req.user) {
        res.status(401).json({
          success: false,
          error: { code: 'UNAUTHORIZED', message: '認証が必要です' },
        });
        return;
      }

      const getCurrentUserUseCase = new GetCurrentUserUseCase(
        userRepository,
        companyRepository
      );
      const result = await getCurrentUserUseCase.execute(req.user.id);

      res.json({
        success: true,
        data: result,
      });
    } catch (error) {
      next(error);
    }
  }
}
