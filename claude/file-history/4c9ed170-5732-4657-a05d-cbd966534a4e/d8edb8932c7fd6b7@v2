generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  timezone  String    @default("Asia/Tokyo") @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  sites              Site[]
  users              User[]
  sessions           Session[]
  operatingSchedules OperatingSchedule[]
  scheduleExceptions OperatingScheduleException[]

  @@index([deletedAt])
  @@map("companies")
}

model Site {
  id           String    @id @default(uuid()) @db.Uuid
  companyId    String    @map("company_id") @db.Uuid
  name         String    @db.VarChar(100)
  displayOrder Int       @default(0) @map("display_order")
  accessToken  String    @unique @default(uuid()) @map("access_token") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users        User[]
  participants SessionParticipant[]

  @@index([companyId])
  @@index([companyId, displayOrder])
  @@index([accessToken])
  @@map("sites")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  companyId    String    @map("company_id") @db.Uuid
  siteId       String    @map("site_id") @db.Uuid
  email        String    @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(100)
  role         String    @default("user") @db.VarChar(20)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site         Site                 @relation(fields: [siteId], references: [id], onDelete: Restrict)
  participants SessionParticipant[]

  @@unique([email])
  @@index([companyId])
  @@index([siteId])
  @@map("users")
}

model Session {
  id        String    @id @default(uuid()) @db.Uuid
  companyId String    @map("company_id") @db.Uuid
  topic     String    @db.VarChar(255)
  status    String    @default("active") @db.VarChar(20)
  startedAt DateTime  @default(now()) @map("started_at") @db.Timestamptz
  endedAt   DateTime? @map("ended_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  participants SessionParticipant[]

  @@index([companyId, status])
  @@map("sessions")
}

model SessionParticipant {
  id        String    @id @default(uuid()) @db.Uuid
  sessionId String    @map("session_id") @db.Uuid
  siteId    String    @map("site_id") @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  joinedAt  DateTime  @default(now()) @map("joined_at") @db.Timestamptz
  leftAt    DateTime? @map("left_at") @db.Timestamptz

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  site    Site    @relation(fields: [siteId], references: [id], onDelete: Restrict)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([siteId])
  @@index([sessionId, siteId])
  @@map("session_participants")
}

model OperatingSchedule {
  id        String    @id @default(uuid()) @db.Uuid
  companyId String    @map("company_id") @db.Uuid
  dayOfWeek Int       @map("day_of_week")
  startTime DateTime? @map("start_time") @db.Time
  endTime   DateTime? @map("end_time") @db.Time
  isEnabled Boolean   @default(true) @map("is_enabled")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, dayOfWeek])
  @@map("operating_schedules")
}

model OperatingScheduleException {
  id            String    @id @default(uuid()) @db.Uuid
  companyId     String    @map("company_id") @db.Uuid
  exceptionDate DateTime  @map("exception_date") @db.Date
  exceptionType String    @map("exception_type") @db.VarChar(20)
  startTime     DateTime? @map("start_time") @db.Time
  endTime       DateTime? @map("end_time") @db.Time
  description   String?   @db.VarChar(255)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, exceptionDate])
  @@index([exceptionDate])
  @@map("operating_schedule_exceptions")
}
