import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcrypt';

const prisma = new PrismaClient();

const SALT_ROUNDS = 10;

async function main() {
  const passwordHash = await bcrypt.hash('password123', SALT_ROUNDS);

  // サンプル会社
  const company = await prisma.company.upsert({
    where: { id: '11111111-1111-1111-1111-111111111111' },
    update: {},
    create: {
      id: '11111111-1111-1111-1111-111111111111',
      name: '株式会社サンプル',
      timezone: 'Asia/Tokyo',
    },
  });

  // サンプル拠点
  const sites = [
    { id: 'aaaa1111-1111-1111-1111-111111111111', name: '東京', displayOrder: 1 },
    { id: 'aaaa2222-2222-2222-2222-222222222222', name: '名古屋', displayOrder: 2 },
    { id: 'aaaa3333-3333-3333-3333-333333333333', name: '大阪', displayOrder: 3 },
    { id: 'aaaa4444-4444-4444-4444-444444444444', name: '福岡', displayOrder: 4 },
  ];

  for (const site of sites) {
    await prisma.site.upsert({
      where: { id: site.id },
      update: {},
      create: {
        id: site.id,
        companyId: company.id,
        name: site.name,
        displayOrder: site.displayOrder,
      },
    });
  }

  // サンプルユーザー
  const users = [
    { siteId: sites[0]!.id, email: 'tokyo@example.com', name: '東京太郎', role: 'admin' },
    { siteId: sites[1]!.id, email: 'nagoya@example.com', name: '名古屋次郎', role: 'user' },
    { siteId: sites[2]!.id, email: 'osaka@example.com', name: '大阪三郎', role: 'user' },
    { siteId: sites[3]!.id, email: 'fukuoka@example.com', name: '福岡四郎', role: 'user' },
  ];

  for (const user of users) {
    await prisma.user.upsert({
      where: { email: user.email },
      update: {},
      create: {
        companyId: company.id,
        siteId: user.siteId,
        email: user.email,
        passwordHash,
        name: user.name,
        role: user.role,
      },
    });
  }

  // サンプル稼働スケジュール（月〜金 9:00-18:00）
  const schedules = [
    { dayOfWeek: 0, startTime: null, endTime: null, isEnabled: false },
    { dayOfWeek: 1, startTime: '09:00:00', endTime: '18:00:00', isEnabled: true },
    { dayOfWeek: 2, startTime: '09:00:00', endTime: '18:00:00', isEnabled: true },
    { dayOfWeek: 3, startTime: '09:00:00', endTime: '18:00:00', isEnabled: true },
    { dayOfWeek: 4, startTime: '09:00:00', endTime: '18:00:00', isEnabled: true },
    { dayOfWeek: 5, startTime: '09:00:00', endTime: '18:00:00', isEnabled: true },
    { dayOfWeek: 6, startTime: null, endTime: null, isEnabled: false },
  ];

  for (const schedule of schedules) {
    await prisma.operatingSchedule.upsert({
      where: {
        companyId_dayOfWeek: {
          companyId: company.id,
          dayOfWeek: schedule.dayOfWeek,
        },
      },
      update: {},
      create: {
        companyId: company.id,
        dayOfWeek: schedule.dayOfWeek,
        startTime: schedule.startTime ? new Date(`1970-01-01T${schedule.startTime}Z`) : null,
        endTime: schedule.endTime ? new Date(`1970-01-01T${schedule.endTime}Z`) : null,
        isEnabled: schedule.isEnabled,
      },
    });
  }

  // サンプル稼働スケジュール例外（祝日）
  const exceptions = [
    { date: '2025-01-01', type: 'holiday', description: '元日' },
    { date: '2025-01-13', type: 'holiday', description: '成人の日' },
    { date: '2025-02-11', type: 'holiday', description: '建国記念の日' },
  ];

  for (const exception of exceptions) {
    await prisma.operatingScheduleException.upsert({
      where: {
        id: `exc-${exception.date}`,
      },
      update: {},
      create: {
        companyId: company.id,
        exceptionDate: new Date(exception.date),
        exceptionType: exception.type,
        description: exception.description,
      },
    });
  }

  console.warn('Seed data created successfully');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
