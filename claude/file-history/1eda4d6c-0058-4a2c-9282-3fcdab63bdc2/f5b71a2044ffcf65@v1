import { useRef, useEffect } from 'react';
import type { Participant } from '@/entities';
import './VideoThumbnail.scss';

/**
 * ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ã®åž‹
 */
interface VideoRenderer {
  renderVideo: (
    participantId: string,
    canvas: HTMLCanvasElement,
    width: number,
    height: number
  ) => Promise<void>;
  stopRenderVideo: (participantId: string, canvas: HTMLCanvasElement) => Promise<void>;
}

/**
 * VideoThumbnail Props
 */
interface VideoThumbnailProps {
  participant: Participant;
  siteName: string;
  isSelected?: boolean;
  onClick?: () => void;
  videoRenderer?: VideoRenderer;
}

/**
 * ã‚µãƒ ãƒã‚¤ãƒ«ãƒ“ãƒ‡ã‚ªã®ã‚µã‚¤ã‚ºå®šæ•°
 */
const THUMBNAIL_DIMENSIONS = {
  WIDTH: 640,
  HEIGHT: 360,
} as const;

/**
 * VideoThumbnail
 * ã‚µãƒ–æ‹ ç‚¹ã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
export const VideoThumbnail = ({
  participant,
  siteName,
  isSelected = false,
  onClick,
  videoRenderer,
}: VideoThumbnailProps) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  // ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas || !videoRenderer) return;

    const renderVideo = async () => {
      try {
        await videoRenderer.renderVideo(
          participant.id,
          canvas,
          THUMBNAIL_DIMENSIONS.WIDTH,
          THUMBNAIL_DIMENSIONS.HEIGHT
        );
      } catch (error) {
        console.error('Failed to render thumbnail video:', error);
      }
    };

    if (participant.isVideoOn) {
      renderVideo();
    }

    return () => {
      videoRenderer.stopRenderVideo(participant.id, canvas).catch(console.error);
    };
  }, [participant, videoRenderer]);

  return (
    <button
      type="button"
      className={`video-thumbnail ${isSelected ? 'video-thumbnail--selected' : ''}`}
      onClick={onClick}
      aria-label={`${siteName}ã®æ˜ åƒã‚’é¸æŠž`}
    >
      <canvas
        ref={canvasRef}
        className="video-thumbnail__canvas"
        width={THUMBNAIL_DIMENSIONS.WIDTH}
        height={THUMBNAIL_DIMENSIONS.HEIGHT}
      />

      {!participant.isVideoOn && (
        <div className="video-thumbnail__placeholder">
          <div className="video-thumbnail__avatar">
            {siteName[0] || '?'}
          </div>
        </div>
      )}

      <div className="video-thumbnail__label">
        <span className="video-thumbnail__name">{siteName}</span>
        <div className="video-thumbnail__status">
          {!participant.isAudioOn && (
            <span className="video-thumbnail__icon video-thumbnail__icon--muted" title="ãƒŸãƒ¥ãƒ¼ãƒˆä¸­">
              ðŸ”‡
            </span>
          )}
        </div>
      </div>
    </button>
  );
};
