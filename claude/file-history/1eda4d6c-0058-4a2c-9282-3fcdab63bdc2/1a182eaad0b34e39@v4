import { useRef, useEffect } from 'react';
import { registerSelfVideoContainer } from '../../context/VideoContext';
import './SelfVideoDisplay.scss';

/**
 * SelfVideoDisplay Props
 */
interface SelfVideoDisplayProps {
  isVideoOn: boolean;
  siteName?: string;
}

/**
 * SelfVideoDisplay
 * セルフビューコンポーネント（右下配置、画面幅15%）
 *
 * Note: ビデオのアタッチはVideoContext.toggleCameraで行われる。
 * このコンポーネントはコンテナを登録するだけ。
 */
export const SelfVideoDisplay = ({
  isVideoOn,
  siteName,
}: SelfVideoDisplayProps) => {
  const containerRef = useRef<HTMLDivElement>(null);

  // コンテナをVideoContextに登録（toggleCameraでアタッチするため）
  // カメラオン前にコンテナが存在している必要があるため、常にレンダリングする
  useEffect(() => {
    const container = containerRef.current;
    if (container) {
      console.log('[SelfVideoDisplay] Registering container');
      registerSelfVideoContainer(container);
    }

    return () => {
      console.log('[SelfVideoDisplay] Unregistering container');
      registerSelfVideoContainer(null);
    };
  }, []);

  // 常にコンテナをレンダリングし、表示/非表示はCSSで制御
  return (
    <div className={`self-video-display ${!isVideoOn ? 'self-video-display--hidden' : ''}`}>
      <div ref={containerRef} className="self-video-display__video-container" />
      {siteName && isVideoOn && (
        <div className="self-video-display__label">
          <span>{siteName}</span>
        </div>
      )}
    </div>
  );
};
