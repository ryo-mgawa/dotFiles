import { useRef, useEffect } from 'react';
import './SelfVideoDisplay.scss';

/**
 * セルフビデオレンダラーの型
 */
interface SelfVideoRenderer {
  attachSelfVideo: (container: HTMLElement) => Promise<void>;
  detachSelfVideo: (container: HTMLElement) => Promise<void>;
}

/**
 * SelfVideoDisplay Props
 */
interface SelfVideoDisplayProps {
  isVideoOn: boolean;
  siteName?: string;
  videoRenderer?: SelfVideoRenderer;
}

/**
 * SelfVideoDisplay
 * セルフビューコンポーネント（右下配置、画面幅15%）
 */
export const SelfVideoDisplay = ({
  isVideoOn,
  siteName,
  videoRenderer,
}: SelfVideoDisplayProps) => {
  const containerRef = useRef<HTMLDivElement>(null);

  // ビデオレンダリング
  useEffect(() => {
    console.log('[SelfVideoDisplay] useEffect triggered, isVideoOn:', isVideoOn);
    const container = containerRef.current;
    console.log('[SelfVideoDisplay] container:', !!container, 'videoRenderer:', !!videoRenderer);
    if (!container || !videoRenderer) return;

    const attachSelfVideo = async () => {
      try {
        console.log('[SelfVideoDisplay] Calling attachSelfVideo...');
        await videoRenderer.attachSelfVideo(container);
        console.log('[SelfVideoDisplay] attachSelfVideo completed');
      } catch (error) {
        console.error('Failed to attach self video:', error);
      }
    };

    if (isVideoOn) {
      attachSelfVideo();
    }

    return () => {
      console.log('[SelfVideoDisplay] Cleanup - detaching video');
      videoRenderer.detachSelfVideo(container).catch(console.error);
    };
  }, [isVideoOn, videoRenderer]);

  if (!isVideoOn) {
    return null;
  }

  return (
    <div className="self-video-display">
      <div ref={containerRef} className="self-video-display__video-container" />
      {siteName && (
        <div className="self-video-display__label">
          <span>{siteName}</span>
        </div>
      )}
    </div>
  );
};
