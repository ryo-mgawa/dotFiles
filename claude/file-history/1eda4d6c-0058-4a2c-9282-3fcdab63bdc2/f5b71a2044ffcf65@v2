import { useRef, useEffect } from 'react';
import type { Participant } from '@/entities';
import './VideoThumbnail.scss';

/**
 * ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ã®åž‹
 */
interface VideoRenderer {
  attachVideo: (
    participantId: string,
    container: HTMLElement
  ) => Promise<void>;
  detachVideo: (participantId: string, container: HTMLElement) => Promise<void>;
}

/**
 * VideoThumbnail Props
 */
interface VideoThumbnailProps {
  participant: Participant;
  siteName: string;
  isSelected?: boolean;
  onClick?: () => void;
  videoRenderer?: VideoRenderer;
}

/**
 * VideoThumbnail
 * ã‚µãƒ–æ‹ ç‚¹ã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
export const VideoThumbnail = ({
  participant,
  siteName,
  isSelected = false,
  onClick,
  videoRenderer,
}: VideoThumbnailProps) => {
  const containerRef = useRef<HTMLDivElement>(null);

  // ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  useEffect(() => {
    const container = containerRef.current;
    if (!container || !videoRenderer) return;

    const attachVideo = async () => {
      try {
        await videoRenderer.attachVideo(participant.id, container);
      } catch (error) {
        console.error('Failed to attach thumbnail video:', error);
      }
    };

    if (participant.isVideoOn) {
      attachVideo();
    }

    return () => {
      videoRenderer.detachVideo(participant.id, container).catch(console.error);
    };
  }, [participant, videoRenderer]);

  return (
    <button
      type="button"
      className={`video-thumbnail ${isSelected ? 'video-thumbnail--selected' : ''}`}
      onClick={onClick}
      aria-label={`${siteName}ã®æ˜ åƒã‚’é¸æŠž`}
    >
      <div ref={containerRef} className="video-thumbnail__video-container" />

      {!participant.isVideoOn && (
        <div className="video-thumbnail__placeholder">
          <div className="video-thumbnail__avatar">
            {siteName[0] || '?'}
          </div>
        </div>
      )}

      <div className="video-thumbnail__label">
        <span className="video-thumbnail__name">{siteName}</span>
        <div className="video-thumbnail__status">
          {!participant.isAudioOn && (
            <span className="video-thumbnail__icon video-thumbnail__icon--muted" title="ãƒŸãƒ¥ãƒ¼ãƒˆä¸­">
              ðŸ”‡
            </span>
          )}
        </div>
      </div>
    </button>
  );
};
