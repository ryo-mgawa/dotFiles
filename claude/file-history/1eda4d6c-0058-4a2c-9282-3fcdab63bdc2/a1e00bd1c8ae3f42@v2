# デプロイメントガイド

本ドキュメントでは、Inter-siteMonitorをSupabase（DB）+ Vercel（フロントエンド・バックエンド）にデプロイする手順を説明します。

## 目次

1. [前提条件](#前提条件)
2. [Supabase セットアップ](#supabase-セットアップ)
3. [バックエンド（server）のデプロイ](#バックエンドserverのデプロイ)
4. [フロントエンド（front）のデプロイ](#フロントエンドfrontのデプロイ)
5. [初期データ投入](#初期データ投入)
6. [動作確認](#動作確認)
7. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

- [Supabase](https://supabase.com/) アカウント
- [Vercel](https://vercel.com/) アカウント
- [Zoom Video SDK](https://marketplace.zoom.us/docs/sdk/video/web/) のSDK Key/Secret
- GitHubリポジトリへのアクセス権

---

## Supabase セットアップ

### 1. プロジェクト作成

1. [Supabase Dashboard](https://supabase.com/dashboard) にログイン
2. 「New project」をクリック
3. 以下を設定：
   - **Organization**: 任意の組織を選択
   - **Name**: `inter-site-monitor`（任意）
   - **Database Password**: 強力なパスワードを設定（後で使用）
   - **Region**: `Northeast Asia (Tokyo)` を推奨
4. 「Create new project」をクリック

### 2. 接続情報の取得

プロジェクト作成完了後：

1. 左メニュー「Project Settings」→「Database」
2. 「Connection string」セクションで「URI」タブを選択
3. 接続文字列をコピー（Transaction poolerを推奨）：
   ```
   postgresql://postgres.[project-ref]:[password]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres
   ```
4. `[password]` を実際のパスワードに置き換え

### 3. データベースマイグレーション

ローカル環境からマイグレーションを実行：

```bash
cd server

# 本番用DATABASE_URLを設定
export DATABASE_URL="postgresql://postgres.[project-ref]:[password]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true"

# Prisma Clientを生成
npm run db:generate

# マイグレーションを実行
npx prisma migrate deploy
```

**注意**: Supabaseでは `migrate dev` ではなく `migrate deploy` を使用します。

---

## バックエンド（server）のデプロイ

### 1. Vercel用設定ファイルの作成

`server/vercel.json` を作成：

```json
{
  "version": 2,
  "builds": [
    {
      "src": "src/app/server.ts",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "src/app/server.ts"
    }
  ]
}
```

### 2. Vercelプロジェクト作成

1. [Vercel Dashboard](https://vercel.com/dashboard) にログイン
2. 「Add New...」→「Project」
3. GitHubリポジトリをインポート
4. プロジェクト設定：
   - **Project Name**: `inter-site-monitor-api`（任意）
   - **Framework Preset**: `Other`
   - **Root Directory**: `server`（「Edit」をクリックして変更）

### 3. 環境変数の設定

Vercelの「Settings」→「Environment Variables」で以下を設定：

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `DATABASE_URL` | `postgresql://...` | Supabaseの接続文字列（?pgbouncer=true付き） |
| `JWT_SECRET` | `<ランダムな文字列>` | JWT署名用シークレット（32文字以上推奨） |
| `JWT_EXPIRES_IN` | `24h` | JWTの有効期限 |
| `ZOOM_SDK_KEY` | `<Zoom SDK Key>` | Zoom Video SDKのKey |
| `ZOOM_SDK_SECRET` | `<Zoom SDK Secret>` | Zoom Video SDKのSecret |
| `ZOOM_JWT_EXPIRES_IN` | `7200` | Zoom JWTの有効期限（秒） |
| `NODE_ENV` | `production` | 実行環境 |
| `CORS_ORIGIN` | `https://your-frontend.vercel.app` | フロントエンドのURL（後で設定） |
| `WARNING_THRESHOLD_MINUTES` | `5` | 稼働時間警告の閾値（分） |

### 4. ビルド設定

「Settings」→「General」で確認：

- **Build Command**: `npm run build && npx prisma generate`
- **Output Directory**: `dist`
- **Install Command**: `npm install`

### 5. デプロイ

「Deployments」タブで「Redeploy」または、GitHubにプッシュすると自動デプロイ。

デプロイ完了後、バックエンドURLをメモ：
```
https://inter-site-monitor-api.vercel.app
```

---

## フロントエンド（front）のデプロイ

### 1. Vercelプロジェクト作成

1. Vercel Dashboardで「Add New...」→「Project」
2. 同じGitHubリポジトリを選択
3. プロジェクト設定：
   - **Project Name**: `inter-site-monitor`（任意）
   - **Framework Preset**: `Vite`（自動検出）
   - **Root Directory**: `front`

### 2. 環境変数の設定

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `VITE_API_BASE_URL` | `https://inter-site-monitor-api.vercel.app/api` | バックエンドAPIのURL |
| `VITE_ZOOM_WEB_ENDPOINT` | `zoom.us` | Zoom Webエンドポイント |

### 3. デプロイ

GitHubプッシュで自動デプロイ。

デプロイ完了後、フロントエンドURLをメモ：
```
https://inter-site-monitor.vercel.app
```

### 4. CORS設定の更新

バックエンドプロジェクトの環境変数 `CORS_ORIGIN` をフロントエンドURLに更新：

```
CORS_ORIGIN=https://inter-site-monitor.vercel.app
```

バックエンドを再デプロイ。

---

## 初期データ投入

### 方法1: Supabase SQL Editor

Supabase Dashboard →「SQL Editor」で直接SQLを実行：

```sql
-- 会社を作成
INSERT INTO companies (id, name, timezone)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 'テスト株式会社', 'Asia/Tokyo');

-- 拠点を作成
INSERT INTO sites (id, company_id, name, display_order) VALUES
('550e8400-e29b-41d4-a716-446655440001', '550e8400-e29b-41d4-a716-446655440000', '本社', 1),
('550e8400-e29b-41d4-a716-446655440002', '550e8400-e29b-41d4-a716-446655440000', '大阪支社', 2);

-- 稼働スケジュール（月〜金 9:00-18:00）
INSERT INTO operating_schedules (id, company_id, day_of_week, start_time, end_time, is_enabled) VALUES
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 0, NULL, NULL, false),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 1, '09:00:00', '18:00:00', true),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 2, '09:00:00', '18:00:00', true),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 3, '09:00:00', '18:00:00', true),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 4, '09:00:00', '18:00:00', true),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 5, '09:00:00', '18:00:00', true),
(gen_random_uuid(), '550e8400-e29b-41d4-a716-446655440000', 6, NULL, NULL, false);
```

### 方法2: シードスクリプト

ローカルから本番DBにシードを実行：

```bash
cd server
export DATABASE_URL="postgresql://..."  # Supabase URL
npm run db:seed
```

---

## 動作確認

### 1. ヘルスチェック

```bash
curl https://inter-site-monitor-api.vercel.app/api/health
```

期待レスポンス:
```json
{"status":"ok"}
```

### 2. フロントエンドアクセス

ブラウザで `https://inter-site-monitor.vercel.app` にアクセス。

### 3. 認証テスト

トークンログインのテスト（拠点のaccessTokenを使用）：

```bash
curl -X POST https://inter-site-monitor-api.vercel.app/api/auth/token-login \
  -H "Content-Type: application/json" \
  -d '{"accessToken": "<site-access-token>"}'
```

---

## トラブルシューティング

### データベース接続エラー

**症状**: `Connection refused` や `timeout`

**解決策**:
1. Supabaseの接続文字列が正しいか確認
2. `?pgbouncer=true` パラメータが付いているか確認
3. Supabase Dashboardでデータベースが起動しているか確認

### CORS エラー

**症状**: `Access-Control-Allow-Origin` エラー

**解決策**:
1. バックエンドの `CORS_ORIGIN` がフロントエンドURLと一致しているか確認
2. プロトコル（https）が正しいか確認
3. 末尾のスラッシュを削除

### Prisma エラー

**症状**: `Prisma Client is not generated`

**解決策**:
Vercelのビルドコマンドに `npx prisma generate` を追加：
```
npm run build && npx prisma generate
```

### Zoom SDK エラー

**症状**: JWT生成エラー

**解決策**:
1. `ZOOM_SDK_KEY` と `ZOOM_SDK_SECRET` が正しいか確認
2. Zoom MarketplaceでSDKがアクティブか確認

---

## 本番運用チェックリスト

- [ ] 強力なJWT_SECRETを使用
- [ ] DATABASE_URLに `?pgbouncer=true` を付与
- [ ] CORS_ORIGINを正確に設定
- [ ] Supabaseのデータベースパスワードを安全に管理
- [ ] Zoom SDK認証情報を安全に管理
- [ ] Vercelのプレビューデプロイを必要に応じて無効化
- [ ] カスタムドメインの設定（必要に応じて）

---

## アーキテクチャ図

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│    Browser      │────▶│  Vercel (Front) │     │   Zoom Cloud    │
│                 │     │  React + Vite   │────▶│   Video SDK     │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │
                               │ HTTPS
                               ▼
                        ┌─────────────────┐
                        │                 │
                        │ Vercel (Server) │
                        │ Express + Node  │
                        │                 │
                        └─────────────────┘
                               │
                               │ PostgreSQL
                               ▼
                        ┌─────────────────┐
                        │                 │
                        │    Supabase     │
                        │   PostgreSQL    │
                        │                 │
                        └─────────────────┘
```
