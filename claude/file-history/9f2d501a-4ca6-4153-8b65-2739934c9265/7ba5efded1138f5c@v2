import { ShipmentDAO } from '../shipmentDAO';
import { ShipmentInsert } from '../../db/model';
import { ProviderIdentity, RDBModule } from '../..';
import { INestApplication } from '@nestjs/common';
import { Test } from '@nestjs/testing';
import { Knex } from 'knex';
import { resolve } from 'path';

jest.mock('@app/requestContext/requestContext', () => {
  return {
    RequestContext: class DummyRequestContext {
      public static get() {
        return {
          user: {
            organizationId: 'test-org-1',
            userId: 'test-user-1',
            role: 'manager',
          },
        };
      }
      public static start(_, next) {
        next();
      }
    },
  };
});

describe('ShipmentDAO', () => {
  let shipmentDAO: ShipmentDAO;
  let app: INestApplication;
  let rdb: Knex;

  beforeEach(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [RDBModule],
      providers: [ShipmentDAO],
    }).compile();

    rdb = await moduleRef.get<Knex>(ProviderIdentity);
    app = moduleRef.createNestApplication();

    await Promise.all([
      app.init(),
      rdb.transaction(async (trx) => {
        await trx.raw('SET CONSTRAINTS ALL DEFERRED');
        await trx.seed.run({
          directory: resolve(
            __dirname,
            '../../../../../../apps/shipment/src/data/repository/__tests__/fixtures/seeds'
          ),
          specific: 'shipment.ts',
        });
        await trx.raw('SET CONSTRAINTS ALL IMMEDIATE');
      }),
    ]);

    shipmentDAO = await moduleRef.get<ShipmentDAO>(ShipmentDAO);
  });

  describe('save', () => {
    it('空配列の場合は何も実行しない', async () => {
      const shipments: ShipmentInsert[] = [];

      await shipmentDAO.save(shipments);

      const results = await rdb.from('shipment');
      expect(results).toHaveLength(0);
    });

    it('単一のshipmentを保存できる', async () => {
      const shipments: ShipmentInsert[] = [
        {
          id: '00000000-0000-0000-0000-000000000001',
          organization_id: 'test-org-1',
          slip_id: 'slip-001',
          consignor: JSON.stringify({ id: 'consignor-1', name: '発荷主A' }),
          consignee: JSON.stringify({ id: 'consignee-1', name: '着荷主A' }),
          origin_spot_id: 'spot-origin-1',
          destination_spot_id: 'spot-dest-1',
          meta: JSON.stringify({ note: 'テスト' }),
        },
      ];

      await shipmentDAO.save(shipments);

      const results = await rdb.from('shipment').where('id', shipments[0].id);
      expect(results).toHaveLength(1);
      expect(results[0].slip_id).toBe('slip-001');
    });

    it('複数のshipmentを一度に保存できる', async () => {
      const shipments: ShipmentInsert[] = [
        {
          id: '00000000-0000-0000-0000-000000000001',
          organization_id: 'test-org-1',
          slip_id: 'slip-001',
          consignor: JSON.stringify({ id: 'consignor-1', name: '発荷主A' }),
          consignee: JSON.stringify({ id: 'consignee-1', name: '着荷主A' }),
          origin_spot_id: 'spot-origin-1',
          destination_spot_id: 'spot-dest-1',
          meta: JSON.stringify({ note: 'テスト' }),
        },
        {
          id: '00000000-0000-0000-0000-000000000002',
          organization_id: 'test-org-1',
          slip_id: 'slip-002',
          consignor: JSON.stringify({ id: 'consignor-2', name: '発荷主B' }),
          consignee: JSON.stringify({ id: 'consignee-2', name: '着荷主B' }),
          origin_spot_id: 'spot-origin-2',
          destination_spot_id: 'spot-dest-2',
          meta: JSON.stringify(null),
        },
      ];

      await shipmentDAO.save(shipments);

      const results = await rdb
        .from('shipment')
        .whereIn('id', shipments.map((s) => s.id))
        .orderBy('slip_id', 'asc');

      expect(results).toHaveLength(2);
      expect(results[0].id).toBe('00000000-0000-0000-0000-000000000001');
      expect(results[1].id).toBe('00000000-0000-0000-0000-000000000002');
    });

    it('コンフリクト時は無視される', async () => {
      const shipment: ShipmentInsert = {
        id: '00000000-0000-0000-0000-000000000001',
        organization_id: 'test-org-1',
        slip_id: 'slip-001',
        consignor: JSON.stringify({ id: 'consignor-1', name: '発荷主A' }),
        consignee: JSON.stringify({ id: 'consignee-1', name: '着荷主A' }),
        origin_spot_id: 'spot-origin-1',
        destination_spot_id: 'spot-dest-1',
        meta: JSON.stringify({ note: 'テスト' }),
      };

      // 最初の保存
      await shipmentDAO.save([shipment]);

      // 同じIDで再度保存（無視される）
      const updatedShipment = {
        ...shipment,
        slip_id: 'slip-updated',
      };
      await shipmentDAO.save([updatedShipment]);

      // 最初のデータが保持されている
      const result = await rdb
        .from('shipment')
        .where('id', shipment.id)
        .first();

      expect(result.slip_id).toBe('slip-001');
    });
  });

  afterEach(() => {
    rdb.destroy();
  });
});
