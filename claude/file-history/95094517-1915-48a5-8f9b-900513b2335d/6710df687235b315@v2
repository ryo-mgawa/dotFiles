import { INestApplication } from '@nestjs/common';
import { Test, TestingModule } from '@nestjs/testing';
import { ShipmentRepository } from '../../../data/repository/shipmentRepository';
import { AddShipmentEventsPresenterInterface } from '../../../interface/presenter/addShipmentEventsPresenterInterface';
import { AddShipmentEventsUseCase } from '../addShipmentEventsUseCase';
import { Input } from '../../types/addShipmentEventsTypes';
import { SHIPMENT_EVENT_TYPE } from '@app/rdb/db/models/shipmentEvent/type';
import { SHIPMENT_STATUS } from '@app/rdb/db/models/shipmentStatus/status';

jest.mock('@app/requestContext/requestContext', () => {
  return {
    RequestContext: class DummyRequestContext {
      public static get() {
        return {
          user: {
            organizationId: 'organizationId',
            userId: 'userId',
            role: 'manager',
          },
        };
      }
      public static start(_, next) {
        next();
      }
    },
  };
});

describe('AddShipmentEventsUseCase', () => {
  let addShipmentEventsUseCase: AddShipmentEventsUseCase;
  let moduleRef: TestingModule;
  let app: INestApplication;
  let mockRepository: { saveShipmentEvents: jest.Mock };
  let mockPresenter: { output: jest.Mock };

  describe('execute', () => {
    it('単一のイベントが正しく保存される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            geocode: { x: 139.7671, y: 35.6812 },
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            geocode: { x: 139.7671, y: 35.6812 },
            executedAt,
          },
        ],
        [
          {
            shipmentId: 'shipment-1',
            status: SHIPMENT_STATUS.IN_STORAGE,
            executedAt,
          },
        ],
        'user-1',
      );
      expect(mockPresenter.output).toHaveBeenCalled();
    });

    it('複数のイベントが一括保存される', async () => {
      await createTestingModule();

      const executedAt1 = new Date('2025-11-10T10:00:00Z');
      const executedAt2 = new Date('2025-11-10T11:00:00Z');

      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt: executedAt1,
          },
          {
            shipmentId: 'shipment-2',
            type: SHIPMENT_EVENT_TYPE.DELIVER,
            originalSpotId: 'spot-2',
            executedAt: executedAt2,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.arrayContaining([
          expect.objectContaining({
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
          }),
          expect.objectContaining({
            shipmentId: 'shipment-2',
            type: SHIPMENT_EVENT_TYPE.DELIVER,
          }),
        ]),
        expect.arrayContaining([
          expect.objectContaining({
            shipmentId: 'shipment-1',
            status: SHIPMENT_STATUS.IN_STORAGE,
          }),
          expect.objectContaining({
            shipmentId: 'shipment-2',
            status: SHIPMENT_STATUS.COMPLETED,
          }),
        ]),
        'user-1',
      );
      expect(mockPresenter.output).toHaveBeenCalled();
    });

    it('Storeイベント → InStorage状態に変換される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.arrayContaining([
          expect.objectContaining({
            status: SHIPMENT_STATUS.IN_STORAGE,
          }),
        ]),
        'user-1',
      );
    });

    it('Transferイベント → InTransit状態に変換される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.TRANSFER,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.arrayContaining([
          expect.objectContaining({
            status: SHIPMENT_STATUS.IN_TRANSIT,
          }),
        ]),
        'user-1',
      );
    });

    it('Deliverイベント → Completed状態に変換される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.DELIVER,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.arrayContaining([
          expect.objectContaining({
            status: SHIPMENT_STATUS.COMPLETED,
          }),
        ]),
        'user-1',
      );
    });

    it('Completeイベント → Completed状態に変換される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.COMPLETE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.arrayContaining([
          expect.objectContaining({
            status: SHIPMENT_STATUS.COMPLETED,
          }),
        ]),
        'user-1',
      );
    });

    it('Cancelイベント → Canceled状態に変換される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.CANCEL,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.arrayContaining([
          expect.objectContaining({
            status: SHIPMENT_STATUS.CANCELED,
          }),
        ]),
        'user-1',
      );
    });

    it('geocodeがundefinedの場合も正しく処理される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.arrayContaining([
          expect.objectContaining({
            geocode: undefined,
          }),
        ]),
        expect.any(Array),
        'user-1',
      );
      expect(mockPresenter.output).toHaveBeenCalled();
    });

    it('executedAtが正しく伝搬される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'user-1');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.arrayContaining([
          expect.objectContaining({
            executedAt,
          }),
        ]),
        expect.arrayContaining([
          expect.objectContaining({
            executedAt,
          }),
        ]),
        'user-1',
      );
    });

    it('userIdが正しく伝搬される', async () => {
      await createTestingModule();

      const executedAt = new Date('2025-11-10T10:00:00Z');
      const input: Input = {
        events: [
          {
            shipmentId: 'shipment-1',
            type: SHIPMENT_EVENT_TYPE.STORE,
            originalSpotId: 'spot-1',
            executedAt,
          },
        ],
      };

      await addShipmentEventsUseCase.execute(input, 'test-user-123');

      expect(mockRepository.saveShipmentEvents).toHaveBeenCalledWith(
        expect.any(Array),
        expect.any(Array),
        'test-user-123',
      );
    });
  });

  const createTestingModule = async () => {
    mockRepository = {
      saveShipmentEvents: jest.fn().mockResolvedValue(undefined),
    };

    mockPresenter = {
      output: jest.fn(),
    };

    moduleRef = await Test.createTestingModule({
      imports: [],
      providers: [
        AddShipmentEventsUseCase,
        {
          provide: ShipmentRepository,
          useValue: mockRepository,
        },
        {
          provide: 'AddShipmentEventsPresenter',
          useValue: mockPresenter,
        },
      ],
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();

    addShipmentEventsUseCase = moduleRef.get<AddShipmentEventsUseCase>(
      AddShipmentEventsUseCase,
    );
  };

  afterEach(async () => {
    if (app) {
      await app.close();
    }
    if (moduleRef) {
      await moduleRef.close();
    }
  });
});
