import { Inject, Injectable } from '@nestjs/common';
import { ShipmentRepository } from '../../data/repository/shipmentRepository';
import { AddShipmentEventsPresenterInterface } from '../../interface/presenter/addShipmentEventsPresenterInterface';
import { Input } from '../types/addShipmentEventsTypes';
import { SHIPMENT_EVENT_TYPE } from '@app/rdb/db/models/shipmentEvent/type';
import { SHIPMENT_STATUS } from '@app/rdb/db/models/shipmentStatus/status';
import { ShipmentEventInput, ShipmentStatusInput } from '../../data/repository/types/shipmentRepositoryTypes';

@Injectable()
export class AddShipmentEventsUseCase {
  constructor(
    @Inject('AddShipmentEventsPresenter')
    private readonly presenter: AddShipmentEventsPresenterInterface,
    private readonly shipmentRepository: ShipmentRepository,
  ) { }

  public async execute(input: Input, userId: string): Promise<void> {
    // イベントをRepository形式に変換
    const events: ShipmentEventInput[] = input.events.map((event) => ({
      shipmentId: event.shipmentId,
      type: event.type,
      originalSpotId: event.originalSpotId,
      geocode: event.geocode,
      executedAt: event.executedAt,
    }));

    // イベントタイプから状態を決定
    const statuses: ShipmentStatusInput[] = input.events.map((event) => ({
      shipmentId: event.shipmentId,
      status: this.mapEventTypeToStatus(event.type),
      executedAt: event.executedAt,
    }));

    // Repositoryを呼び出してイベントと状態を保存
    await this.shipmentRepository.saveShipmentEvents(events, statuses, userId);

    // Presenterを呼び出してレスポンスを返却
    this.presenter.output();
  }

  private mapEventTypeToStatus(type: string): string {
    switch (type) {
      case SHIPMENT_EVENT_TYPE.STORE:
        return SHIPMENT_STATUS.IN_STORAGE;
      case SHIPMENT_EVENT_TYPE.TRANSFER:
        return SHIPMENT_STATUS.IN_TRANSIT;
      case SHIPMENT_EVENT_TYPE.DELIVER:
      case SHIPMENT_EVENT_TYPE.COMPLETE:
        return SHIPMENT_STATUS.COMPLETED;
      case SHIPMENT_EVENT_TYPE.CANCEL:
        return SHIPMENT_STATUS.CANCELED;
      default:
        throw new Error(`Unknown event type: ${type}`);
    }
  }
}
