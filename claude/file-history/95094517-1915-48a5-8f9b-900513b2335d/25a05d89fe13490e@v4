import { Knex } from 'knex';
import { v7 as uuidv7 } from 'uuid';

export async function seed(knex: Knex): Promise<void> {
  await Promise.all([
    knex('shipment_event').del(),
    knex('shipment_status').del(),
    knex('shipment').del(),
    knex('organization').del(),
  ]);

  await importOrganization(knex);
  await importShipments(knex);
}

const importOrganization = (knex: Knex) => {
  return knex('organization').insert([
    {
      id: 'test-org-1',
      disable_goto: true,
      disable_map: true,
      enable_always_finished: true,
      has_paid_subscription: true,
      enable_auto_complete: false,
      enable_evidence: false,
      enable_spot_master: false,
      enable_spot_master_auto_reg: false,
      enable_here_navigation: false,
      navigation_types: ['google', 'here'],
      enable_duplicate_ids_for_depot_and_spot: false,
      enable_analytics: false,
    },
    {
      id: 'test-org-2',
      disable_goto: true,
      disable_map: true,
      enable_always_finished: true,
      has_paid_subscription: true,
      enable_auto_complete: false,
      enable_evidence: false,
      enable_spot_master: false,
      enable_spot_master_auto_reg: false,
      enable_here_navigation: false,
      navigation_types: ['google', 'here'],
      enable_duplicate_ids_for_depot_and_spot: false,
      enable_analytics: false,
    },
  ]);
};

const importShipments = async (knex: Knex) => {
  // test-org-1に5件のshipmentを作成（ページネーションテスト用）
  const org1Shipments = Array.from({ length: 5 }, (_, i) => ({
    id: uuidv7(),
    organization_id: 'test-org-1',
    slip_id: `SLIP-ORG1-00${i + 1}`,
    consignor: JSON.stringify({ id: `consignor-${i + 1}`, name: `発荷主${i + 1}` }),
    consignee: JSON.stringify({ id: `consignee-${i + 1}`, name: `着荷主${i + 1}` }),
    origin_spot_id: `spot-origin-${i + 1}`,
    destination_spot_id: `spot-dest-${i + 1}`,
    meta: i % 2 === 0 ? JSON.stringify({ weight: 10.5 + i, volume: 2.0 + i }) : null,
    created_at: new Date(Date.now() - (5 - i) * 1000 * 60), // 古い順に作成
  }));

  // test-org-2に3件のshipmentを作成（組織分離テスト用）
  const org2Shipments = Array.from({ length: 3 }, (_, i) => ({
    id: uuidv7(),
    organization_id: 'test-org-2',
    slip_id: `SLIP-ORG2-00${i + 1}`,
    consignor: JSON.stringify({ id: `consignor-org2-${i + 1}`, name: `発荷主ORG2-${i + 1}` }),
    consignee: JSON.stringify({ id: `consignee-org2-${i + 1}`, name: `着荷主ORG2-${i + 1}` }),
    origin_spot_id: `spot-origin-org2-${i + 1}`,
    destination_spot_id: `spot-dest-org2-${i + 1}`,
    meta: null,
    created_at: new Date(Date.now() - i * 1000 * 60),
  }));

  await knex('shipment').insert([...org1Shipments, ...org2Shipments]);

  // shipment_status の初期データ（Requested状態）
  const shipmentStatuses = [...org1Shipments, ...org2Shipments].map((s) => ({
    shipment_id: s.id,
    status: 'Requested',
    executed_at: s.created_at,
  }));

  await knex('shipment_status').insert(shipmentStatuses);
};
