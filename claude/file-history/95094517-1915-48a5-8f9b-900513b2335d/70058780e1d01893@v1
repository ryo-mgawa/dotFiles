import { Type } from 'class-transformer';
import {
  ArrayNotEmpty,
  IsDefined,
  IsObject,
  IsOptional,
  IsString,
  MaxLength,
  Validate,
  ValidateNested,
  ValidatorConstraint,
  ValidatorConstraintInterface,
} from 'class-validator';

const MAX_SLIP_ID_LENGTH = 256;
const MAX_NAME_LENGTH = 256;
const MAX_ID_LENGTH = 256;
const MAX_META_SIZE_BYTES = 1024; // 1kb

@ValidatorConstraint({ name: 'metaSize', async: false })
export class MetaSizeValidator implements ValidatorConstraintInterface {
  public validate(meta: any): boolean {
    if (!meta) return true;
    const size = JSON.stringify(meta).length;
    return size < MAX_META_SIZE_BYTES;
  }

  public defaultMessage(): string {
    return 'metaのデータ量は1kb未満にする必要があります';
  }
}

export class Consignor {
  @IsDefined()
  @IsString()
  @MaxLength(MAX_ID_LENGTH)
  public id: string;

  @IsDefined()
  @IsString()
  @MaxLength(MAX_NAME_LENGTH)
  public name: string;
}

export class Consignee {
  @IsDefined()
  @IsString()
  @MaxLength(MAX_ID_LENGTH)
  public id: string;

  @IsDefined()
  @IsString()
  @MaxLength(MAX_NAME_LENGTH)
  public name: string;
}

export class OriginSpot {
  @IsDefined()
  @IsString()
  @MaxLength(MAX_ID_LENGTH)
  public id: string;
}

export class DestinationSpot {
  @IsDefined()
  @IsString()
  @MaxLength(MAX_ID_LENGTH)
  public id: string;
}

export class AddShipmentItem {
  @IsDefined()
  @IsString()
  @MaxLength(MAX_SLIP_ID_LENGTH)
  public slipId: string;

  @IsDefined()
  @ValidateNested()
  @Type(() => Consignor)
  public consignor: Consignor;

  @IsDefined()
  @ValidateNested()
  @Type(() => Consignee)
  public consignee: Consignee;

  @IsDefined()
  @ValidateNested()
  @Type(() => OriginSpot)
  public originSpot: OriginSpot;

  @IsDefined()
  @ValidateNested()
  @Type(() => DestinationSpot)
  public destinationSpot: DestinationSpot;

  @IsOptional()
  @IsObject()
  @Validate(MetaSizeValidator)
  public meta?: object;
}

export class AddShipmentsInput {
  @IsDefined()
  @ArrayNotEmpty()
  @ValidateNested({ each: true })
  @Type(() => AddShipmentItem)
  public shipments: AddShipmentItem[];
}
