import { Injectable } from '@nestjs/common';
import { v7 as uuidv7 } from 'uuid';
import { ShipmentDAO } from '../dao/shipmentDAO';
import { Shipment } from '../model/shipment';
import {
  ShipmentRepositoryInput,
  ShipmentEventInput,
  ShipmentStatusInput,
} from './types/shipmentRepositoryTypes';

@Injectable()
export class ShipmentRepository {
  constructor(private readonly shipmentDAO: ShipmentDAO) {}

  public async saveShipments(
    organizationId: string,
    shipments: ShipmentRepositoryInput[]
  ): Promise<void> {
    const shipmentsWithId = shipments.map((s) => ({
      id: uuidv7(),
      organizationId,
      ...s,
    }));

    await this.shipmentDAO.saveShipments(shipmentsWithId);
  }

  public async getShipments(
    organizationId: string,
    limit: number,
    offset: number
  ): Promise<Shipment[]> {
    return this.shipmentDAO.getShipments(organizationId, limit, offset);
  }

  public async saveShipmentEvents(
    events: ShipmentEventInput[],
    statuses: ShipmentStatusInput[],
    updateBy: string
  ): Promise<void> {
    const eventsWithId = events.map((e) => ({
      id: uuidv7(),
      ...e,
      geocode: e.geocode ?? null,
      updateBy,
    }));

    await this.shipmentDAO.saveShipmentEvents(eventsWithId, statuses);
  }
}
